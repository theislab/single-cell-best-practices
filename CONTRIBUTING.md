# Contributing

We highly welcome community contributions and encourage contributions.
However, the complex single-cell environments and the modern building of a book with integrated code entails a complex environment setup.

## Book architecture

The book is based on the awesome [jupyter-book](https://jupyterbook.org/intro.html) which we use to build the book.
Architecture wise it is heavily inspired by the [scikit-learn-mooc](https://github.com/INRIA/scikit-learn-mooc) with the aid of [jupytext](https://github.com/mwouts/jupytext).
We highly recommend working through the short [jupyter-book tutorial](https://jupyterbook.org/start/your-first-book.html) which introduces the key concepts required to build a jupyter-book.
Since our big book with many executable notebooks would quickly result in very messy histories and diffs we make use of [jupytext](https://github.com/mwouts/jupytext). Besides the [jupytext documentation](https://jupytext.readthedocs.io/en/latest/?badge=latest), [this blog](https://medium.com/capital-fund-management/automated-reports-with-jupyter-notebooks-using-jupytext-and-papermill-619e60c37330) on the benefits of such an approach is recommended reading.

Here is an overview of all relevant (some are omitted for clarity) files which will be explained below:

```
.
├── build_tools  # UTILITY SCRIPTS TO TRANSFORM SCRIPTS INTO NOTEBOOKS
│   ├── convert-python-script-to-notebook.py
│   ├── generate-exercise-from-solution.py
│   ├── generate-quizzes.py
│   └── sanity-check.py
├── CONTRIBUTING.md  # WHAT YOU ARE CURRENTLY READING
├── Dockerfile.yml  # DOCKER CONTAINER FOR THE BOOK ENVIRONMENT
├── environment.yml  # CONDA/MAMBA ENVIRONMENT USED IN THE DOCKER CONTAINER
├── figures  # BOOK FIGURES
│   ├── some_figures.svg
├── jupyter-book  # ACTUAL JUPYTER-BOOK FOLDER
│   ├── _build  # OUTPUT BUILD FOLDER OF THE BOOK
│   │   ├── html  # FOLDER CONTAINING THE READY STATIC HTML FILES. THE CONTENTS OF THIS FOLDER GET UPLOADED TO BE VIEWED.
│   │   │   ├── figures
│   │   │   │   ├── copied_figures.svg
│   │   │   ├── genindex.html
│   │   │   ├── _images
│   │   │   │   ├── notebook_images.png
│   │   │   ├── index.html
│   │   │   ├── chapter
│   │   │   │   ├── content.html
│   │   │   ├── notebook_scripts
│   │   │   │   ├── notebook.html
│   │   │   ├── search.html
│   │   │   ├── searchindex.js
│   │   │   ├── _sources
│   │   │   │   ├── index.md
│   │   │   │   ├── chapter
│   │   │   │   │   ├── content.md
│   │   │   │   ├── notebook_scripts
│   │   │   │   │   ├── notebook_script.py
│   │   │   │   └── toc.md
│   │   │   ├── _static
│   │   │   │   ├── many_css_files.css
│   │   │   │   ├── many_js_files.js
│   │   └── jupyter_execute  # CACHED EXECUTED JUPYTER NOTEBOOKS. ONLY GET REBUILD WHEN THE CONTENT CHANGED.
│   │       └── notebook_scripts
│   │           ├── notebook_image.png
│   │           ├── notebook.ipynb
│   │           ├── notebook.py
│   │           ├── notebook.txt
│   ├── _ci_config.yml  # JUPYTER-BOOK CONTINUOUS INTEGRATION CONFIGURATION
│   ├── _config.yml  # JUPYTER-BOOK CONFIGURATION
│   ├── figures -> ../figures  # SYMBOLIC LINK
│   ├── index.md
│   ├── chapter
│   │   ├── content.md
│   ├── notebook_scripts -> ../notebook_scripts/  # SYMBOLIC LINK
│   ├── _static
│   │   ├── favicon.ico
│   │   ├── custom.css
│   │   └── custom.js
│   ├── theislab_logo.png
│   ├── toc.md
│   └── _toc.yml  # JUPYTER-BOOK TABLE OF CONTENTS
├── Makefile  # MAKEFILE TO BUILD THE BOOK
├── notebooks  # VIEW ONLY NOTEBOOKS GENERATED WITH JUPYTEXT
│   ├── notebook_1.ipynb
│   ├── notebook_2.ipynb
├── notebook_scripts  # ALL SCRIPTS WHICH GET TRANSFORMED INTO NOTEBOOKS WHEN BUILDING THE BOOK
│   ├── script_1.py
│   ├── script_2.py
├── publish_book_gh_pages.sh  # UTILITY SCRIPT TO UPLOAD THE BOOK TO GH-PAGES
├── README.md
└── requirements.txt  # REQUIREMENTS.TXT FOR BINDER AND THE CONTINUOUS INTEGRATION SETUP
```

The main difference from a classical jupyter-book setup is that we don't work on and integrate Jupyter Notebooks directly, but we convert scripts into Jupyter Notebooks. These scripts can be found in the [notebook_scripts folder](single-cell-best-practices/tree/master/notebook_scripts). When contributing only these scripts should be edited. Do not edit the notebooks in the [notebooks folder](single-cell-best-practices/tree/master/notebooks) since they are autogenerated!

The following sections will introduce how to setup the environment, how to build the notebooks and how to build the complete book.

## Environment setup

### Container

Due to the inherent complexity of the required setup we only support the setup with Docker based containers.
We provide a Docker container with  TODO LH DO THIS
LH provide instructions

### Downloading the data

As mentioned above the data for the case study comes from GSE92332. To run the case study as shown, you must download this data and place it in the correct folder. Unpacking the data requires `tar` and `gunzip`, which should already be available on most systems. If you are cloning the github repository and have the case study script in a `latest_notebook/` folder, then from the location where you store the case study ipynb file, this can be done via the following commands:

```
cd ../  #To get to the main github repo folder
mkdir -p data/Haber-et-al_mouse-intestinal-epithelium/
cd data/Haber-et-al_mouse-intestinal-epithelium/
wget ftp://ftp.ncbi.nlm.nih.gov/geo/series/GSE92nnn/GSE92332/suppl/GSE92332_RAW.tar
mkdir GSE92332_RAW
tar -C GSE92332_RAW -xvf GSE92332_RAW.tar
gunzip GSE92332_RAW/*_Regional_*
```

The annotated dataset with which we briefly compare the results at the end of the notebook, is available from the same GEO accession ID (GSE92332). It can be obtained using the following command:

```
cd data/Haber-et-al_mouse-intestinal-epithelium/
wget ftp://ftp.ncbi.nlm.nih.gov/geo/series/GSE92nnn/GSE92332/suppl/GSE92332_Regional_UMIcounts.txt.gz
gunzip GSE92332_Regional_UMIcounts.txt.gz
```

## Executing the notebooks

To update all the notebooks:

```bash
$ make
```

If you want to generate a single notebook, you can do something similar to this:
```bash
$ make notebooks/notebook.ipynb
```

## Building the book

From inside the Docker container run:

```bash
$ make jupyter-book
```

Note that all cached notebooks will not be rebuild. To force the rebuilding of all notebooks run:

```bash
$ make jupyter-book-full-clean
```

which will remove the cache files.

To view the built book with e.g. firefox:

```bash
$ firefox jupyter-book/_build/html/index.html
```

## Contributing new best-practices

Contributing or correcting new best-practices is welcome, but subject to a high standard. Our philosophy is that we base our recommendations only on external (= not by the tools' authors) and independent benchmarks. Therefore, if you propose new best-practices we strongly advise you to open an issue first and discuss them with us. We will certainly have questions, but are super keen on getting to know the latest best-practices.

## Contributing new tutorials, quizzes and solutions

### General information

We want this book to become a prime resource for introducing people to the field of single-cell and especially best-practice data analysis. In the past we have been involved in many teaching efforts and we noticed that it is imperative to make people reflect on their learning for the most effective outcome. Therefore, we try to add many small quizzes with solutions for self-learners to encourage such a learning style. These quizzes and solutions can always be extended and we would be happy to get community help.

Entirely new tutorials on topics not yet covered or extensions are subject to "best-practices" and we would encourage you to get in touch first with us by opening an issue to discuss such an addition. If best-practices for a new topic do not yet exist (e.g. multimodal data analysis) we are generally open for new tutorials, but again, please ask us first to ensure that your work is not in vain.

### Generating exercises from the solutions

```
make exercises
```

The convention in solution files:
- using `# solution` comment inside a cell will remove all the content afterwards
  (including the `# solution` line) and replace it with `# Write your code here`.
- using `tags=["solution"]` on the same line as the cell marker removes the
  whole cell, for example:
  + for Python cells: `# %% tags=["solution"]`
  + for Markdown cells: `# %% [markdown] tags=["solution"]`

### Get wrap-up quiz solutions code

You can convert the quiz `.md` file to `.py` with valid Python code. This is
particularly useful to check quiz solutions or to try to debug user questions
on the forum.

```
jupytext --to py jupyter-book/linear_models/linear_models_wrap_up_quiz.md
```

This creates `jupyter-book/linear_models/linear_models_wrap_up_quiz.py` with
executable code.

Note: for this to work nicely with Jupytext you need to use `python` and not
`py` in the block codes i.e.:
``````
```python
```
``````

and not:
``````
```py
```
``````

## Editing the Notebook scripts

### Recommended workflow : Visual Studio Code

- Download [Visual Studio Code](https://code.visualstudio.com/)
- Install the [Jupyter Extension](https://marketplace.visualstudio.com/items?itemName=ms-toolsai.jupyter).
  This will allow you to run Python files in a cell by cell fashion
- notebooks are generated through the Jupytext command-line interface (see [below](#updating-the-notebooks))

It may well be that alternative editors (e.g. PyCharm) allow you to have a similar workflow, the only feature you need is to be able to run a `.py` file in a cell-by-cell fashion with `# %%` cell markers.

### Alternative workflow within Jupyter

- you can configure Jupyter to open `.py` files as notebooks (see
  [below](#setting-up-jupytext) for instructions) though Jupytext
- when saving the notebook inside Jupyter it will actually write to the `.py` file

In our experience, this workflow is less convenient (Visual Studio Code is a
nicer developping environment) and also it tends to add some not very important
(and different on everyone's machine) metadata changes in the `.py` file, for
example about jupytext version, Jupyter kernel, Python version, etc ...

#### Setting up jupytext

When jupytext is properly connected to jupyter, the python files can be
opened in jupyter and are directly displayed as notebooks

**With jupyter notebook**

Once jupytext is installed, run the following command:

```
jupyter serverextension enable jupytext
```

**With jupyter lab**

To make it work with "jupyter lab" (instead of
"jupyter notebook"), you have to install nodejs (`conda install nodejs`
works if you use conda). Then in jupyter lab you have to right click
"Open with -> notebook" to open the python scripts with the notebook
interface.
