
<!DOCTYPE html>


<html lang="en" data-content_root="../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>17. Compositional analysis &#8212; Single-cell best practices</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/sphinx-book-theme.css?v=eba8b062" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-design.min.css?v=95c83b7e" />
    <link rel="stylesheet" type="text/css" href="../_static/book.css?v=148c11e2" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="../_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="../_static/doctools.js?v=9a2dae69"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../_static/copybutton.js?v=f281be69"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../_static/design-tabs.js?v=f930bc37"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="../_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'conditions/compositional';</script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="../_static/book.js?v=dcd3d8bf"></script>
    <link rel="icon" href="../_static/favicon.ico"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="18. Gene set enrichment and pathway analysis" href="gsea_pathway.html" />
    <link rel="prev" title="16. Differential gene expression analysis" href="differential_gene_expression.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="../preamble.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../_static/logo.png" class="logo__image only-light" alt="Single-cell best practices - Home"/>
    <script>document.write(`<img src="../_static/logo.png" class="logo__image only-dark" alt="Single-cell best practices - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Introduction</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../introduction/prior_art.html">1. Prior art</a></li>
<li class="toctree-l1"><a class="reference internal" href="../introduction/scrna_seq.html">2. Single-cell RNA sequencing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../introduction/raw_data_processing.html">3. Raw data processing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../introduction/analysis_tools.html">4. Analysis frameworks and tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../introduction/interoperability.html">5. Interoperability</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Preprocessing and visualization</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../preprocessing_visualization/quality_control.html">6. Quality Control</a></li>
<li class="toctree-l1"><a class="reference internal" href="../preprocessing_visualization/normalization.html">7. Normalization</a></li>
<li class="toctree-l1"><a class="reference internal" href="../preprocessing_visualization/feature_selection.html">8. Feature selection</a></li>
<li class="toctree-l1"><a class="reference internal" href="../preprocessing_visualization/dimensionality_reduction.html">9. Dimensionality Reduction</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Identifying cellular structure</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../cellular_structure/clustering.html">10. Clustering</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cellular_structure/annotation.html">11. Annotation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cellular_structure/integration.html">12. Data integration</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Inferring trajectories</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../trajectories/pseudotemporal.html">13. Pseudotemporal ordering</a></li>
<li class="toctree-l1"><a class="reference internal" href="../trajectories/rna_velocity.html">14. RNA velocity</a></li>
<li class="toctree-l1"><a class="reference internal" href="../trajectories/lineage_tracing.html">15. Lineage tracing</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Dealing with conditions</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="differential_gene_expression.html">16. Differential gene expression analysis</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">17. Compositional analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="gsea_pathway.html">18. Gene set enrichment and pathway analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="perturbation_modeling.html">19. Perturbation modeling</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Modeling mechanisms</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../mechanisms/gene_regulatory_networks.html">20. Gene regulatory networks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mechanisms/cell_cell_communication.html">21. Cell-cell communication</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Deconvolution</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../deconvolution/bulk_deconvolution.html">22. Bulk deconvolution</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Chromatin Accessibility</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../chromatin_accessibility/introduction.html">23. Single-cell ATAC sequencing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../chromatin_accessibility/quality_control.html">24. Quality Control</a></li>
<li class="toctree-l1"><a class="reference internal" href="../chromatin_accessibility/gene_regulatory_networks_atac.html">25. Gene regulatory networks using chromatin accessibility</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Spatial omics</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../spatial/introduction.html">26. Single-cell data resolved in space</a></li>
<li class="toctree-l1"><a class="reference internal" href="../spatial/neighborhood.html">27. Neighborhood analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="../spatial/domains.html">28. Spatial domains</a></li>
<li class="toctree-l1"><a class="reference internal" href="../spatial/spatially_variable_genes.html">29. Spatially variable genes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../spatial/deconvolution.html">30. Spatial deconvolution</a></li>
<li class="toctree-l1"><a class="reference internal" href="../spatial/imputation.html">31. Imputation</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Surface protein</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../surface_protein/quality_control.html">32. Quality control</a></li>
<li class="toctree-l1"><a class="reference internal" href="../surface_protein/normalization.html">33. Normalization</a></li>
<li class="toctree-l1"><a class="reference internal" href="../surface_protein/doublet_detection.html">34. Doublet detection</a></li>
<li class="toctree-l1"><a class="reference internal" href="../surface_protein/dimensionality_reduction.html">35. Dimensionality Reduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../surface_protein/batch_correction.html">36. Batch correction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../surface_protein/annotation.html">37. Annotation</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Adaptive immune receptor repertoire</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../air_repertoire/ir_profiling.html">38. Immune Receptor Profiling</a></li>
<li class="toctree-l1"><a class="reference internal" href="../air_repertoire/clonotype.html">39. Clonotype analysis</a></li>



<li class="toctree-l1"><a class="reference internal" href="../air_repertoire/specificity.html">43. Specificity analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="../air_repertoire/multimodal_integration.html">44. Integrating AIR and transcriptomics</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Multimodal integration</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../multimodal_integration/paired_integration.html">45. Paired integration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../multimodal_integration/advanced_integration.html">46. Advanced integration</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Reproducibility</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../reproducibility/introduction.html">47. Reproducibility</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Outlook</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../outlook.html">48. Outlook</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Acknowledgements</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../acknowledgements.html">49. Acknowledgements</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Glossary</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../glossary.html">50. Glossary</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/theislab/single-cell-best-practices" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/theislab/single-cell-best-practices/edit/master/jupyter-book/conditions/compositional.ipynb" target="_blank"
   class="btn btn-sm btn-source-edit-button dropdown-item"
   title="Suggest edit"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-pencil-alt"></i>
  </span>
<span class="btn__text-container">Suggest edit</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/theislab/single-cell-best-practices/issues/new?title=Issue%20on%20page%20%2Fconditions/compositional.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../_sources/conditions/compositional.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Compositional analysis</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#motivation">17.1. Motivation</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#data-loading">17.2. Data loading</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#why-cell-type-count-data-is-compositional">17.3. Why cell-type count data is compositional</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#with-labeled-clusters">17.4. With labeled clusters</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#with-labeled-clusters-and-hierarchical-structure">17.5. With labeled clusters and hierarchical structure</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#without-labeled-clusters">17.6. Without labeled clusters</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#define-neighbourhoods">17.6.1. Define neighbourhoods</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#count-cells-in-neighbourhoods">17.6.2. Count cells in neighbourhoods</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#run-differential-abundance-test-on-neighbourhoods">17.6.3. Run differential abundance test on neighbourhoods</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#quiz">17.7. Quiz</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#references">17.8. References</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#contributors">17.9. Contributors</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#authors">17.9.1. Authors</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#reviewers">17.9.2. Reviewers</a></li>
</ul>
</li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="compositional-analysis">
<h1><span class="section-number">17. </span>Compositional analysis<a class="headerlink" href="#compositional-analysis" title="Link to this heading">#</a></h1>
<details class="sd-sphinx-override sd-dropdown sd-card sd-mb-3">
<summary class="sd-summary-title sd-card-header">
<span class="sd-summary-text"><i class="fas fa-brain"></i>   Key takeaways</span><span class="sd-summary-state-marker sd-summary-chevron-right"><svg version="1.1" width="1.5em" height="1.5em" class="sd-octicon sd-octicon-chevron-right" viewBox="0 0 24 24" aria-hidden="true"><path d="M8.72 18.78a.75.75 0 0 1 0-1.06L14.44 12 8.72 6.28a.751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018l6.25 6.25a.75.75 0 0 1 0 1.06l-6.25 6.25a.75.75 0 0 1-1.06 0Z"></path></svg></span></summary><div class="sd-summary-content sd-card-body docutils">
<div class="sd-card sd-sphinx-override sd-mb-3 sd-shadow-sm sd-card-hover docutils">
<div class="sd-card-body docutils">
<p class="sd-card-text">If the primary interest lies in compositional changes among known cell-types or states, use scCODA or tascCODA to statistically evaluate changes in abundance.</p>
</div>
<a class="sd-stretched-link sd-hide-link-text reference internal" href="#conditions-compositional-key-takeaway-1"><span class="std std-ref">With labeled clusters</span></a></div>
<div class="sd-card sd-sphinx-override sd-mb-3 sd-shadow-sm sd-card-hover docutils">
<div class="sd-card-body docutils">
<p class="sd-card-text">KNN based methods like DA-Seq or MILO should be used if the data does not cluster distinctly, such as during developmental processes, if we are interested in differences in cell abundances that might appear in transitional states between cell types or in a specific subset of cells of a given cell type.</p>
</div>
<a class="sd-stretched-link sd-hide-link-text reference internal" href="#conditions-compositional-key-takeaway-2"><span class="std std-ref">Without labeled clusters</span></a></div>
</div>
</details><details class="sd-sphinx-override sd-dropdown sd-card sd-mb-3">
<summary class="sd-summary-title sd-card-header">
<span class="sd-summary-text"><i class="fa-solid fa-gear"></i>   Environment setup</span><span class="sd-summary-state-marker sd-summary-chevron-right"><svg version="1.1" width="1.5em" height="1.5em" class="sd-octicon sd-octicon-chevron-right" viewBox="0 0 24 24" aria-hidden="true"><path d="M8.72 18.78a.75.75 0 0 1 0-1.06L14.44 12 8.72 6.28a.751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018l6.25 6.25a.75.75 0 0 1 0 1.06l-6.25 6.25a.75.75 0 0 1-1.06 0Z"></path></svg></span></summary><div class="sd-summary-content sd-card-body docutils">
<div class="sd-tab-set docutils">
<input checked="checked" id="sd-tab-item-0" name="sd-tab-set-0" type="radio">
<label class="sd-tab-label" for="sd-tab-item-0">
Steps</label><div class="sd-tab-content docutils">
<ol class="arabic">
<li><p class="sd-card-text"><strong>Install conda</strong>:</p>
<ul class="simple">
<li><p class="sd-card-text">Before creating the environment, ensure that <a class="reference external" href="https://docs.conda.io/projects/conda/en/latest/user-guide/install/index.html">conda</a> is installed on your system.</p></li>
</ul>
</li>
<li><p class="sd-card-text"><strong>Save the yml content</strong>:</p>
<ul class="simple">
<li><p class="sd-card-text">Copy the content from the yml tab into a file named <code class="docutils literal notranslate"><span class="pre">environment.yml</span></code>.</p></li>
</ul>
</li>
<li><p class="sd-card-text"><strong>Create the environment</strong>:</p>
<ul>
<li><p class="sd-card-text">Open a terminal or command prompt.</p></li>
<li><p class="sd-card-text">Run the following command:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>conda<span class="w"> </span>env<span class="w"> </span>create<span class="w"> </span>-f<span class="w"> </span>environment.yml
</pre></div>
</div>
</li>
</ul>
</li>
<li><p class="sd-card-text"><strong>Activate the environment</strong>:</p>
<ul>
<li><p class="sd-card-text">After the environment is created, activate it using:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>conda<span class="w"> </span>activate<span class="w"> </span>&lt;environment_name&gt;
</pre></div>
</div>
</li>
<li><p class="sd-card-text">Replace <code class="docutils literal notranslate"><span class="pre">&lt;environment_name&gt;</span></code> with the name specified in the <code class="docutils literal notranslate"><span class="pre">environment.yml</span></code> file. In the yml file it will look like this:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">&lt;environment_name&gt;</span>
</pre></div>
</div>
</li>
</ul>
</li>
<li><p class="sd-card-text"><strong>Verify the installation</strong>:</p>
<ul>
<li><p class="sd-card-text">Check that the environment was created successfully by running:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>conda<span class="w"> </span>env<span class="w"> </span>list
</pre></div>
</div>
</li>
</ul>
</li>
</ol>
</div>
<input id="sd-tab-item-1" name="sd-tab-set-0" type="radio">
<label class="sd-tab-label" for="sd-tab-item-1">
yml</label><div class="sd-tab-content docutils">
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">compositional</span>
<span class="nt">channels</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">conda-forge</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bioconda</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">anaconda</span>
<span class="nt">dependencies</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">conda-forge::python=3.11.9</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">conda-forge::git</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">conda-forge::jupyterlab</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">conda-forge::r-statmod</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">r-base=4.3.1</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bioconductor-edger</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">conda-forge::rpy2=3.5.11</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">conda-forge::notebook</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">conda-forge::schist=0.8.4</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">pip</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">pip</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">pertpy==0.8.0</span>
</pre></div>
</div>
</div>
</div>
</div>
</details><section id="motivation">
<h2><span class="section-number">17.1. </span>Motivation<a class="headerlink" href="#motivation" title="Link to this heading">#</a></h2>
<p>Beyond changes in gene expression patterns, cell compositions, such as the proportions of cell-types, can change between conditions. A specific drug may, for example, induce a transdifferentiation of a cell type which will be reflected in the cell identity composition. Sufficient cell and sample numbers are required to accurately determine cell-identity cluster proportions and background variation. Compositional analysis can be done on the level of cell identity clusters in the form of known cell types or cell states corresponding to, for example, cells recently affected by perturbations.</p>
<figure class="align-default" id="compositional-analysis-overview">
<a class="bg-primary mb-1 reference internal image-reference" href="../_images/compositional.jpg"><img alt="Compositional analysis overview" class="bg-primary mb-1" src="../_images/compositional.jpg" style="width: 800px;" />
</a>
<figcaption>
<p><span class="caption-number">Fig. 17.1 </span><span class="caption-text">Differential abundance analysis compares the composition of cell types between two conditions. The samples from both modalities contain different proportions of cell types, which can be tested for significant shifts in abundance.</span><a class="headerlink" href="#compositional-analysis-overview" title="Link to this image">#</a></p>
</figcaption>
</figure>
<p>This chapter will introduce both approaches and apply them to the Haber dataset<span id="id1">[<a class="reference internal" href="#id343" title="Adam L. Haber, Moshe Biton, Noga Rogel, Rebecca H. Herbst, Karthik Shekhar, Christopher Smillie, Grace Burgin, Toni M. Delorey, Michael R. Howitt, Yarden Katz, Itay Tirosh, Semir Beyaz, Danielle Dionne, Mei Zhang, Raktima Raychowdhury, Wendy S. Garrett, Orit Rozenblatt-Rosen, Hai Ning Shi, Omer Yilmaz, Ramnik J. Xavier, and Aviv Regev. A single-cell survey of the small intestinal epithelium. Nature, 551(7680):333-339, Nov 2017. URL: https://doi.org/10.1038/nature24489, doi:10.1038/nature24489.">Haber <em>et al.</em>, 2017</a>]</span>. This dataset contains 53,193 individual epithelial cells from the small intestine and organoids of mice. Some of the cells were also subject to bacterial or helminth infection such as through Salmonella and Heligmosomoides polygyrus respectively.
Throughout this tutorial we are using a subset of the complete Haber dataset which only includes control and infected cells that were collected specifically for this purpose. Notably, we are excluding an additional dataset which collected only large cells for faster computation and reduced complexity.</p>
<p>As a first step, we load the dataset.</p>
</section>
<section id="data-loading">
<h2><span class="section-number">17.2. </span>Data loading<a class="headerlink" href="#data-loading" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">warnings</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>

<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pertpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">scanpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sc</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">seaborn</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sns</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">adata</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">haber_2017_regions</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">adata</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>AnnData object with n_obs × n_vars = 9842 × 15215
    obs: &#39;batch&#39;, &#39;barcode&#39;, &#39;condition&#39;, &#39;cell_label&#39;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">adata</span><span class="o">.</span><span class="n">obs</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>batch</th>
      <th>barcode</th>
      <th>condition</th>
      <th>cell_label</th>
    </tr>
    <tr>
      <th>index</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>B1_AAACATACCACAAC_Control_Enterocyte.Progenitor</th>
      <td>B1</td>
      <td>AAACATACCACAAC</td>
      <td>Control</td>
      <td>Enterocyte.Progenitor</td>
    </tr>
    <tr>
      <th>B1_AAACGCACGAGGAC_Control_Stem</th>
      <td>B1</td>
      <td>AAACGCACGAGGAC</td>
      <td>Control</td>
      <td>Stem</td>
    </tr>
    <tr>
      <th>B1_AAACGCACTAGCCA_Control_Stem</th>
      <td>B1</td>
      <td>AAACGCACTAGCCA</td>
      <td>Control</td>
      <td>Stem</td>
    </tr>
    <tr>
      <th>B1_AAACGCACTGTCCC_Control_Stem</th>
      <td>B1</td>
      <td>AAACGCACTGTCCC</td>
      <td>Control</td>
      <td>Stem</td>
    </tr>
    <tr>
      <th>B1_AAACTTGACCACCT_Control_Enterocyte.Progenitor</th>
      <td>B1</td>
      <td>AAACTTGACCACCT</td>
      <td>Control</td>
      <td>Enterocyte.Progenitor</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>B10_TTTCACGACAAGCT_Salmonella_TA</th>
      <td>B10</td>
      <td>TTTCACGACAAGCT</td>
      <td>Salmonella</td>
      <td>TA</td>
    </tr>
    <tr>
      <th>B10_TTTCAGTGAGGCGA_Salmonella_Enterocyte</th>
      <td>B10</td>
      <td>TTTCAGTGAGGCGA</td>
      <td>Salmonella</td>
      <td>Enterocyte</td>
    </tr>
    <tr>
      <th>B10_TTTCAGTGCGACAT_Salmonella_Stem</th>
      <td>B10</td>
      <td>TTTCAGTGCGACAT</td>
      <td>Salmonella</td>
      <td>Stem</td>
    </tr>
    <tr>
      <th>B10_TTTCAGTGTGACCA_Salmonella_Endocrine</th>
      <td>B10</td>
      <td>TTTCAGTGTGACCA</td>
      <td>Salmonella</td>
      <td>Endocrine</td>
    </tr>
    <tr>
      <th>B10_TTTCAGTGTTCTCA_Salmonella_Enterocyte.Progenitor</th>
      <td>B10</td>
      <td>TTTCAGTGTTCTCA</td>
      <td>Salmonella</td>
      <td>Enterocyte.Progenitor</td>
    </tr>
  </tbody>
</table>
<p>9842 rows × 4 columns</p>
</div></div></div>
</div>
<p>The data was collected in 10 batches. Unique conditions are Control, Salmonella, Hpoly.Day3 and Hpoly.Day10 which correspond to the healthy control state, Salmonella infection, Heligmosomoides polygyrus infected cells after 3 days and Heligmosomoides polygyrus infected cells after 10 days. The <code class="docutils literal notranslate"><span class="pre">cell_label</span></code> corresponds to the cell types.</p>
</section>
<section id="why-cell-type-count-data-is-compositional">
<h2><span class="section-number">17.3. </span>Why cell-type count data is compositional<a class="headerlink" href="#why-cell-type-count-data-is-compositional" title="Link to this heading">#</a></h2>
<p>When analyzing the compositional shifts in cell count data, multiple technical and methodological limitations need to be accounted for. One challenge is the characteristically low number of experimental replicates, which leads to large confidence intervals when conducting differential abundance analysis with frequentist statistical tests.
Even more important, single-cell sequencing is naturally limited in the number of cells per sample - we can’t sequence every cell in a tissue or organ, but use a small, representative snapshot instead. This, however, forces us to view the cell type counts as purely proportional, i.e. the total number of cells in a sample is only a scaling factor. In the statistical literature, such data is known as compositional data<span id="id2">[<a class="reference internal" href="#id344" title="J. Aitchison. The statistical analysis of compositional data. Journal of the Royal Statistical Society: Series B (Methodological), 44(2):139-160, 1982. URL: https://rss.onlinelibrary.wiley.com/doi/abs/10.1111/j.2517-6161.1982.tb01195.x, arXiv:https://rss.onlinelibrary.wiley.com/doi/pdf/10.1111/j.2517-6161.1982.tb01195.x, doi:https://doi.org/10.1111/j.2517-6161.1982.tb01195.x.">Aitchison, 1982</a>]</span>, and characterized by the relative abundances of all features (cell types in our case) in one sample always adding up to one.</p>
<p>Because of this sum-to-one constraint, a negative correlation between the cell type abundances is induced. To illustrate this, let’s consider the following example:</p>
<p>In a case-control study, we want to compare the cell type composition of a healthy and a diseased organ. In both cases, we have three cell types (A, B and C), but their abundances differ:</p>
<ul class="simple">
<li><p>The healthy organ consists of 2,000 cells of each type (6,000 cells total).</p></li>
<li><p>The disease leads to a doubling of cell type A, while cell types B and C are not affected, so that the diseased organ has 8,000 cells.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">healthy_tissue</span> <span class="o">=</span> <span class="p">[</span><span class="mi">2000</span><span class="p">,</span> <span class="mi">2000</span><span class="p">,</span> <span class="mi">2000</span><span class="p">]</span>
<span class="n">diseased_tissue</span> <span class="o">=</span> <span class="p">[</span><span class="mi">4000</span><span class="p">,</span> <span class="mi">2000</span><span class="p">,</span> <span class="mi">2000</span><span class="p">]</span>
<span class="n">example_data_global</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
    <span class="n">data</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">healthy_tissue</span><span class="p">,</span> <span class="n">diseased_tissue</span><span class="p">]),</span>
    <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span>
    <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;A&quot;</span><span class="p">,</span> <span class="s2">&quot;B&quot;</span><span class="p">,</span> <span class="s2">&quot;C&quot;</span><span class="p">],</span>
<span class="p">)</span>
<span class="n">example_data_global</span><span class="p">[</span><span class="s2">&quot;Disease status&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Healthy&quot;</span><span class="p">,</span> <span class="s2">&quot;Diseased&quot;</span><span class="p">]</span>
<span class="n">example_data_global</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>A</th>
      <th>B</th>
      <th>C</th>
      <th>Disease status</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1</th>
      <td>2000</td>
      <td>2000</td>
      <td>2000</td>
      <td>Healthy</td>
    </tr>
    <tr>
      <th>2</th>
      <td>4000</td>
      <td>2000</td>
      <td>2000</td>
      <td>Diseased</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plot_data_global</span> <span class="o">=</span> <span class="n">example_data_global</span><span class="o">.</span><span class="n">melt</span><span class="p">(</span>
    <span class="s2">&quot;Disease status&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;A&quot;</span><span class="p">,</span> <span class="s2">&quot;B&quot;</span><span class="p">,</span> <span class="s2">&quot;C&quot;</span><span class="p">],</span> <span class="s2">&quot;Cell type&quot;</span><span class="p">,</span> <span class="s2">&quot;count&quot;</span>
<span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">sns</span><span class="o">.</span><span class="n">barplot</span><span class="p">(</span>
    <span class="n">data</span><span class="o">=</span><span class="n">plot_data_global</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s2">&quot;Disease status&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">&quot;count&quot;</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="s2">&quot;Cell type&quot;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Global abundances, by status&quot;</span><span class="p">)</span>

<span class="n">sns</span><span class="o">.</span><span class="n">barplot</span><span class="p">(</span>
    <span class="n">data</span><span class="o">=</span><span class="n">plot_data_global</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s2">&quot;Cell type&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">&quot;count&quot;</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="s2">&quot;Disease status&quot;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Global abundances, by cell type&quot;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/9b1d481a4d97ebe5acb4adff87433f0cc64042913721764653fb2c5e7f498815.png" src="../_images/9b1d481a4d97ebe5acb4adff87433f0cc64042913721764653fb2c5e7f498815.png" />
</div>
</div>
<p>We want to find out which cell types increase or decrease in abundance in the diseased organ. If we are able to determine the type of every cell in both organs, the case would be clear, as we can see in the right plot above. Unfortunately, this is not possible. Since our sequencing process has a limited capacity, we can only take a representative sample of 600 cells from both populations. To simulate this step, we can use numpy’s <code class="docutils literal notranslate"><span class="pre">random.multinomial</span></code> function to sample 600 cells from the populations without replacement:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">rng</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">Generator</span><span class="p">(</span><span class="mi">1234</span><span class="p">)</span>
<span class="n">healthy_sample</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">multinomial</span><span class="p">(</span><span class="n">pvals</span><span class="o">=</span><span class="n">healthy_tissue</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">healthy_tissue</span><span class="p">),</span> <span class="n">n</span><span class="o">=</span><span class="mi">600</span><span class="p">)</span>
<span class="n">diseased_sample</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">multinomial</span><span class="p">(</span>
    <span class="n">pvals</span><span class="o">=</span><span class="n">diseased_tissue</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">diseased_tissue</span><span class="p">),</span> <span class="n">n</span><span class="o">=</span><span class="mi">600</span>
<span class="p">)</span>
<span class="n">example_data_sample</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
    <span class="n">data</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">healthy_sample</span><span class="p">,</span> <span class="n">diseased_sample</span><span class="p">]),</span>
    <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span>
    <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;A&quot;</span><span class="p">,</span> <span class="s2">&quot;B&quot;</span><span class="p">,</span> <span class="s2">&quot;C&quot;</span><span class="p">],</span>
<span class="p">)</span>
<span class="n">example_data_sample</span><span class="p">[</span><span class="s2">&quot;Disease status&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Healthy&quot;</span><span class="p">,</span> <span class="s2">&quot;Diseased&quot;</span><span class="p">]</span>
<span class="n">example_data_sample</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>A</th>
      <th>B</th>
      <th>C</th>
      <th>Disease status</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1</th>
      <td>193</td>
      <td>201</td>
      <td>206</td>
      <td>Healthy</td>
    </tr>
    <tr>
      <th>2</th>
      <td>296</td>
      <td>146</td>
      <td>158</td>
      <td>Diseased</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plot_data_sample</span> <span class="o">=</span> <span class="n">example_data_sample</span><span class="o">.</span><span class="n">melt</span><span class="p">(</span>
    <span class="s2">&quot;Disease status&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;A&quot;</span><span class="p">,</span> <span class="s2">&quot;B&quot;</span><span class="p">,</span> <span class="s2">&quot;C&quot;</span><span class="p">],</span> <span class="s2">&quot;Cell type&quot;</span><span class="p">,</span> <span class="s2">&quot;count&quot;</span>
<span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">sns</span><span class="o">.</span><span class="n">barplot</span><span class="p">(</span>
    <span class="n">data</span><span class="o">=</span><span class="n">plot_data_sample</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s2">&quot;Disease status&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">&quot;count&quot;</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="s2">&quot;Cell type&quot;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Sampled abundances, by status&quot;</span><span class="p">)</span>

<span class="n">sns</span><span class="o">.</span><span class="n">barplot</span><span class="p">(</span>
    <span class="n">data</span><span class="o">=</span><span class="n">plot_data_sample</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s2">&quot;Cell type&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">&quot;count&quot;</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="s2">&quot;Disease status&quot;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Sampled abundances, by cell type&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/8894c7bbd20b851a3d403a59a82d6b340858eb484dfdffe3e5248796d79796b2.png" src="../_images/8894c7bbd20b851a3d403a59a82d6b340858eb484dfdffe3e5248796d79796b2.png" />
</div>
</div>
<p>Now the picture is not clear anymore. While the counts of cell type A still increase (approx. from 200 to 300), the other two cell types seem to decrease from about 200 to 150. This apparent decrease is caused by our constraint to 600 cells - If a larger fraction of the sample is taken up by cell type A, the share of cell types B and C must be lower. Therefore, determining the change in abundance of one cell type is impossible without taking the other cell types into account.</p>
<p>If we ignore the compositionality of the data, and use univariate methods like Wilcoxon rank-sum tests or scDC, a method which performs differential cell-type composition analysis by bootstrap resampling<span id="id3">[<a class="reference internal" href="#id345" title="Yue Cao, Yingxin Lin, John T. Ormerod, Pengyi Yang, Jean Y.H. Yang, and Kitty K. Lo. Scdc: single cell differential composition analysis. BMC Bioinformatics, 20(19):721, Dec 2019. URL: https://doi.org/10.1186/s12859-019-3211-9, doi:10.1186/s12859-019-3211-9.">Cao <em>et al.</em>, 2019</a>]</span>, we may falsely perceive cell-type population shifts as statistically sound effects, although they were induced by inherent negative correlations of the cell-type proportions.</p>
<p>Furthermore, the subsampled data does not only give us one valid solution to our question. If both cell types B and C decreased by 1,000 cells in the diseased case, we would obtain the same representative samples of 600 cells as above. To get a unique result, we can fix a reference point for the data, which is assumed to be unchanged throughout all samples<span id="id4">[<a class="reference internal" href="#id353" title="Barak Brill, Amnon Amir, and Ruth Heller. Testing for differential abundance in compositional counts data, with application to microbiome studies. ArXiv, April 2019. URL: http://arxiv.org/abs/1904.08937, arXiv:1904.08937.">Brill <em>et al.</em>, 2019</a>]</span>. This can be a single cell type, an aggregation over multiple cell types such as the geometric mean, or a set of orthogonal bases <span id="id5">[<a class="reference internal" href="#id354" title="J J Egozcue, V Pawlowsky-Glahn, G Mateu-Figueras, and C Barceló-Vidal. Isometric logratio transformations for compositional data analysis. Math. Geol., 35(3):279–300, April 2003. URL: https://doi.org/10.1023/A:1023818214614, doi:10.1023/A:1023818214614.">Egozcue <em>et al.</em>, 2003</a>]</span>.</p>
<p>While single-cell datasets of sufficient size and replicate number have only been around for a few years, the same statistical property has also been discussed in the context of microbial analysis<span id="id6">[<a class="reference internal" href="#id355" title="Gregory B Gloor, Jean M Macklaim, Vera Pawlowsky-Glahn, and Juan J Egozcue. Microbiome datasets are compositional: and this is not optional. Front. Microbiol., 8:2224, November 2017. URL: http://dx.doi.org/10.3389/fmicb.2017.02224, doi:10.3389/fmicb.2017.02224.">Gloor <em>et al.</em>, 2017</a>]</span>. There, some popular approaches include ANCOM-BC <span id="id7">[<a class="reference internal" href="#id356" title="Huang Lin and Shyamal Das Peddada. Analysis of compositions of microbiomes with bias correction. Nat. Commun., 11(1):3514, July 2020. URL: http://dx.doi.org/10.1038/s41467-020-17041-7, doi:10.1038/s41467-020-17041-7.">Lin and Peddada, 2020</a>]</span> and ALDEx2 <span id="id8">[<a class="reference internal" href="#id357" title="Andrew D Fernandes, Jennifer Ns Reid, Jean M Macklaim, Thomas A McMurrough, David R Edgell, and Gregory B Gloor. Unifying the analysis of high-throughput sequencing datasets: characterizing RNA-seq, 16S rRNA gene sequencing and selective growth experiments by compositional data analysis. Microbiome, 2:15, May 2014. URL: http://dx.doi.org/10.1186/2049-2618-2-15, doi:10.1186/2049-2618-2-15.">Fernandes <em>et al.</em>, 2014</a>]</span>. However, these approaches often struggle with single-cell datasets due to the small number of experimental replicates.</p>
<p>This issue has been tackled by scCODA<span id="id9">[<a class="reference internal" href="#id346" title="M. Büttner, J. Ostner, C. L. Müller, F. J. Theis, and B. Schubert. Sccoda is a bayesian model for compositional single-cell data analysis. Nature Communications, 12(1):6876, Nov 2021. URL: https://doi.org/10.1038/s41467-021-27150-6, doi:10.1038/s41467-021-27150-6.">Büttner <em>et al.</em>, 2021</a>]</span>, which we are going to introduce and apply to our dataset in the following section.</p>
</section>
<section id="with-labeled-clusters">
<span id="conditions-compositional-key-takeaway-1"></span><h2><span class="section-number">17.4. </span>With labeled clusters<a class="headerlink" href="#with-labeled-clusters" title="Link to this heading">#</a></h2>
<p><a class="reference external" href="https://sccoda.readthedocs.io/en/latest">scCODA</a> belongs to the family of tools that require pre-defined clusters, most common cell types, to statistically derive changes in composition. Inspired by methods for compositional analysis of microbiome data, scCODA proposes a Bayesian approach to address the low replicate issue as commonly encountered in single-cell analysis<span id="id10">[<a class="reference internal" href="#id346" title="M. Büttner, J. Ostner, C. L. Müller, F. J. Theis, and B. Schubert. Sccoda is a bayesian model for compositional single-cell data analysis. Nature Communications, 12(1):6876, Nov 2021. URL: https://doi.org/10.1038/s41467-021-27150-6, doi:10.1038/s41467-021-27150-6.">Büttner <em>et al.</em>, 2021</a>]</span>. It models cell-type counts using a hierarchical Dirichlet-Multinomial model, which accounts for uncertainty in cell-type proportions and the negative correlative bias via joint modeling of all measured cell-type proportions. To ensure a uniquely identifiable solution and easy interpretability, the reference in scCODA is chosen to be a specific cell type. Hence, any detected compositional changes by scCODA always have to be viewed in relation to the selected reference.</p>
<p>However, scCODA assumes a log-linear relationship between covariates and cell abundance, which may not always reflect the underlying biological processes when using continuous covariates. A further limitation of scCODA is the inability to infer correlation structures among cell compositions beyond compositional effects. Furthermore, scCODA only models shifts in mean abundance, but does not detect changes in response variability<span id="id11">[<a class="reference internal" href="#id346" title="M. Büttner, J. Ostner, C. L. Müller, F. J. Theis, and B. Schubert. Sccoda is a bayesian model for compositional single-cell data analysis. Nature Communications, 12(1):6876, Nov 2021. URL: https://doi.org/10.1038/s41467-021-27150-6, doi:10.1038/s41467-021-27150-6.">Büttner <em>et al.</em>, 2021</a>]</span>.</p>
<p>As a first step, we instantiate a scCODA model.</p>
<p>Then, we use load function to prepare a MuData object for subsequent processing, and it creates a compositional analysis dataset from the input adata. And we specify the cell_type_identifier as <code class="docutils literal notranslate"><span class="pre">cell_label</span></code>, sample_identifier as <code class="docutils literal notranslate"><span class="pre">batch</span></code>, and covariate_obs as <code class="docutils literal notranslate"><span class="pre">condition</span></code> in our case.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sccoda_model</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">tl</span><span class="o">.</span><span class="n">Sccoda</span><span class="p">()</span>
<span class="n">sccoda_data</span> <span class="o">=</span> <span class="n">sccoda_model</span><span class="o">.</span><span class="n">load</span><span class="p">(</span>
    <span class="n">adata</span><span class="p">,</span>
    <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;cell_level&quot;</span><span class="p">,</span>
    <span class="n">generate_sample_level</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">cell_type_identifier</span><span class="o">=</span><span class="s2">&quot;cell_label&quot;</span><span class="p">,</span>
    <span class="n">sample_identifier</span><span class="o">=</span><span class="s2">&quot;batch&quot;</span><span class="p">,</span>
    <span class="n">covariate_obs</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;condition&quot;</span><span class="p">],</span>
<span class="p">)</span>
<span class="n">sccoda_data</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><pre>MuData object with n_obs × n_vars = 9852 × 15223
  2 modalities
    rna:	9842 x 15215
      obs:	&#x27;batch&#x27;, &#x27;barcode&#x27;, &#x27;condition&#x27;, &#x27;cell_label&#x27;, &#x27;scCODA_sample_id&#x27;
    coda:	10 x 8
      obs:	&#x27;condition&#x27;, &#x27;batch&#x27;
      var:	&#x27;n_cells&#x27;</pre></div></div>
</div>
<p>To get an overview of the cell type distributions across conditions we can use scCODA’s <code class="docutils literal notranslate"><span class="pre">boxplots</span></code>. To get an even better understanding of how the data is distributed, the red dots show the actual data points.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sccoda_model</span><span class="o">.</span><span class="n">plot_boxplots</span><span class="p">(</span>
    <span class="n">sccoda_data</span><span class="p">,</span>
    <span class="n">modality_key</span><span class="o">=</span><span class="s2">&quot;coda&quot;</span><span class="p">,</span>
    <span class="n">feature_name</span><span class="o">=</span><span class="s2">&quot;condition&quot;</span><span class="p">,</span>
    <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span>
    <span class="n">add_dots</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">args_swarmplot</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;palette&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;red&quot;</span><span class="p">]},</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/3197804626830748148ac6c66167a46d03ef045b7bb645c8413f0d6bb1dfaf63.png" src="../_images/3197804626830748148ac6c66167a46d03ef045b7bb645c8413f0d6bb1dfaf63.png" />
</div>
</div>
<p>The boxplots highlight some differences in the distributions of the cell types. Clearly noticeable is the high proportion of enterocytes for the Salmonella condition. But other cell types such as transit-amplifying (TA) cells also show stark differences in abundance for the Salmonella condition compared to control. Whether any of these differences are statistically significant has to be properly evaluated.</p>
<p>An alternative visualization is a stacked barplot as provided by scCODA. This visualization nicely displays the characteristics of compositional data: If we compare the Control and Salmonella groups, we can see that the proportion of Enterocytes greatly increases in the infected mice. Since the data is proportional, this leads to a decreased share of all other cell types to fulfill the sum-to-one constraint.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sccoda_model</span><span class="o">.</span><span class="n">plot_stacked_barplot</span><span class="p">(</span>
    <span class="n">sccoda_data</span><span class="p">,</span> <span class="n">modality_key</span><span class="o">=</span><span class="s2">&quot;coda&quot;</span><span class="p">,</span> <span class="n">feature_name</span><span class="o">=</span><span class="s2">&quot;condition&quot;</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/5eb5d0c00e9242745d783e8fa24ea3f4d508fd6e07539c3b82d090f6d3b9edac.png" src="../_images/5eb5d0c00e9242745d783e8fa24ea3f4d508fd6e07539c3b82d090f6d3b9edac.png" />
</div>
</div>
<p>scCODA requires two major parameters beyond the cell count AnnData object: A formula and a reference cell type. The formula describes the covariates, which are specified using the <a class="reference external" href="https://www.statsmodels.org/stable/example_formulas.html">R-style</a>. In our case we specify the condition as the only covariate. Since it is a discrete covariate with four levels (control and three disease states), this models a comparison of each state with the other samples.
If we wanted to model multiple covariates at once, simply adding them in the formula (i.e. <code class="docutils literal notranslate"><span class="pre">formula</span> <span class="pre">=</span> <span class="pre">&quot;covariate_1</span> <span class="pre">+</span> <span class="pre">covariate_2&quot;</span></code>) is enough.
As mentioned above, scCODA requires a reference cell type to compare against, which is believed to be unchanged by the covariates. scCODA can either automatically select an appropriate cell type as reference, which is a cell type that has nearly constant relative abundance over all samples, or be run with a user specified reference cell type. Here we set Endocrine cells as the reference since visually their abundance seems to be rather constant. An alternative to setting a reference cell type manually is to set the <code class="docutils literal notranslate"><span class="pre">reference_cell_type</span></code> to <code class="docutils literal notranslate"><span class="pre">&quot;automatic&quot;</span></code> which will force scCODA to select a suitable reference cell type itself. If the choice of reference cell type is unclear, we recommend to use this option to get an indicator or even a final selection.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sccoda_data</span> <span class="o">=</span> <span class="n">sccoda_model</span><span class="o">.</span><span class="n">prepare</span><span class="p">(</span>
    <span class="n">sccoda_data</span><span class="p">,</span>
    <span class="n">modality_key</span><span class="o">=</span><span class="s2">&quot;coda&quot;</span><span class="p">,</span>
    <span class="n">formula</span><span class="o">=</span><span class="s2">&quot;condition&quot;</span><span class="p">,</span>
    <span class="n">reference_cell_type</span><span class="o">=</span><span class="s2">&quot;Endocrine&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">sccoda_model</span><span class="o">.</span><span class="n">run_nuts</span><span class="p">(</span><span class="n">sccoda_data</span><span class="p">,</span> <span class="n">modality_key</span><span class="o">=</span><span class="s2">&quot;coda&quot;</span><span class="p">,</span> <span class="n">rng_key</span><span class="o">=</span><span class="mi">1234</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>sample: 100%|██████████| 11000/11000 [01:08&lt;00:00, 161.54it/s, 255 steps of size 1.72e-02. acc. prob=0.85]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sccoda_data</span><span class="p">[</span><span class="s2">&quot;coda&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">varm</span><span class="p">[</span><span class="s2">&quot;effect_df_condition[T.Salmonella]&quot;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Final Parameter</th>
      <th>HDI 3%</th>
      <th>HDI 97%</th>
      <th>SD</th>
      <th>Inclusion probability</th>
      <th>Expected Sample</th>
      <th>log2-fold change</th>
    </tr>
    <tr>
      <th>Cell Type</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>Endocrine</th>
      <td>0.0000</td>
      <td>0.000</td>
      <td>0.000</td>
      <td>0.000</td>
      <td>0.0000</td>
      <td>32.598994</td>
      <td>-0.526812</td>
    </tr>
    <tr>
      <th>Enterocyte</th>
      <td>1.5458</td>
      <td>0.985</td>
      <td>2.071</td>
      <td>0.283</td>
      <td>0.9996</td>
      <td>382.634978</td>
      <td>1.703306</td>
    </tr>
    <tr>
      <th>Enterocyte.Progenitor</th>
      <td>0.0000</td>
      <td>-0.475</td>
      <td>0.566</td>
      <td>0.143</td>
      <td>0.2817</td>
      <td>126.126003</td>
      <td>-0.526812</td>
    </tr>
    <tr>
      <th>Goblet</th>
      <td>0.0000</td>
      <td>-0.345</td>
      <td>1.013</td>
      <td>0.290</td>
      <td>0.4354</td>
      <td>52.735108</td>
      <td>-0.526812</td>
    </tr>
    <tr>
      <th>Stem</th>
      <td>0.0000</td>
      <td>-0.742</td>
      <td>0.297</td>
      <td>0.173</td>
      <td>0.3092</td>
      <td>135.406509</td>
      <td>-0.526812</td>
    </tr>
    <tr>
      <th>TA</th>
      <td>0.0000</td>
      <td>-0.876</td>
      <td>0.331</td>
      <td>0.211</td>
      <td>0.3358</td>
      <td>78.986854</td>
      <td>-0.526812</td>
    </tr>
    <tr>
      <th>TA.Early</th>
      <td>0.0000</td>
      <td>-0.338</td>
      <td>0.615</td>
      <td>0.151</td>
      <td>0.3033</td>
      <td>152.670412</td>
      <td>-0.526812</td>
    </tr>
    <tr>
      <th>Tuft</th>
      <td>0.0000</td>
      <td>-1.221</td>
      <td>0.548</td>
      <td>0.342</td>
      <td>0.4098</td>
      <td>23.041143</td>
      <td>-0.526812</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>The acceptance rate describes the fraction of proposed samples that are accepted after the initial burn-in phase, and can be an ad-hoc indicator for a bad optimization run. In the case of scCODA, the desired acceptance rate is between 0.4 and 0.9. Acceptance rates that are way higher or too low indicate issues with the sampling process.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sccoda_data</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><pre>MuData object with n_obs × n_vars = 9852 × 15223
  2 modalities
    rna:	9842 x 15215
      obs:	&#x27;batch&#x27;, &#x27;barcode&#x27;, &#x27;condition&#x27;, &#x27;cell_label&#x27;, &#x27;scCODA_sample_id&#x27;
    coda:	10 x 8
      obs:	&#x27;condition&#x27;, &#x27;batch&#x27;
      var:	&#x27;n_cells&#x27;
      uns:	&#x27;scCODA_params&#x27;
      obsm:	&#x27;covariate_matrix&#x27;, &#x27;sample_counts&#x27;
      varm:	&#x27;intercept_df&#x27;, &#x27;effect_df_condition[T.Hpoly.Day3]&#x27;, &#x27;effect_df_condition[T.Hpoly.Day10]&#x27;, &#x27;effect_df_condition[T.Salmonella]&#x27;</pre></div></div>
</div>
<p>scCODA selects credible effects based on their inclusion probability. The cutoff between credible and non-credible effects depends on the desired false discovery rate (FDR). A smaller FDR value will produce more conservative results, but might miss some effects, while a larger FDR value selects more effects at the cost of a larger number of false discoveries.
The desired FDR level can be easily set after inference via sim_results.set_fdr(). Per default, the value is 0.05. Since, depending on the dataset, the FDR can have a major influence on the result, we recommend to try out different FDRs up to 0.2 to get the most prominent effects.</p>
<p>In our case, we use less strict FDR of 0.2.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sccoda_model</span><span class="o">.</span><span class="n">set_fdr</span><span class="p">(</span><span class="n">sccoda_data</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>To get the binary classification of compositional changes per cell type we use the <code class="docutils literal notranslate"><span class="pre">credible_effects</span></code> function of scCODA on the result object. Every cell type labeled as “True” is significantly more or less present. The fold-changes describe whether the cell type is more or less present. Hence, we will plot them alongside the binary classification below.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sccoda_model</span><span class="o">.</span><span class="n">credible_effects</span><span class="p">(</span><span class="n">sccoda_data</span><span class="p">,</span> <span class="n">modality_key</span><span class="o">=</span><span class="s2">&quot;coda&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Covariate                 Cell Type            
condition[T.Hpoly.Day3]   Endocrine                False
                          Enterocyte               False
                          Enterocyte.Progenitor    False
                          Goblet                   False
                          Stem                     False
                          TA                       False
                          TA.Early                 False
                          Tuft                     False
condition[T.Hpoly.Day10]  Endocrine                False
                          Enterocyte                True
                          Enterocyte.Progenitor    False
                          Goblet                   False
                          Stem                     False
                          TA                       False
                          TA.Early                 False
                          Tuft                      True
condition[T.Salmonella]   Endocrine                False
                          Enterocyte                True
                          Enterocyte.Progenitor    False
                          Goblet                   False
                          Stem                     False
                          TA                       False
                          TA.Early                 False
                          Tuft                     False
Name: Final Parameter, dtype: bool
</pre></div>
</div>
</div>
</div>
<p>To plot the fold changes together with the binary classification, we can easily use effects_bar_plot function.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sccoda_model</span><span class="o">.</span><span class="n">plot_effects_barplot</span><span class="p">(</span><span class="n">sccoda_data</span><span class="p">,</span> <span class="s2">&quot;coda&quot;</span><span class="p">,</span> <span class="s2">&quot;condition&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/eb1a04a8cf8e8469174c28442adb7c7968fc1a88656c3077861dd1cdce21d188.png" src="../_images/eb1a04a8cf8e8469174c28442adb7c7968fc1a88656c3077861dd1cdce21d188.png" />
</div>
</div>
<p>The plots nicely show the significant and credible effects of conditions on the cell types. These effects largely agree with the findings in the Haber paper, who used a non-compositional Poisson regression model their findings:</p>
<ol class="arabic simple">
<li><p>“After Salmonella infection, the frequency of mature enterocytes increased substantially.”<span id="id12">[<a class="reference internal" href="#id343" title="Adam L. Haber, Moshe Biton, Noga Rogel, Rebecca H. Herbst, Karthik Shekhar, Christopher Smillie, Grace Burgin, Toni M. Delorey, Michael R. Howitt, Yarden Katz, Itay Tirosh, Semir Beyaz, Danielle Dionne, Mei Zhang, Raktima Raychowdhury, Wendy S. Garrett, Orit Rozenblatt-Rosen, Hai Ning Shi, Omer Yilmaz, Ramnik J. Xavier, and Aviv Regev. A single-cell survey of the small intestinal epithelium. Nature, 551(7680):333-339, Nov 2017. URL: https://doi.org/10.1038/nature24489, doi:10.1038/nature24489.">Haber <em>et al.</em>, 2017</a>]</span></p></li>
<li><p>“Heligmosomoides polygyrus caused an increase in the abundance of goblet and tuft cells.”<span id="id13">[<a class="reference internal" href="#id343" title="Adam L. Haber, Moshe Biton, Noga Rogel, Rebecca H. Herbst, Karthik Shekhar, Christopher Smillie, Grace Burgin, Toni M. Delorey, Michael R. Howitt, Yarden Katz, Itay Tirosh, Semir Beyaz, Danielle Dionne, Mei Zhang, Raktima Raychowdhury, Wendy S. Garrett, Orit Rozenblatt-Rosen, Hai Ning Shi, Omer Yilmaz, Ramnik J. Xavier, and Aviv Regev. A single-cell survey of the small intestinal epithelium. Nature, 551(7680):333-339, Nov 2017. URL: https://doi.org/10.1038/nature24489, doi:10.1038/nature24489.">Haber <em>et al.</em>, 2017</a>]</span></p></li>
</ol>
<p>Readers familiar with the original publication may wonder why the model used by Haber et al. found more significant effects than scCODA, for example a decrease in Stem and Transit-Amplifying cells in the case of Salmonella infection<span id="id14">[<a class="reference internal" href="#id343" title="Adam L. Haber, Moshe Biton, Noga Rogel, Rebecca H. Herbst, Karthik Shekhar, Christopher Smillie, Grace Burgin, Toni M. Delorey, Michael R. Howitt, Yarden Katz, Itay Tirosh, Semir Beyaz, Danielle Dionne, Mei Zhang, Raktima Raychowdhury, Wendy S. Garrett, Orit Rozenblatt-Rosen, Hai Ning Shi, Omer Yilmaz, Ramnik J. Xavier, and Aviv Regev. A single-cell survey of the small intestinal epithelium. Nature, 551(7680):333-339, Nov 2017. URL: https://doi.org/10.1038/nature24489, doi:10.1038/nature24489.">Haber <em>et al.</em>, 2017</a>]</span>. To explain this discrepancy, remember that cell count data is compositional and therefore an increase in the relative abundance of one cell type will lead to a decrease in the relative abundance of all other cell types.
Due to the stark increase of Enterocytes in the small intestinal epithelium of Salmonella-infected mice, all other cell types appear to decrease, even though this shift is only caused by the compositional properties of the data. While the original (univariate) Poisson regression model will pick up these likely false positive effects, scCODA is able to account for the compositionality of the data and therefore does not fall into this trap.</p>
</section>
<section id="with-labeled-clusters-and-hierarchical-structure">
<h2><span class="section-number">17.5. </span>With labeled clusters and hierarchical structure<a class="headerlink" href="#with-labeled-clusters-and-hierarchical-structure" title="Link to this heading">#</a></h2>
<p>In addition to the abundance of each cell type, a typical single-cell dataset also contains information about the similarity of the different cells in the form of a tree-based hierarchical ordering. These hierarchies can either be determined automatically via clustering of the gene expression (which is usually done to discover the clusters of cells that belong to the same cell type), or through biologically informed hierarchies like cell lineages.
<a class="reference external" href="https://tasccoda.readthedocs.io/en/latest/">tascCODA</a> is an extension of scCODA that integrates hierarchical information and experimental covariate data into the generative modeling of compositional count data<span id="id15">[<a class="reference internal" href="#id347" title="Johannes Ostner, Salomé Carcy, and Christian L. Müller. Tasccoda: bayesian tree-aggregated analysis of compositional amplicon and single-cell data. Frontiers in Genetics, 2021. URL: https://www.frontiersin.org/article/10.3389/fgene.2021.766405, doi:10.3389/fgene.2021.766405.">Ostner <em>et al.</em>, 2021</a>]</span>. This is especially beneficial for cell atlassing efforts with increased resolution.</p>
<p>At its core, it uses almost the same Dirichlet-Multinomial setup as scCODA, but extends the model, such that effects on sets of cell types, which are defined as internal nodes in the tree structure.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">schist</span>

<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>objc[13344]: Class GNotificationCenterDelegate is implemented in both /opt/anaconda3/lib/libgio-2.0.0.dylib (0x18ef5ec30) and /usr/local/Cellar/glib/2.74.4/lib/libgio-2.0.0.dylib (0x19be736b0). One of the two will be used. Which one is undefined.
</pre></div>
</div>
</div>
</div>
<p>To use tascCODA, we first have to define a hierarchical ordering of the cell types. One possible hierarchical clustering uses the eight cell types and orders them by their similarity (pearson correlation) in the PCA representation with <code class="docutils literal notranslate"><span class="pre">sc.tl.dendrogram</span></code>.
Since this structure is very simple in our data and will therefore not give us many new insights, we want to have a more complex clustering. One recent method to get such clusters, is the <a class="reference external" href="https://github.com/dawe/schist">schist</a> package <span id="id16">[<a class="reference internal" href="#id352" title="Leonardo Morelli, Valentina Giansanti, and Davide Cittaro. Nested stochastic block models applied to the analysis of single cell data. BMC Bioinformatics, 22(1):576, November 2021. URL: http://dx.doi.org/10.1186/s12859-021-04489-7, doi:10.1186/s12859-021-04489-7.">Morelli <em>et al.</em>, 2021</a>]</span>, which uses a nested stochastic block model that clusters the cell population at different resolution levels. Running the method with standard settings takes some time (~15 minutes on our data), and gives us an assignment of each cell to a hierarchical clustering in <code class="docutils literal notranslate"><span class="pre">adata.obs</span></code>.
First, we need to define a distance measure between the cells through a PCA embedding:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># use logcounts to calculate PCA and neighbors</span>
<span class="n">adata</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="s2">&quot;counts&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">X</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">adata</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="s2">&quot;logcounts&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">pp</span><span class="o">.</span><span class="n">log1p</span><span class="p">(</span><span class="n">adata</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="s2">&quot;counts&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">adata</span><span class="o">.</span><span class="n">X</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="s2">&quot;logcounts&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">sc</span><span class="o">.</span><span class="n">pp</span><span class="o">.</span><span class="n">neighbors</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="n">n_neighbors</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">n_pcs</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">1234</span><span class="p">)</span>
<span class="n">sc</span><span class="o">.</span><span class="n">tl</span><span class="o">.</span><span class="n">umap</span><span class="p">(</span><span class="n">adata</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>WARNING: You’re trying to run this on 15215 dimensions of `.X`, if you really want this, set `use_rep=&#39;X&#39;`.
         Falling back to preprocessing with `sc.pp.pca` and default params.
</pre></div>
</div>
</div>
</div>
<p>Then, we can run schist on the AnnData object, which results in a clustering that is defined through a set of columns “nsbm_level_{i}” in <code class="docutils literal notranslate"><span class="pre">adata.obs</span></code>:</p>
<div class="cell tag_hide-output docutils container">
<div class="cell_input above-output-prompt docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">schist</span><span class="o">.</span><span class="n">inference</span><span class="o">.</span><span class="n">nested_model</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="n">samples</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">random_seed</span><span class="o">=</span><span class="mi">5678</span><span class="p">)</span>
<span class="n">adata</span><span class="o">.</span><span class="n">obs</span>
</pre></div>
</div>
</div>
<details class="hide below-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell output</span>
<span class="expanded">Hide code cell output</span>
</summary>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>objc[13409]: Class GNotificationCenterDelegate is implemented in both /opt/anaconda3/lib/libgio-2.0.0.dylib (0x12f0f1c30) and /usr/local/Cellar/glib/2.74.4/lib/libgio-2.0.0.dylib (0x1448ce6b0). One of the two will be used. Which one is undefined.
objc[13410]: Class GNotificationCenterDelegate is implemented in both /opt/anaconda3/lib/libgio-2.0.0.dylib (0x1265f3c30) and /usr/local/Cellar/glib/2.74.4/lib/libgio-2.0.0.dylib (0x13bdb76b0). One of the two will be used. Which one is undefined.
objc[13408]: Class GNotificationCenterDelegate is implemented in both /opt/anaconda3/lib/libgio-2.0.0.dylib (0x125a9ec30) and /usr/local/Cellar/glib/2.74.4/lib/libgio-2.0.0.dylib (0x13b1576b0). One of the two will be used. Which one is undefined.
objc[13411]: Class GNotificationCenterDelegate is implemented in both /opt/anaconda3/lib/libgio-2.0.0.dylib (0x129969c30) and /usr/local/Cellar/glib/2.74.4/lib/libgio-2.0.0.dylib (0x13f0d36b0). One of the two will be used. Which one is undefined.
objc[13407]: Class GNotificationCenterDelegate is implemented in both /opt/anaconda3/lib/libgio-2.0.0.dylib (0x127cb9c30) and /usr/local/Cellar/glib/2.74.4/lib/libgio-2.0.0.dylib (0x13d4106b0). One of the two will be used. Which one is undefined.
objc[13414]: Class GNotificationCenterDelegate is implemented in both /opt/anaconda3/lib/libgio-2.0.0.dylib (0x12ee9ac30) and /usr/local/Cellar/glib/2.74.4/lib/libgio-2.0.0.dylib (0x1446806b0). One of the two will be used. Which one is undefined.
Numba: Attempted to fork from a non-main thread, the TBB library may be in an invalid state in the child process.
Numba: Attempted to fork from a non-main thread, the TBB library may be in an invalid state in the child process.
objc[13490]: Class GNotificationCenterDelegate is implemented in both /opt/anaconda3/lib/libgio-2.0.0.dylib (0x124cf9c30) and /usr/local/Cellar/glib/2.74.4/lib/libgio-2.0.0.dylib (0x13a4136b0). One of the two will be used. Which one is undefined.
objc[13492]: Class GNotificationCenterDelegate is implemented in both /opt/anaconda3/lib/libgio-2.0.0.dylib (0x131710c30) and /usr/local/Cellar/glib/2.74.4/lib/libgio-2.0.0.dylib (0x146e806b0). One of the two will be used. Which one is undefined.
Numba: Attempted to fork from a non-main thread, the TBB library may be in an invalid state in the child process.
objc[13660]: Class GNotificationCenterDelegate is implemented in both /opt/anaconda3/lib/libgio-2.0.0.dylib (0x13455ec30) and /usr/local/Cellar/glib/2.74.4/lib/libgio-2.0.0.dylib (0x149c2f6b0). One of the two will be used. Which one is undefined.
Numba: Attempted to fork from a non-main thread, the TBB library may be in an invalid state in the child process.
objc[13699]: Class GNotificationCenterDelegate is implemented in both /opt/anaconda3/lib/libgio-2.0.0.dylib (0x131764c30) and /usr/local/Cellar/glib/2.74.4/lib/libgio-2.0.0.dylib (0x146ee86b0). One of the two will be used. Which one is undefined.
Numba: Attempted to fork from a non-main thread, the TBB library may be in an invalid state in the child process.
objc[13757]: Class GNotificationCenterDelegate is implemented in both /opt/anaconda3/lib/libgio-2.0.0.dylib (0x12ad09c30) and /usr/local/Cellar/glib/2.74.4/lib/libgio-2.0.0.dylib (0x1404af6b0). One of the two will be used. Which one is undefined.
Numba: Attempted to fork from a non-main thread, the TBB library may be in an invalid state in the child process.
objc[14239]: Class GNotificationCenterDelegate is implemented in both /opt/anaconda3/lib/libgio-2.0.0.dylib (0x1278c5c30) and /usr/local/Cellar/glib/2.74.4/lib/libgio-2.0.0.dylib (0x13d0326b0). One of the two will be used. Which one is undefined.
Numba: Attempted to fork from a non-main thread, the TBB library may be in an invalid state in the child process.
objc[14327]: Class GNotificationCenterDelegate is implemented in both /opt/anaconda3/lib/libgio-2.0.0.dylib (0x132a2ec30) and /usr/local/Cellar/glib/2.74.4/lib/libgio-2.0.0.dylib (0x1481d76b0). One of the two will be used. Which one is undefined.
Numba: Attempted to fork from a non-main thread, the TBB library may be in an invalid state in the child process.
Numba: Attempted to fork from a non-main thread, the TBB library may be in an invalid state in the child process.
objc[14348]: Class GNotificationCenterDelegate is implemented in both /opt/anaconda3/lib/libgio-2.0.0.dylib (0x1343f7c30) and /usr/local/Cellar/glib/2.74.4/lib/libgio-2.0.0.dylib (0x149ba86b0). One of the two will be used. Which one is undefined.
objc[14356]: Class GNotificationCenterDelegate is implemented in both /opt/anaconda3/lib/libgio-2.0.0.dylib (0x12f11cc30) and /usr/local/Cellar/glib/2.74.4/lib/libgio-2.0.0.dylib (0x1448ce6b0). One of the two will be used. Which one is undefined.
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>batch</th>
      <th>barcode</th>
      <th>condition</th>
      <th>cell_label</th>
      <th>scCODA_sample_id</th>
      <th>nsbm_level_0</th>
      <th>nsbm_level_1</th>
      <th>nsbm_level_2</th>
      <th>nsbm_level_3</th>
      <th>nsbm_level_4</th>
      <th>nsbm_level_5</th>
    </tr>
    <tr>
      <th>index</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>B1_AAACATACCACAAC_Control_Enterocyte.Progenitor</th>
      <td>B1</td>
      <td>AAACATACCACAAC</td>
      <td>Control</td>
      <td>Enterocyte.Progenitor</td>
      <td>B1</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>B1_AAACGCACGAGGAC_Control_Stem</th>
      <td>B1</td>
      <td>AAACGCACGAGGAC</td>
      <td>Control</td>
      <td>Stem</td>
      <td>B1</td>
      <td>1</td>
      <td>5</td>
      <td>3</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>B1_AAACGCACTAGCCA_Control_Stem</th>
      <td>B1</td>
      <td>AAACGCACTAGCCA</td>
      <td>Control</td>
      <td>Stem</td>
      <td>B1</td>
      <td>10</td>
      <td>2</td>
      <td>2</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>B1_AAACGCACTGTCCC_Control_Stem</th>
      <td>B1</td>
      <td>AAACGCACTGTCCC</td>
      <td>Control</td>
      <td>Stem</td>
      <td>B1</td>
      <td>34</td>
      <td>3</td>
      <td>3</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>B1_AAACTTGACCACCT_Control_Enterocyte.Progenitor</th>
      <td>B1</td>
      <td>AAACTTGACCACCT</td>
      <td>Control</td>
      <td>Enterocyte.Progenitor</td>
      <td>B1</td>
      <td>91</td>
      <td>35</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>B10_TTTCACGACAAGCT_Salmonella_TA</th>
      <td>B10</td>
      <td>TTTCACGACAAGCT</td>
      <td>Salmonella</td>
      <td>TA</td>
      <td>B10</td>
      <td>6</td>
      <td>5</td>
      <td>3</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>B10_TTTCAGTGAGGCGA_Salmonella_Enterocyte</th>
      <td>B10</td>
      <td>TTTCAGTGAGGCGA</td>
      <td>Salmonella</td>
      <td>Enterocyte</td>
      <td>B10</td>
      <td>142</td>
      <td>36</td>
      <td>4</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>B10_TTTCAGTGCGACAT_Salmonella_Stem</th>
      <td>B10</td>
      <td>TTTCAGTGCGACAT</td>
      <td>Salmonella</td>
      <td>Stem</td>
      <td>B10</td>
      <td>112</td>
      <td>1</td>
      <td>1</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>B10_TTTCAGTGTGACCA_Salmonella_Endocrine</th>
      <td>B10</td>
      <td>TTTCAGTGTGACCA</td>
      <td>Salmonella</td>
      <td>Endocrine</td>
      <td>B10</td>
      <td>146</td>
      <td>36</td>
      <td>4</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>B10_TTTCAGTGTTCTCA_Salmonella_Enterocyte.Progenitor</th>
      <td>B10</td>
      <td>TTTCAGTGTTCTCA</td>
      <td>Salmonella</td>
      <td>Enterocyte.Progenitor</td>
      <td>B10</td>
      <td>77</td>
      <td>14</td>
      <td>6</td>
      <td>3</td>
      <td>0</td>
      <td>0</td>
    </tr>
  </tbody>
</table>
<p>9842 rows × 11 columns</p>
</div></div></div>
</details>
</div>
<p>A UMAP plot nicely shows how the clustering from schist (here on levels 1 and 2) is connected to the cell type assignments. The representation on level 1 of the hierarchy is hereby a strict refinement of the level above, i.e. each cluster from level 2 is split into multiple smaller clusters:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sc</span><span class="o">.</span><span class="n">pl</span><span class="o">.</span><span class="n">umap</span><span class="p">(</span>
    <span class="n">adata</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;nsbm_level_1&quot;</span><span class="p">,</span> <span class="s2">&quot;nsbm_level_2&quot;</span><span class="p">,</span> <span class="s2">&quot;cell_label&quot;</span><span class="p">],</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">wspace</span><span class="o">=</span><span class="mf">0.5</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/e78fdb2eec0d4e60bd932338b280c420acf424425d834734c60e14663bb843fb.png" src="../_images/e78fdb2eec0d4e60bd932338b280c420acf424425d834734c60e14663bb843fb.png" />
</div>
</div>
<p>Now, we convert our cell-level data to sample-level data and create the tree. We create a tasccoda_model object in the same way as for scCODA, but with the clustering defined by schist and tree levels.</p>
<p>The load function of Tasccoda will prepare a MuData object and it converts our tree representation into a <a class="reference external" href="http://etetoolkit.org/">ete</a> tree structure and save it as <code class="docutils literal notranslate"><span class="pre">tasccoda_data['coda'].uns[&quot;tree&quot;]</span></code>. To get some clusters that are not too small, we cut the tree before the last level by leaving out <code class="docutils literal notranslate"><span class="pre">&quot;nsbm_level_0&quot;</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tasccoda_model</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">tl</span><span class="o">.</span><span class="n">Tasccoda</span><span class="p">()</span>
<span class="n">tasccoda_data</span> <span class="o">=</span> <span class="n">tasccoda_model</span><span class="o">.</span><span class="n">load</span><span class="p">(</span>
    <span class="n">adata</span><span class="p">,</span>
    <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;cell_level&quot;</span><span class="p">,</span>
    <span class="n">cell_type_identifier</span><span class="o">=</span><span class="s2">&quot;nsbm_level_1&quot;</span><span class="p">,</span>
    <span class="n">sample_identifier</span><span class="o">=</span><span class="s2">&quot;batch&quot;</span><span class="p">,</span>
    <span class="n">covariate_obs</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;condition&quot;</span><span class="p">],</span>
    <span class="n">levels_orig</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;nsbm_level_4&quot;</span><span class="p">,</span> <span class="s2">&quot;nsbm_level_3&quot;</span><span class="p">,</span> <span class="s2">&quot;nsbm_level_2&quot;</span><span class="p">,</span> <span class="s2">&quot;nsbm_level_1&quot;</span><span class="p">],</span>
    <span class="n">add_level_name</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">tasccoda_data</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><pre>MuData object with n_obs × n_vars = 9852 × 15256
  2 modalities
    rna:	9842 x 15215
      obs:	&#x27;batch&#x27;, &#x27;barcode&#x27;, &#x27;condition&#x27;, &#x27;cell_label&#x27;, &#x27;scCODA_sample_id&#x27;, &#x27;nsbm_level_0&#x27;, &#x27;nsbm_level_1&#x27;, &#x27;nsbm_level_2&#x27;, &#x27;nsbm_level_3&#x27;, &#x27;nsbm_level_4&#x27;, &#x27;nsbm_level_5&#x27;
      uns:	&#x27;neighbors&#x27;, &#x27;umap&#x27;, &#x27;schist&#x27;, &#x27;nsbm_level_1_colors&#x27;, &#x27;nsbm_level_2_colors&#x27;, &#x27;cell_label_colors&#x27;
      obsm:	&#x27;X_pca&#x27;, &#x27;X_umap&#x27;, &#x27;CM_nsbm_level_0&#x27;, &#x27;CM_nsbm_level_1&#x27;, &#x27;CM_nsbm_level_2&#x27;, &#x27;CM_nsbm_level_3&#x27;, &#x27;CM_nsbm_level_4&#x27;, &#x27;CM_nsbm_level_5&#x27;
      layers:	&#x27;counts&#x27;, &#x27;logcounts&#x27;
      obsp:	&#x27;distances&#x27;, &#x27;connectivities&#x27;
    coda:	10 x 41
      obs:	&#x27;condition&#x27;, &#x27;batch&#x27;
      var:	&#x27;n_cells&#x27;
      uns:	&#x27;tree&#x27;</pre></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tasccoda_model</span><span class="o">.</span><span class="n">plot_draw_tree</span><span class="p">(</span><span class="n">tasccoda_data</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/e07efa94dc3918a15b0cd67b482466b472a8f2d934c5bfd39d7ebc227e07add4.png" src="../_images/e07efa94dc3918a15b0cd67b482466b472a8f2d934c5bfd39d7ebc227e07add4.png" />
</div>
</div>
<p>The model setup and execution in tascCODA works analogous to scCODA, and also the free parameters for the reference and the formula are the same. Additionally, we can adjust the tree aggregation and model selection via the parameters <code class="docutils literal notranslate"><span class="pre">phi</span></code> and <code class="docutils literal notranslate"><span class="pre">lambda_1</span></code> in the <code class="docutils literal notranslate"><span class="pre">pen_args</span></code> argument (see <span id="id17">[<a class="reference internal" href="#id347" title="Johannes Ostner, Salomé Carcy, and Christian L. Müller. Tasccoda: bayesian tree-aggregated analysis of compositional amplicon and single-cell data. Frontiers in Genetics, 2021. URL: https://www.frontiersin.org/article/10.3389/fgene.2021.766405, doi:10.3389/fgene.2021.766405.">Ostner <em>et al.</em>, 2021</a>]</span> for more information). Here, we use an unbiased setting <code class="docutils literal notranslate"><span class="pre">phi=0</span></code> and a model selection that is slightly less strict than the default with <code class="docutils literal notranslate"><span class="pre">lambda_1=1.7</span></code>. We use cluster 18 as our reference, since it is almost identical to the set of Endocrine cells.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tasccoda_model</span><span class="o">.</span><span class="n">prepare</span><span class="p">(</span>
    <span class="n">tasccoda_data</span><span class="p">,</span>
    <span class="n">modality_key</span><span class="o">=</span><span class="s2">&quot;coda&quot;</span><span class="p">,</span>
    <span class="n">reference_cell_type</span><span class="o">=</span><span class="s2">&quot;18&quot;</span><span class="p">,</span>
    <span class="n">formula</span><span class="o">=</span><span class="s2">&quot;condition&quot;</span><span class="p">,</span>
    <span class="n">pen_args</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;phi&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;lambda_1&quot;</span><span class="p">:</span> <span class="mf">3.5</span><span class="p">},</span>
    <span class="n">tree_key</span><span class="o">=</span><span class="s2">&quot;tree&quot;</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace">Zero counts encountered in data! Added a pseudocount of <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.5</span>.
</pre>
</div><div class="output text_html"><pre>MuData object with n_obs × n_vars = 9852 × 15256
  2 modalities
    rna:	9842 x 15215
      obs:	&#x27;batch&#x27;, &#x27;barcode&#x27;, &#x27;condition&#x27;, &#x27;cell_label&#x27;, &#x27;scCODA_sample_id&#x27;, &#x27;nsbm_level_0&#x27;, &#x27;nsbm_level_1&#x27;, &#x27;nsbm_level_2&#x27;, &#x27;nsbm_level_3&#x27;, &#x27;nsbm_level_4&#x27;, &#x27;nsbm_level_5&#x27;
      uns:	&#x27;neighbors&#x27;, &#x27;umap&#x27;, &#x27;schist&#x27;, &#x27;nsbm_level_1_colors&#x27;, &#x27;nsbm_level_2_colors&#x27;, &#x27;cell_label_colors&#x27;
      obsm:	&#x27;X_pca&#x27;, &#x27;X_umap&#x27;, &#x27;CM_nsbm_level_0&#x27;, &#x27;CM_nsbm_level_1&#x27;, &#x27;CM_nsbm_level_2&#x27;, &#x27;CM_nsbm_level_3&#x27;, &#x27;CM_nsbm_level_4&#x27;, &#x27;CM_nsbm_level_5&#x27;
      layers:	&#x27;counts&#x27;, &#x27;logcounts&#x27;
      obsp:	&#x27;distances&#x27;, &#x27;connectivities&#x27;
    coda:	10 x 41
      obs:	&#x27;condition&#x27;, &#x27;batch&#x27;
      var:	&#x27;n_cells&#x27;
      uns:	&#x27;tree&#x27;, &#x27;scCODA_params&#x27;
      obsm:	&#x27;covariate_matrix&#x27;, &#x27;sample_counts&#x27;</pre></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tasccoda_model</span><span class="o">.</span><span class="n">run_nuts</span><span class="p">(</span>
    <span class="n">tasccoda_data</span><span class="p">,</span> <span class="n">modality_key</span><span class="o">=</span><span class="s2">&quot;coda&quot;</span><span class="p">,</span> <span class="n">rng_key</span><span class="o">=</span><span class="mi">1234</span><span class="p">,</span> <span class="n">num_samples</span><span class="o">=</span><span class="mi">10000</span><span class="p">,</span> <span class="n">num_warmup</span><span class="o">=</span><span class="mi">1000</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>sample: 100%|██████████| 11000/11000 [04:50&lt;00:00, 37.83it/s, 127 steps of size 3.18e-02. acc. prob=0.97]
</pre></div>
</div>
</div>
</div>
<div class="cell tag_hide-output docutils container">
<div class="cell_input above-output-prompt docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tasccoda_model</span><span class="o">.</span><span class="n">summary</span><span class="p">(</span><span class="n">tasccoda_data</span><span class="p">,</span> <span class="n">modality_key</span><span class="o">=</span><span class="s2">&quot;coda&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<details class="hide below-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell output</span>
<span class="expanded">Hide code cell output</span>
</summary>
<div class="cell_output docutils container">
<div class="output text_html"><pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="font-style: italic">                                          Compositional Analysis summary                                           </span>
┌────────────────────────────────────────────┬────────────────────────────────────────────────────────────────────┐
│<span style="font-weight: bold"> Name                                       </span>│<span style="font-weight: bold"> Value                                                              </span>│
├────────────────────────────────────────────┼────────────────────────────────────────────────────────────────────┤
│<span style="color: #008080; text-decoration-color: #008080"> Data                                       </span>│ Data: <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">10</span> samples, <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">41</span> cell types                                    │
│<span style="color: #008080; text-decoration-color: #008080"> Reference cell type                        </span>│ <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">18</span>                                                                 │
│<span style="color: #008080; text-decoration-color: #008080"> Formula                                    </span>│ condition                                                          │
└────────────────────────────────────────────┴────────────────────────────────────────────────────────────────────┘
</pre>
</div><div class="output text_html"><pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace">┌─────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
│<span style="font-weight: bold"> Intercepts                                                                                                      </span>│
├─────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
│            Final Parameter  Expected Sample                                                                     │
│ Cell Type                                                                                                       │
│ <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0</span>               <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">1.313</span>           <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">53.195</span>                                                                          │
│ <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">1</span>               <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">1.098</span>           <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">42.904</span>                                                                          │
│ <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">2</span>               <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">1.205</span>           <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">47.749</span>                                                                          │
│ <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">3</span>               <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.526</span>           <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">24.215</span>                                                                          │
│ <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">4</span>              <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">-0.707</span>            <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">7.057</span>                                                                          │
│ <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">5</span>               <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.634</span>           <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">26.976</span>                                                                          │
│ <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">6</span>              <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">-0.432</span>            <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">9.290</span>                                                                          │
│ <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">7</span>               <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">1.038</span>           <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">40.405</span>                                                                          │
│ <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">8</span>               <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">1.276</span>           <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">51.263</span>                                                                          │
│ <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">9</span>               <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">1.345</span>           <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">54.925</span>                                                                          │
│ <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">10</span>              <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.625</span>           <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">26.735</span>                                                                          │
│ <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">11</span>              <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.817</span>           <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">32.394</span>                                                                          │
│ <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">12</span>             <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">-0.359</span>            <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">9.994</span>                                                                          │
│ <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">13</span>              <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.260</span>           <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">18.559</span>                                                                          │
│ <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">14</span>              <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.851</span>           <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">33.514</span>                                                                          │
│ <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">15</span>              <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.524</span>           <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">24.166</span>                                                                          │
│ <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">16</span>              <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.934</span>           <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">36.414</span>                                                                          │
│ <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">17</span>             <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">-0.142</span>           <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">12.416</span>                                                                          │
│ <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">18</span>              <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.684</span>           <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">28.360</span>                                                                          │
│ <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">19</span>              <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.857</span>           <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">33.716</span>                                                                          │
│ <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">20</span>              <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.198</span>           <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">17.443</span>                                                                          │
│ <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">21</span>              <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.209</span>           <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">17.636</span>                                                                          │
│ <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">22</span>             <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">-0.159</span>           <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">12.206</span>                                                                          │
│ <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">23</span>              <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.913</span>           <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">35.658</span>                                                                          │
│ <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">24</span>              <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">1.190</span>           <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">47.038</span>                                                                          │
│ <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">25</span>              <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.057</span>           <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">15.149</span>                                                                          │
│ <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">26</span>             <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">-0.086</span>           <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">13.131</span>                                                                          │
│ <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">27</span>             <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">-0.002</span>           <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">14.281</span>                                                                          │
│ <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">28</span>              <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.786</span>           <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">31.405</span>                                                                          │
│ <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">29</span>             <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">-0.589</span>            <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">7.940</span>                                                                          │
│ <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">30</span>             <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">-0.713</span>            <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">7.014</span>                                                                          │
│ <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">31</span>              <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.210</span>           <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">17.654</span>                                                                          │
│ <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">32</span>             <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">-0.797</span>            <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">6.449</span>                                                                          │
│ <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">33</span>             <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">-0.806</span>            <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">6.391</span>                                                                          │
│ <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">34</span>             <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">-0.839</span>            <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">6.184</span>                                                                          │
│ <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">35</span>             <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">-0.104</span>           <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">12.897</span>                                                                          │
│ <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">36</span>              <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">1.443</span>           <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">60.580</span>                                                                          │
│ <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">37</span>              <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.215</span>           <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">17.742</span>                                                                          │
│ <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">38</span>             <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">-1.062</span>            <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">4.948</span>                                                                          │
│ <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">39</span>             <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">-0.879</span>            <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">5.942</span>                                                                          │
│ <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">40</span>              <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.084</span>           <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">15.564</span>                                                                          │
└─────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘
</pre>
</div><div class="output text_html"><pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace">┌─────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
│<span style="font-weight: bold"> Effects                                                                                                         </span>│
├─────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
│                                   Effect  Expected Sample  log2-fold change                                     │
│ Covariate              Cell Type                                                                                │
│ conditionT.Hpoly.Day3  <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0</span>           <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.000</span>      <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">51.027</span>            <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">-0.060</span>                                          │
│                        <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">1</span>           <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.000</span>      <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">41.155</span>            <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">-0.060</span>                                          │
│                        <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">2</span>          <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">-0.257</span>      <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">35.423</span>            <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">-0.431</span>                                          │
│                        <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">3</span>           <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.439</span>      <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">36.030</span>             <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.573</span>                                          │
│                        <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">4</span>           <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.000</span>       <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">6.769</span>            <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">-0.060</span>                                          │
│                        <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">5</span>           <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.439</span>      <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">40.139</span>             <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.573</span>                                          │
│                        <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">6</span>           <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.000</span>       <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">8.912</span>            <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">-0.060</span>                                          │
│                        <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">7</span>           <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.000</span>      <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">38.759</span>            <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">-0.060</span>                                          │
│                        <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">8</span>           <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.439</span>      <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">76.276</span>             <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.573</span>                                          │
│                        <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">9</span>          <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">-0.257</span>      <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">40.746</span>            <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">-0.431</span>                                          │
│                        <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">10</span>          <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.000</span>      <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">25.645</span>            <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">-0.060</span>                                          │
│                        <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">11</span>          <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.000</span>      <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">31.073</span>            <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">-0.060</span>                                          │
│                        <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">12</span>          <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.000</span>       <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">9.586</span>            <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">-0.060</span>                                          │
│                        <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">13</span>          <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.000</span>      <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">17.803</span>            <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">-0.060</span>                                          │
│                        <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">14</span>          <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.000</span>      <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">32.148</span>            <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">-0.060</span>                                          │
│                        <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">15</span>          <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.000</span>      <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">23.181</span>            <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">-0.060</span>                                          │
│                        <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">16</span>          <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.000</span>      <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">34.930</span>            <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">-0.060</span>                                          │
│                        <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">17</span>          <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.000</span>      <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">11.910</span>            <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">-0.060</span>                                          │
│                        <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">18</span>          <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.000</span>      <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">27.204</span>            <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">-0.060</span>                                          │
│                        <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">19</span>          <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.000</span>      <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">32.342</span>            <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">-0.060</span>                                          │
│                        <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">20</span>          <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.000</span>      <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">16.733</span>            <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">-0.060</span>                                          │
│                        <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">21</span>          <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.439</span>      <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">26.242</span>             <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.573</span>                                          │
│                        <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">22</span>          <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.000</span>      <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">11.709</span>            <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">-0.060</span>                                          │
│                        <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">23</span>         <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">-0.257</span>      <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">26.453</span>            <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">-0.431</span>                                          │
│                        <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">24</span>          <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.000</span>      <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">45.121</span>            <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">-0.060</span>                                          │
│                        <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">25</span>          <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.000</span>      <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">14.532</span>            <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">-0.060</span>                                          │
│                        <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">26</span>          <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.000</span>      <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">12.596</span>            <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">-0.060</span>                                          │
│                        <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">27</span>          <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.000</span>      <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">13.699</span>            <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">-0.060</span>                                          │
│                        <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">28</span>          <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.000</span>      <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">30.125</span>            <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">-0.060</span>                                          │
│                        <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">29</span>          <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.000</span>       <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">7.617</span>            <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">-0.060</span>                                          │
│                        <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">30</span>          <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.000</span>       <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">6.729</span>            <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">-0.060</span>                                          │
│                        <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">31</span>          <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.000</span>      <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">16.935</span>            <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">-0.060</span>                                          │
│                        <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">32</span>         <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">-0.257</span>       <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">4.784</span>            <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">-0.431</span>                                          │
│                        <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">33</span>          <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.000</span>       <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">6.131</span>            <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">-0.060</span>                                          │
│                        <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">34</span>          <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.000</span>       <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">5.932</span>            <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">-0.060</span>                                          │
│                        <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">35</span>          <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.000</span>      <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">12.371</span>            <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">-0.060</span>                                          │
│                        <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">36</span>          <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.000</span>      <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">58.111</span>            <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">-0.060</span>                                          │
│                        <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">37</span>          <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.000</span>      <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">17.019</span>            <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">-0.060</span>                                          │
│                        <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">38</span>          <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.000</span>       <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">4.746</span>            <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">-0.060</span>                                          │
│                        <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">39</span>          <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.000</span>       <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">5.699</span>            <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">-0.060</span>                                          │
│                        <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">40</span>          <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.439</span>      <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">23.158</span>             <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.573</span>                                          │
│ conditionT.Hpoly.Day10 <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0</span>          <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">-1.759</span>      <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">12.539</span>            <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">-2.085</span>                                          │
│                        <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">1</span>          <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">-0.786</span>      <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">26.759</span>            <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">-0.681</span>                                          │
│                        <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">2</span>          <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">-1.637</span>      <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">12.716</span>            <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">-1.909</span>                                          │
│                        <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">3</span>           <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.000</span>      <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">33.144</span>             <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.453</span>                                          │
│                        <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">4</span>           <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.373</span>      <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">14.025</span>             <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.991</span>                                          │
│                        <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">5</span>           <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.000</span>      <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">36.924</span>             <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.453</span>                                          │
│                        <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">6</span>           <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.000</span>      <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">12.716</span>             <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.453</span>                                          │
│                        <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">7</span>           <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.000</span>      <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">55.305</span>             <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.453</span>                                          │
│                        <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">8</span>           <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.000</span>      <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">70.166</span>             <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.453</span>                                          │
│                        <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">9</span>          <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">-1.637</span>      <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">14.627</span>            <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">-1.909</span>                                          │
│                        <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">10</span>          <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.000</span>      <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">36.593</span>             <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.453</span>                                          │
│                        <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">11</span>         <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">-0.242</span>      <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">34.808</span>             <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.104</span>                                          │
│                        <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">12</span>         <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">-0.242</span>      <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">10.739</span>             <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.104</span>                                          │
│                        <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">13</span>          <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.000</span>      <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">25.403</span>             <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.453</span>                                          │
│                        <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">14</span>         <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">-0.242</span>      <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">36.012</span>             <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.104</span>                                          │
│                        <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">15</span>         <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">-0.242</span>      <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">25.968</span>             <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.104</span>                                          │
│                        <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">16</span>          <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.000</span>      <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">49.842</span>             <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.453</span>                                          │
│                        <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">17</span>          <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.000</span>      <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">16.994</span>             <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.453</span>                                          │
│                        <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">18</span>          <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.000</span>      <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">38.817</span>             <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.453</span>                                          │
│                        <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">19</span>          <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.000</span>      <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">46.148</span>             <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.453</span>                                          │
│                        <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">20</span>         <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">-0.242</span>      <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">18.744</span>             <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.104</span>                                          │
│                        <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">21</span>          <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.000</span>      <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">24.140</span>             <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.453</span>                                          │
│                        <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">22</span>         <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">-0.242</span>      <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">13.116</span>             <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.104</span>                                          │
│                        <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">23</span>         <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">-1.637</span>       <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">9.496</span>            <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">-1.909</span>                                          │
│                        <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">24</span>         <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">-1.597</span>      <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">13.038</span>            <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">-1.851</span>                                          │
│                        <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">25</span>          <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.000</span>      <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">20.736</span>             <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.453</span>                                          │
│                        <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">26</span>         <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">-0.242</span>      <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">14.110</span>             <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.104</span>                                          │
│                        <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">27</span>          <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.000</span>      <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">19.548</span>             <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.453</span>                                          │
│                        <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">28</span>         <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">-0.242</span>      <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">33.746</span>             <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.104</span>                                          │
│                        <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">29</span>          <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.000</span>      <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">10.868</span>             <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.453</span>                                          │
│                        <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">30</span>          <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.000</span>       <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">9.601</span>             <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.453</span>                                          │
│                        <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">31</span>          <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.000</span>      <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">24.164</span>             <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.453</span>                                          │
│                        <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">32</span>          <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">1.217</span>      <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">29.810</span>             <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">2.209</span>                                          │
│                        <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">33</span>          <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.564</span>      <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">15.377</span>             <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">1.267</span>                                          │
│                        <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">34</span>          <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">1.186</span>      <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">27.712</span>             <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">2.164</span>                                          │
│                        <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">35</span>          <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.000</span>      <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">17.652</span>             <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.453</span>                                          │
│                        <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">36</span>         <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">-1.716</span>      <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">14.907</span>            <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">-2.023</span>                                          │
│                        <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">37</span>          <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.000</span>      <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">24.285</span>             <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.453</span>                                          │
│                        <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">38</span>          <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.000</span>       <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">6.772</span>             <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.453</span>                                          │
│                        <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">39</span>          <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.000</span>       <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">8.132</span>             <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.453</span>                                          │
│                        <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">40</span>          <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.000</span>      <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">21.303</span>             <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.453</span>                                          │
│ conditionT.Salmonella  <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0</span>           <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.000</span>      <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">34.663</span>            <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">-0.618</span>                                          │
│                        <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">1</span>           <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.000</span>      <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">27.957</span>            <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">-0.618</span>                                          │
│                        <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">2</span>           <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.000</span>      <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">31.114</span>            <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">-0.618</span>                                          │
│                        <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">3</span>           <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.000</span>      <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">15.779</span>            <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">-0.618</span>                                          │
│                        <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">4</span>           <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.000</span>       <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">4.598</span>            <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">-0.618</span>                                          │
│                        <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">5</span>           <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.000</span>      <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">17.578</span>            <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">-0.618</span>                                          │
│                        <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">6</span>           <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.000</span>       <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">6.054</span>            <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">-0.618</span>                                          │
│                        <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">7</span>           <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.000</span>      <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">26.329</span>            <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">-0.618</span>                                          │
│                        <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">8</span>           <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.000</span>      <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">33.404</span>            <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">-0.618</span>                                          │
│                        <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">9</span>           <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.213</span>      <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">44.286</span>            <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">-0.311</span>                                          │
│                        <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">10</span>          <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.000</span>      <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">17.421</span>            <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">-0.618</span>                                          │
│                        <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">11</span>          <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.000</span>      <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">21.108</span>            <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">-0.618</span>                                          │
│                        <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">12</span>          <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.000</span>       <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">6.512</span>            <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">-0.618</span>                                          │
│                        <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">13</span>          <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.000</span>      <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">12.094</span>            <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">-0.618</span>                                          │
│                        <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">14</span>          <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">2.173</span>     <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">191.842</span>             <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">2.517</span>                                          │
│                        <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">15</span>          <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">1.547</span>      <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">73.971</span>             <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">1.614</span>                                          │
│                        <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">16</span>          <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.000</span>      <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">23.728</span>            <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">-0.618</span>                                          │
│                        <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">17</span>          <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.000</span>       <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">8.090</span>            <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">-0.618</span>                                          │
│                        <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">18</span>          <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.000</span>      <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">18.480</span>            <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">-0.618</span>                                          │
│                        <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">19</span>          <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.000</span>      <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">21.970</span>            <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">-0.618</span>                                          │
│                        <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">20</span>          <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.000</span>      <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">11.367</span>            <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">-0.618</span>                                          │
│                        <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">21</span>          <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.000</span>      <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">11.492</span>            <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">-0.618</span>                                          │
│                        <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">22</span>          <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.000</span>       <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">7.954</span>            <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">-0.618</span>                                          │
│                        <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">23</span>          <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.000</span>      <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">23.235</span>            <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">-0.618</span>                                          │
│                        <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">24</span>          <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.000</span>      <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">30.651</span>            <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">-0.618</span>                                          │
│                        <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">25</span>          <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.000</span>       <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">9.872</span>            <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">-0.618</span>                                          │
│                        <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">26</span>          <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">1.547</span>      <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">40.192</span>             <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">1.614</span>                                          │
│                        <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">27</span>          <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.000</span>       <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">9.306</span>            <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">-0.618</span>                                          │
│                        <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">28</span>          <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">1.547</span>      <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">96.127</span>             <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">1.614</span>                                          │
│                        <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">29</span>          <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.000</span>       <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">5.174</span>            <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">-0.618</span>                                          │
│                        <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">30</span>          <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.000</span>       <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">4.571</span>            <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">-0.618</span>                                          │
│                        <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">31</span>          <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.000</span>      <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">11.504</span>            <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">-0.618</span>                                          │
│                        <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">32</span>          <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.000</span>       <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">4.202</span>            <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">-0.618</span>                                          │
│                        <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">33</span>          <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.000</span>       <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">4.165</span>            <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">-0.618</span>                                          │
│                        <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">34</span>          <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.000</span>       <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">4.030</span>            <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">-0.618</span>                                          │
│                        <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">35</span>          <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.000</span>       <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">8.404</span>            <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">-0.618</span>                                          │
│                        <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">36</span>          <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.000</span>      <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">39.475</span>            <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">-0.618</span>                                          │
│                        <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">37</span>          <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.000</span>      <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">11.561</span>            <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">-0.618</span>                                          │
│                        <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">38</span>          <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.000</span>       <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">3.224</span>            <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">-0.618</span>                                          │
│                        <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">39</span>          <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.000</span>       <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">3.872</span>            <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">-0.618</span>                                          │
│                        <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">40</span>          <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.000</span>      <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">10.142</span>            <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">-0.618</span>                                          │
└─────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘
</pre>
</div><div class="output text_html"><pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace">┌─────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
│<span style="font-weight: bold"> Nodes                                                                                                           </span>│
├─────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
│ <span style="color: #808000; text-decoration-color: #808000">Covariate</span>=<span style="color: #800080; text-decoration-color: #800080">condition</span><span style="font-weight: bold">[</span>T.Hpoly.Day10<span style="font-weight: bold">]</span>_node                                                                         │
├─────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
│                  Final Parameter  Is credible                                                                   │
│ Node                                                                                                            │
│ nsbm_level_4_0        <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.00</span>           <span style="color: #ff0000; text-decoration-color: #ff0000; font-style: italic">False</span>                                                                      │
│ nsbm_level_3_2        <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.00</span>           <span style="color: #ff0000; text-decoration-color: #ff0000; font-style: italic">False</span>                                                                      │
│ nsbm_level_3_0        <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.00</span>           <span style="color: #ff0000; text-decoration-color: #ff0000; font-style: italic">False</span>                                                                      │
│ nsbm_level_3_1        <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.00</span>           <span style="color: #ff0000; text-decoration-color: #ff0000; font-style: italic">False</span>                                                                      │
│ nsbm_level_3_3       <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">-0.24</span>            <span style="color: #00ff00; text-decoration-color: #00ff00; font-style: italic">True</span>                                                                      │
│ nsbm_level_2_8        <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.00</span>           <span style="color: #ff0000; text-decoration-color: #ff0000; font-style: italic">False</span>                                                                      │
│ nsbm_level_2_10       <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.00</span>           <span style="color: #ff0000; text-decoration-color: #ff0000; font-style: italic">False</span>                                                                      │
│ <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">10</span>                    <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.00</span>           <span style="color: #ff0000; text-decoration-color: #ff0000; font-style: italic">False</span>                                                                      │
│ <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">31</span>                    <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.00</span>           <span style="color: #ff0000; text-decoration-color: #ff0000; font-style: italic">False</span>                                                                      │
│ nsbm_level_2_0        <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.00</span>           <span style="color: #ff0000; text-decoration-color: #ff0000; font-style: italic">False</span>                                                                      │
│ nsbm_level_2_7        <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.00</span>           <span style="color: #ff0000; text-decoration-color: #ff0000; font-style: italic">False</span>                                                                      │
│ nsbm_level_2_11       <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.00</span>           <span style="color: #ff0000; text-decoration-color: #ff0000; font-style: italic">False</span>                                                                      │
│ nsbm_level_2_3        <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.00</span>           <span style="color: #ff0000; text-decoration-color: #ff0000; font-style: italic">False</span>                                                                      │
│ nsbm_level_2_2       <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">-1.64</span>            <span style="color: #00ff00; text-decoration-color: #00ff00; font-style: italic">True</span>                                                                      │
│ nsbm_level_2_13       <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.00</span>           <span style="color: #ff0000; text-decoration-color: #ff0000; font-style: italic">False</span>                                                                      │
│ nsbm_level_2_1        <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.00</span>           <span style="color: #ff0000; text-decoration-color: #ff0000; font-style: italic">False</span>                                                                      │
│ nsbm_level_2_4        <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.00</span>           <span style="color: #ff0000; text-decoration-color: #ff0000; font-style: italic">False</span>                                                                      │
│ nsbm_level_2_6        <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.00</span>           <span style="color: #ff0000; text-decoration-color: #ff0000; font-style: italic">False</span>                                                                      │
│ nsbm_level_2_14       <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.00</span>           <span style="color: #ff0000; text-decoration-color: #ff0000; font-style: italic">False</span>                                                                      │
│ <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">11</span>                    <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.00</span>           <span style="color: #ff0000; text-decoration-color: #ff0000; font-style: italic">False</span>                                                                      │
│ <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">16</span>                    <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.00</span>           <span style="color: #ff0000; text-decoration-color: #ff0000; font-style: italic">False</span>                                                                      │
│ <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">37</span>                    <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.00</span>           <span style="color: #ff0000; text-decoration-color: #ff0000; font-style: italic">False</span>                                                                      │
│ <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">19</span>                    <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.00</span>           <span style="color: #ff0000; text-decoration-color: #ff0000; font-style: italic">False</span>                                                                      │
│ <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">27</span>                    <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.00</span>           <span style="color: #ff0000; text-decoration-color: #ff0000; font-style: italic">False</span>                                                                      │
│ <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">30</span>                    <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.00</span>           <span style="color: #ff0000; text-decoration-color: #ff0000; font-style: italic">False</span>                                                                      │
│ <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0</span>                    <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">-1.76</span>            <span style="color: #00ff00; text-decoration-color: #00ff00; font-style: italic">True</span>                                                                      │
│ <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">35</span>                    <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.00</span>           <span style="color: #ff0000; text-decoration-color: #ff0000; font-style: italic">False</span>                                                                      │
│ <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">17</span>                    <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.00</span>           <span style="color: #ff0000; text-decoration-color: #ff0000; font-style: italic">False</span>                                                                      │
│ <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">4</span>                     <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.37</span>            <span style="color: #00ff00; text-decoration-color: #00ff00; font-style: italic">True</span>                                                                      │
│ <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">25</span>                    <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.00</span>           <span style="color: #ff0000; text-decoration-color: #ff0000; font-style: italic">False</span>                                                                      │
│ <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">13</span>                    <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.00</span>           <span style="color: #ff0000; text-decoration-color: #ff0000; font-style: italic">False</span>                                                                      │
│ <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">29</span>                    <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.00</span>           <span style="color: #ff0000; text-decoration-color: #ff0000; font-style: italic">False</span>                                                                      │
│ <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">38</span>                    <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.00</span>           <span style="color: #ff0000; text-decoration-color: #ff0000; font-style: italic">False</span>                                                                      │
│ <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">5</span>                     <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.00</span>           <span style="color: #ff0000; text-decoration-color: #ff0000; font-style: italic">False</span>                                                                      │
│ <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">3</span>                     <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.00</span>           <span style="color: #ff0000; text-decoration-color: #ff0000; font-style: italic">False</span>                                                                      │
│ <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">8</span>                     <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.00</span>           <span style="color: #ff0000; text-decoration-color: #ff0000; font-style: italic">False</span>                                                                      │
│ <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">40</span>                    <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.00</span>           <span style="color: #ff0000; text-decoration-color: #ff0000; font-style: italic">False</span>                                                                      │
│ <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">21</span>                    <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.00</span>           <span style="color: #ff0000; text-decoration-color: #ff0000; font-style: italic">False</span>                                                                      │
│ <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">2</span>                     <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.00</span>           <span style="color: #ff0000; text-decoration-color: #ff0000; font-style: italic">False</span>                                                                      │
│ <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">23</span>                    <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.00</span>           <span style="color: #ff0000; text-decoration-color: #ff0000; font-style: italic">False</span>                                                                      │
│ <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">9</span>                     <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.00</span>           <span style="color: #ff0000; text-decoration-color: #ff0000; font-style: italic">False</span>                                                                      │
│ <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">32</span>                    <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">2.85</span>            <span style="color: #00ff00; text-decoration-color: #00ff00; font-style: italic">True</span>                                                                      │
│ <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">6</span>                     <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.00</span>           <span style="color: #ff0000; text-decoration-color: #ff0000; font-style: italic">False</span>                                                                      │
│ <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">34</span>                    <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">1.19</span>            <span style="color: #00ff00; text-decoration-color: #00ff00; font-style: italic">True</span>                                                                      │
│ <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">7</span>                     <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.00</span>           <span style="color: #ff0000; text-decoration-color: #ff0000; font-style: italic">False</span>                                                                      │
│ <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">1</span>                    <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">-0.79</span>            <span style="color: #00ff00; text-decoration-color: #00ff00; font-style: italic">True</span>                                                                      │
│ <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">24</span>                   <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">-1.60</span>            <span style="color: #00ff00; text-decoration-color: #00ff00; font-style: italic">True</span>                                                                      │
│ <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">18</span>                    <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.00</span>           <span style="color: #ff0000; text-decoration-color: #ff0000; font-style: italic">False</span>                                                                      │
│ <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">36</span>                   <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">-1.72</span>            <span style="color: #00ff00; text-decoration-color: #00ff00; font-style: italic">True</span>                                                                      │
│ <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">33</span>                    <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.56</span>            <span style="color: #00ff00; text-decoration-color: #00ff00; font-style: italic">True</span>                                                                      │
│ <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">39</span>                    <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.00</span>           <span style="color: #ff0000; text-decoration-color: #ff0000; font-style: italic">False</span>                                                                      │
│ <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">26</span>                    <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.00</span>           <span style="color: #ff0000; text-decoration-color: #ff0000; font-style: italic">False</span>                                                                      │
│ <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">14</span>                    <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.00</span>           <span style="color: #ff0000; text-decoration-color: #ff0000; font-style: italic">False</span>                                                                      │
│ <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">28</span>                    <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.00</span>           <span style="color: #ff0000; text-decoration-color: #ff0000; font-style: italic">False</span>                                                                      │
│ <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">15</span>                    <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.00</span>           <span style="color: #ff0000; text-decoration-color: #ff0000; font-style: italic">False</span>                                                                      │
│ <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">12</span>                    <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.00</span>           <span style="color: #ff0000; text-decoration-color: #ff0000; font-style: italic">False</span>                                                                      │
│ <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">20</span>                    <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.00</span>           <span style="color: #ff0000; text-decoration-color: #ff0000; font-style: italic">False</span>                                                                      │
│ <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">22</span>                    <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.00</span>           <span style="color: #ff0000; text-decoration-color: #ff0000; font-style: italic">False</span>                                                                      │
├─────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
│ <span style="color: #808000; text-decoration-color: #808000">Covariate</span>=<span style="color: #800080; text-decoration-color: #800080">condition</span><span style="font-weight: bold">[</span>T.Hpoly.Day3<span style="font-weight: bold">]</span>_node                                                                          │
├─────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
│                  Final Parameter  Is credible                                                                   │
│ Node                                                                                                            │
│ nsbm_level_4_0        <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.00</span>           <span style="color: #ff0000; text-decoration-color: #ff0000; font-style: italic">False</span>                                                                      │
│ nsbm_level_3_2        <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.00</span>           <span style="color: #ff0000; text-decoration-color: #ff0000; font-style: italic">False</span>                                                                      │
│ nsbm_level_3_0        <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.00</span>           <span style="color: #ff0000; text-decoration-color: #ff0000; font-style: italic">False</span>                                                                      │
│ nsbm_level_3_1        <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.00</span>           <span style="color: #ff0000; text-decoration-color: #ff0000; font-style: italic">False</span>                                                                      │
│ nsbm_level_3_3        <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.00</span>           <span style="color: #ff0000; text-decoration-color: #ff0000; font-style: italic">False</span>                                                                      │
│ nsbm_level_2_8        <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.00</span>           <span style="color: #ff0000; text-decoration-color: #ff0000; font-style: italic">False</span>                                                                      │
│ nsbm_level_2_10       <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.00</span>           <span style="color: #ff0000; text-decoration-color: #ff0000; font-style: italic">False</span>                                                                      │
│ <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">10</span>                    <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.00</span>           <span style="color: #ff0000; text-decoration-color: #ff0000; font-style: italic">False</span>                                                                      │
│ <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">31</span>                    <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.00</span>           <span style="color: #ff0000; text-decoration-color: #ff0000; font-style: italic">False</span>                                                                      │
│ nsbm_level_2_0        <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.00</span>           <span style="color: #ff0000; text-decoration-color: #ff0000; font-style: italic">False</span>                                                                      │
│ nsbm_level_2_7        <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.00</span>           <span style="color: #ff0000; text-decoration-color: #ff0000; font-style: italic">False</span>                                                                      │
│ nsbm_level_2_11       <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.00</span>           <span style="color: #ff0000; text-decoration-color: #ff0000; font-style: italic">False</span>                                                                      │
│ nsbm_level_2_3        <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.44</span>            <span style="color: #00ff00; text-decoration-color: #00ff00; font-style: italic">True</span>                                                                      │
│ nsbm_level_2_2       <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">-0.26</span>            <span style="color: #00ff00; text-decoration-color: #00ff00; font-style: italic">True</span>                                                                      │
│ nsbm_level_2_13       <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.00</span>           <span style="color: #ff0000; text-decoration-color: #ff0000; font-style: italic">False</span>                                                                      │
│ nsbm_level_2_1        <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.00</span>           <span style="color: #ff0000; text-decoration-color: #ff0000; font-style: italic">False</span>                                                                      │
│ nsbm_level_2_4        <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.00</span>           <span style="color: #ff0000; text-decoration-color: #ff0000; font-style: italic">False</span>                                                                      │
│ nsbm_level_2_6        <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.00</span>           <span style="color: #ff0000; text-decoration-color: #ff0000; font-style: italic">False</span>                                                                      │
│ nsbm_level_2_14       <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.00</span>           <span style="color: #ff0000; text-decoration-color: #ff0000; font-style: italic">False</span>                                                                      │
│ <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">11</span>                    <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.00</span>           <span style="color: #ff0000; text-decoration-color: #ff0000; font-style: italic">False</span>                                                                      │
│ <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">16</span>                    <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.00</span>           <span style="color: #ff0000; text-decoration-color: #ff0000; font-style: italic">False</span>                                                                      │
│ <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">37</span>                    <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.00</span>           <span style="color: #ff0000; text-decoration-color: #ff0000; font-style: italic">False</span>                                                                      │
│ <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">19</span>                    <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.00</span>           <span style="color: #ff0000; text-decoration-color: #ff0000; font-style: italic">False</span>                                                                      │
│ <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">27</span>                    <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.00</span>           <span style="color: #ff0000; text-decoration-color: #ff0000; font-style: italic">False</span>                                                                      │
│ <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">30</span>                    <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.00</span>           <span style="color: #ff0000; text-decoration-color: #ff0000; font-style: italic">False</span>                                                                      │
│ <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0</span>                     <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.00</span>           <span style="color: #ff0000; text-decoration-color: #ff0000; font-style: italic">False</span>                                                                      │
│ <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">35</span>                    <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.00</span>           <span style="color: #ff0000; text-decoration-color: #ff0000; font-style: italic">False</span>                                                                      │
│ <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">17</span>                    <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.00</span>           <span style="color: #ff0000; text-decoration-color: #ff0000; font-style: italic">False</span>                                                                      │
│ <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">4</span>                     <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.00</span>           <span style="color: #ff0000; text-decoration-color: #ff0000; font-style: italic">False</span>                                                                      │
│ <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">25</span>                    <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.00</span>           <span style="color: #ff0000; text-decoration-color: #ff0000; font-style: italic">False</span>                                                                      │
│ <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">13</span>                    <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.00</span>           <span style="color: #ff0000; text-decoration-color: #ff0000; font-style: italic">False</span>                                                                      │
│ <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">29</span>                    <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.00</span>           <span style="color: #ff0000; text-decoration-color: #ff0000; font-style: italic">False</span>                                                                      │
│ <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">38</span>                    <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.00</span>           <span style="color: #ff0000; text-decoration-color: #ff0000; font-style: italic">False</span>                                                                      │
│ <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">5</span>                     <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.00</span>           <span style="color: #ff0000; text-decoration-color: #ff0000; font-style: italic">False</span>                                                                      │
│ <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">3</span>                     <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.00</span>           <span style="color: #ff0000; text-decoration-color: #ff0000; font-style: italic">False</span>                                                                      │
│ <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">8</span>                     <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.00</span>           <span style="color: #ff0000; text-decoration-color: #ff0000; font-style: italic">False</span>                                                                      │
│ <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">40</span>                    <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.00</span>           <span style="color: #ff0000; text-decoration-color: #ff0000; font-style: italic">False</span>                                                                      │
│ <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">21</span>                    <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.00</span>           <span style="color: #ff0000; text-decoration-color: #ff0000; font-style: italic">False</span>                                                                      │
│ <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">2</span>                     <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.00</span>           <span style="color: #ff0000; text-decoration-color: #ff0000; font-style: italic">False</span>                                                                      │
│ <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">23</span>                    <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.00</span>           <span style="color: #ff0000; text-decoration-color: #ff0000; font-style: italic">False</span>                                                                      │
│ <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">9</span>                     <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.00</span>           <span style="color: #ff0000; text-decoration-color: #ff0000; font-style: italic">False</span>                                                                      │
│ <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">32</span>                    <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.00</span>           <span style="color: #ff0000; text-decoration-color: #ff0000; font-style: italic">False</span>                                                                      │
│ <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">6</span>                     <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.00</span>           <span style="color: #ff0000; text-decoration-color: #ff0000; font-style: italic">False</span>                                                                      │
│ <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">34</span>                    <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.00</span>           <span style="color: #ff0000; text-decoration-color: #ff0000; font-style: italic">False</span>                                                                      │
│ <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">7</span>                     <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.00</span>           <span style="color: #ff0000; text-decoration-color: #ff0000; font-style: italic">False</span>                                                                      │
│ <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">1</span>                     <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.00</span>           <span style="color: #ff0000; text-decoration-color: #ff0000; font-style: italic">False</span>                                                                      │
│ <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">24</span>                    <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.00</span>           <span style="color: #ff0000; text-decoration-color: #ff0000; font-style: italic">False</span>                                                                      │
│ <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">18</span>                    <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.00</span>           <span style="color: #ff0000; text-decoration-color: #ff0000; font-style: italic">False</span>                                                                      │
│ <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">36</span>                    <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.00</span>           <span style="color: #ff0000; text-decoration-color: #ff0000; font-style: italic">False</span>                                                                      │
│ <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">33</span>                    <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.00</span>           <span style="color: #ff0000; text-decoration-color: #ff0000; font-style: italic">False</span>                                                                      │
│ <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">39</span>                    <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.00</span>           <span style="color: #ff0000; text-decoration-color: #ff0000; font-style: italic">False</span>                                                                      │
│ <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">26</span>                    <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.00</span>           <span style="color: #ff0000; text-decoration-color: #ff0000; font-style: italic">False</span>                                                                      │
│ <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">14</span>                    <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.00</span>           <span style="color: #ff0000; text-decoration-color: #ff0000; font-style: italic">False</span>                                                                      │
│ <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">28</span>                    <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.00</span>           <span style="color: #ff0000; text-decoration-color: #ff0000; font-style: italic">False</span>                                                                      │
│ <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">15</span>                    <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.00</span>           <span style="color: #ff0000; text-decoration-color: #ff0000; font-style: italic">False</span>                                                                      │
│ <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">12</span>                    <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.00</span>           <span style="color: #ff0000; text-decoration-color: #ff0000; font-style: italic">False</span>                                                                      │
│ <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">20</span>                    <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.00</span>           <span style="color: #ff0000; text-decoration-color: #ff0000; font-style: italic">False</span>                                                                      │
│ <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">22</span>                    <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.00</span>           <span style="color: #ff0000; text-decoration-color: #ff0000; font-style: italic">False</span>                                                                      │
├─────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
│ <span style="color: #808000; text-decoration-color: #808000">Covariate</span>=<span style="color: #800080; text-decoration-color: #800080">condition</span><span style="font-weight: bold">[</span>T.Salmonella<span style="font-weight: bold">]</span>_node                                                                          │
├─────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
│                  Final Parameter  Is credible                                                                   │
│ Node                                                                                                            │
│ nsbm_level_4_0        <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.00</span>           <span style="color: #ff0000; text-decoration-color: #ff0000; font-style: italic">False</span>                                                                      │
│ nsbm_level_3_2        <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.00</span>           <span style="color: #ff0000; text-decoration-color: #ff0000; font-style: italic">False</span>                                                                      │
│ nsbm_level_3_0        <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.00</span>           <span style="color: #ff0000; text-decoration-color: #ff0000; font-style: italic">False</span>                                                                      │
│ nsbm_level_3_1        <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.00</span>           <span style="color: #ff0000; text-decoration-color: #ff0000; font-style: italic">False</span>                                                                      │
│ nsbm_level_3_3        <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.00</span>           <span style="color: #ff0000; text-decoration-color: #ff0000; font-style: italic">False</span>                                                                      │
│ nsbm_level_2_8        <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.00</span>           <span style="color: #ff0000; text-decoration-color: #ff0000; font-style: italic">False</span>                                                                      │
│ nsbm_level_2_10       <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.00</span>           <span style="color: #ff0000; text-decoration-color: #ff0000; font-style: italic">False</span>                                                                      │
│ <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">10</span>                    <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.00</span>           <span style="color: #ff0000; text-decoration-color: #ff0000; font-style: italic">False</span>                                                                      │
│ <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">31</span>                    <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.00</span>           <span style="color: #ff0000; text-decoration-color: #ff0000; font-style: italic">False</span>                                                                      │
│ nsbm_level_2_0        <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.00</span>           <span style="color: #ff0000; text-decoration-color: #ff0000; font-style: italic">False</span>                                                                      │
│ nsbm_level_2_7        <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.00</span>           <span style="color: #ff0000; text-decoration-color: #ff0000; font-style: italic">False</span>                                                                      │
│ nsbm_level_2_11       <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.00</span>           <span style="color: #ff0000; text-decoration-color: #ff0000; font-style: italic">False</span>                                                                      │
│ nsbm_level_2_3        <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.00</span>           <span style="color: #ff0000; text-decoration-color: #ff0000; font-style: italic">False</span>                                                                      │
│ nsbm_level_2_2        <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.00</span>           <span style="color: #ff0000; text-decoration-color: #ff0000; font-style: italic">False</span>                                                                      │
│ nsbm_level_2_13       <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.00</span>           <span style="color: #ff0000; text-decoration-color: #ff0000; font-style: italic">False</span>                                                                      │
│ nsbm_level_2_1        <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.00</span>           <span style="color: #ff0000; text-decoration-color: #ff0000; font-style: italic">False</span>                                                                      │
│ nsbm_level_2_4        <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.00</span>           <span style="color: #ff0000; text-decoration-color: #ff0000; font-style: italic">False</span>                                                                      │
│ nsbm_level_2_6        <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">1.55</span>            <span style="color: #00ff00; text-decoration-color: #00ff00; font-style: italic">True</span>                                                                      │
│ nsbm_level_2_14       <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.00</span>           <span style="color: #ff0000; text-decoration-color: #ff0000; font-style: italic">False</span>                                                                      │
│ <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">11</span>                    <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.00</span>           <span style="color: #ff0000; text-decoration-color: #ff0000; font-style: italic">False</span>                                                                      │
│ <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">16</span>                    <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.00</span>           <span style="color: #ff0000; text-decoration-color: #ff0000; font-style: italic">False</span>                                                                      │
│ <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">37</span>                    <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.00</span>           <span style="color: #ff0000; text-decoration-color: #ff0000; font-style: italic">False</span>                                                                      │
│ <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">19</span>                    <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.00</span>           <span style="color: #ff0000; text-decoration-color: #ff0000; font-style: italic">False</span>                                                                      │
│ <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">27</span>                    <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.00</span>           <span style="color: #ff0000; text-decoration-color: #ff0000; font-style: italic">False</span>                                                                      │
│ <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">30</span>                    <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.00</span>           <span style="color: #ff0000; text-decoration-color: #ff0000; font-style: italic">False</span>                                                                      │
│ <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0</span>                     <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.00</span>           <span style="color: #ff0000; text-decoration-color: #ff0000; font-style: italic">False</span>                                                                      │
│ <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">35</span>                    <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.00</span>           <span style="color: #ff0000; text-decoration-color: #ff0000; font-style: italic">False</span>                                                                      │
│ <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">17</span>                    <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.00</span>           <span style="color: #ff0000; text-decoration-color: #ff0000; font-style: italic">False</span>                                                                      │
│ <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">4</span>                     <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.00</span>           <span style="color: #ff0000; text-decoration-color: #ff0000; font-style: italic">False</span>                                                                      │
│ <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">25</span>                    <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.00</span>           <span style="color: #ff0000; text-decoration-color: #ff0000; font-style: italic">False</span>                                                                      │
│ <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">13</span>                    <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.00</span>           <span style="color: #ff0000; text-decoration-color: #ff0000; font-style: italic">False</span>                                                                      │
│ <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">29</span>                    <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.00</span>           <span style="color: #ff0000; text-decoration-color: #ff0000; font-style: italic">False</span>                                                                      │
│ <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">38</span>                    <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.00</span>           <span style="color: #ff0000; text-decoration-color: #ff0000; font-style: italic">False</span>                                                                      │
│ <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">5</span>                     <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.00</span>           <span style="color: #ff0000; text-decoration-color: #ff0000; font-style: italic">False</span>                                                                      │
│ <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">3</span>                     <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.00</span>           <span style="color: #ff0000; text-decoration-color: #ff0000; font-style: italic">False</span>                                                                      │
│ <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">8</span>                     <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.00</span>           <span style="color: #ff0000; text-decoration-color: #ff0000; font-style: italic">False</span>                                                                      │
│ <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">40</span>                    <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.00</span>           <span style="color: #ff0000; text-decoration-color: #ff0000; font-style: italic">False</span>                                                                      │
│ <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">21</span>                    <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.00</span>           <span style="color: #ff0000; text-decoration-color: #ff0000; font-style: italic">False</span>                                                                      │
│ <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">2</span>                     <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.00</span>           <span style="color: #ff0000; text-decoration-color: #ff0000; font-style: italic">False</span>                                                                      │
│ <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">23</span>                    <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.00</span>           <span style="color: #ff0000; text-decoration-color: #ff0000; font-style: italic">False</span>                                                                      │
│ <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">9</span>                     <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.21</span>            <span style="color: #00ff00; text-decoration-color: #00ff00; font-style: italic">True</span>                                                                      │
│ <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">32</span>                    <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.00</span>           <span style="color: #ff0000; text-decoration-color: #ff0000; font-style: italic">False</span>                                                                      │
│ <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">6</span>                     <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.00</span>           <span style="color: #ff0000; text-decoration-color: #ff0000; font-style: italic">False</span>                                                                      │
│ <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">34</span>                    <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.00</span>           <span style="color: #ff0000; text-decoration-color: #ff0000; font-style: italic">False</span>                                                                      │
│ <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">7</span>                     <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.00</span>           <span style="color: #ff0000; text-decoration-color: #ff0000; font-style: italic">False</span>                                                                      │
│ <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">1</span>                     <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.00</span>           <span style="color: #ff0000; text-decoration-color: #ff0000; font-style: italic">False</span>                                                                      │
│ <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">24</span>                    <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.00</span>           <span style="color: #ff0000; text-decoration-color: #ff0000; font-style: italic">False</span>                                                                      │
│ <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">18</span>                    <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.00</span>           <span style="color: #ff0000; text-decoration-color: #ff0000; font-style: italic">False</span>                                                                      │
│ <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">36</span>                    <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.00</span>           <span style="color: #ff0000; text-decoration-color: #ff0000; font-style: italic">False</span>                                                                      │
│ <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">33</span>                    <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.00</span>           <span style="color: #ff0000; text-decoration-color: #ff0000; font-style: italic">False</span>                                                                      │
│ <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">39</span>                    <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.00</span>           <span style="color: #ff0000; text-decoration-color: #ff0000; font-style: italic">False</span>                                                                      │
│ <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">26</span>                    <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.00</span>           <span style="color: #ff0000; text-decoration-color: #ff0000; font-style: italic">False</span>                                                                      │
│ <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">14</span>                    <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.63</span>            <span style="color: #00ff00; text-decoration-color: #00ff00; font-style: italic">True</span>                                                                      │
│ <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">28</span>                    <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.00</span>           <span style="color: #ff0000; text-decoration-color: #ff0000; font-style: italic">False</span>                                                                      │
│ <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">15</span>                    <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.00</span>           <span style="color: #ff0000; text-decoration-color: #ff0000; font-style: italic">False</span>                                                                      │
│ <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">12</span>                    <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.00</span>           <span style="color: #ff0000; text-decoration-color: #ff0000; font-style: italic">False</span>                                                                      │
│ <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">20</span>                    <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.00</span>           <span style="color: #ff0000; text-decoration-color: #ff0000; font-style: italic">False</span>                                                                      │
│ <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">22</span>                    <span style="color: #008080; text-decoration-color: #008080; font-weight: bold">0.00</span>           <span style="color: #ff0000; text-decoration-color: #ff0000; font-style: italic">False</span>                                                                      │
└─────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘
</pre>
</div></div>
</details>
</div>
<p>Again, the acceptance probability is right around the desired value of 0.85 for tascCODA, indicating no apparent problems with the optimization.</p>
<p>The result from tascCODA should first and foremost be interpreted as effects on the nodes of the tree. A nonzero parameter on a node means that the aggregated count of all cell types under that node changes significantly.
We can easily visualize this in a tree plot for each of the three disease states. Blue circles indicate an increase, red circles a decrease:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tasccoda_model</span><span class="o">.</span><span class="n">plot_draw_effects</span><span class="p">(</span>
    <span class="n">tasccoda_data</span><span class="p">,</span>
    <span class="n">modality_key</span><span class="o">=</span><span class="s2">&quot;coda&quot;</span><span class="p">,</span>
    <span class="n">tree</span><span class="o">=</span><span class="s2">&quot;tree&quot;</span><span class="p">,</span>
    <span class="n">covariate</span><span class="o">=</span><span class="s2">&quot;condition[T.Salmonella]&quot;</span><span class="p">,</span>
    <span class="n">show_leaf_effects</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">show_legend</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/09eaf33313f9d698d6f1a8a757ee3bd7387c364d386492f223f8832942744d00.png" src="../_images/09eaf33313f9d698d6f1a8a757ee3bd7387c364d386492f223f8832942744d00.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tasccoda_model</span><span class="o">.</span><span class="n">plot_draw_effects</span><span class="p">(</span>
    <span class="n">tasccoda_data</span><span class="p">,</span>
    <span class="n">modality_key</span><span class="o">=</span><span class="s2">&quot;coda&quot;</span><span class="p">,</span>
    <span class="n">tree</span><span class="o">=</span><span class="s2">&quot;tree&quot;</span><span class="p">,</span>
    <span class="n">covariate</span><span class="o">=</span><span class="s2">&quot;condition[T.Hpoly.Day3]&quot;</span><span class="p">,</span>
    <span class="n">show_leaf_effects</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">show_legend</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/c7d43ca9d7d1ef946c788b93c2d760ccfef6fc28dd12bddedb6c2955439a7d4e.png" src="../_images/c7d43ca9d7d1ef946c788b93c2d760ccfef6fc28dd12bddedb6c2955439a7d4e.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tasccoda_model</span><span class="o">.</span><span class="n">plot_draw_effects</span><span class="p">(</span>
    <span class="n">tasccoda_data</span><span class="p">,</span>
    <span class="n">modality_key</span><span class="o">=</span><span class="s2">&quot;coda&quot;</span><span class="p">,</span>
    <span class="n">tree</span><span class="o">=</span><span class="s2">&quot;tree&quot;</span><span class="p">,</span>
    <span class="n">covariate</span><span class="o">=</span><span class="s2">&quot;condition[T.Hpoly.Day10]&quot;</span><span class="p">,</span>
    <span class="n">show_leaf_effects</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">show_legend</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/aa9cdfcf4e2735dca5cfbd4d73aa4ab7f8f14c450efeadfc5685f949ae2ca834.png" src="../_images/aa9cdfcf4e2735dca5cfbd4d73aa4ab7f8f14c450efeadfc5685f949ae2ca834.png" />
</div>
</div>
<p>Alternatively, effects on internal nodes can also be translated through the tree onto the cell type level, allowing for a calculation of log-fold changes like in scCODA.
To visualize the log-fold changes of the cell types, we do the same plots as for scCODA, inspired by “High-resolution single-cell atlas reveals diversity and plasticity of tissue-resident neutrophils in non-small cell lung cancer”<span id="id18">[<a class="reference internal" href="#id348" title="Stefan Salcher, Gregor Sturm, Lena Horvath, Gerold Untergasser, Georgios Fotakis, Elisa Panizzolo, Agnieszka Martowicz, Georg Pall, Gabriele Gamerith, Martina Sykora, Florian Augustin, Katja Schmitz, Francesca Finotello, Dietmar Rieder, Sieghart Sopper, Dominik Wolf, Andreas Pircher, and Zlatko Trajanoski. High-resolution single-cell atlas reveals diversity and plasticity of tissue-resident neutrophils in non-small cell lung cancer. bioRxiv, 2022. URL: https://www.biorxiv.org/content/early/2022/05/10/2022.05.09.491204, arXiv:https://www.biorxiv.org/content/early/2022/05/10/2022.05.09.491204.full.pdf, doi:10.1101/2022.05.09.491204.">Salcher <em>et al.</em>, 2022</a>]</span>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tasccoda_model</span><span class="o">.</span><span class="n">plot_effects_barplot</span><span class="p">(</span>
    <span class="n">tasccoda_data</span><span class="p">,</span> <span class="n">modality_key</span><span class="o">=</span><span class="s2">&quot;coda&quot;</span><span class="p">,</span> <span class="n">covariates</span><span class="o">=</span><span class="s2">&quot;condition&quot;</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;seaborn.axisgrid.FacetGrid at 0x19ad2cd90&gt;
</pre></div>
</div>
<img alt="../_images/85bdcadf4262f8496e4d9876500c45aecd336dc2d3334f53dbad9ea248619410.png" src="../_images/85bdcadf4262f8496e4d9876500c45aecd336dc2d3334f53dbad9ea248619410.png" />
</div>
</div>
<p>Another insightful representation can be gained by plotting the effect sizes for each condition on the UMAP embedding, and comparing it to the cell type assignments:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;ncols&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s2">&quot;wspace&quot;</span><span class="p">:</span> <span class="mf">0.25</span><span class="p">,</span> <span class="s2">&quot;vcenter&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;vmax&quot;</span><span class="p">:</span> <span class="mf">1.5</span><span class="p">,</span> <span class="s2">&quot;vmin&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mf">1.5</span><span class="p">}</span>
<span class="n">tasccoda_model</span><span class="o">.</span><span class="n">plot_effects_umap</span><span class="p">(</span>
    <span class="n">tasccoda_data</span><span class="p">,</span>
    <span class="n">effect_name</span><span class="o">=</span><span class="p">[</span>
        <span class="s2">&quot;effect_df_condition[T.Salmonella]&quot;</span><span class="p">,</span>
        <span class="s2">&quot;effect_df_condition[T.Hpoly.Day3]&quot;</span><span class="p">,</span>
        <span class="s2">&quot;effect_df_condition[T.Hpoly.Day10]&quot;</span><span class="p">,</span>
    <span class="p">],</span>
    <span class="n">cluster_key</span><span class="o">=</span><span class="s2">&quot;nsbm_level_1&quot;</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">sc</span><span class="o">.</span><span class="n">pl</span><span class="o">.</span><span class="n">umap</span><span class="p">(</span>
    <span class="n">tasccoda_data</span><span class="p">[</span><span class="s2">&quot;rna&quot;</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;cell_label&quot;</span><span class="p">,</span> <span class="s2">&quot;nsbm_level_1&quot;</span><span class="p">],</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">wspace</span><span class="o">=</span><span class="mf">0.5</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/6cee2b7fa55dcbcfd6db33d6e692fb208ff22c3e0832134be3df62442f34ca63.png" src="../_images/6cee2b7fa55dcbcfd6db33d6e692fb208ff22c3e0832134be3df62442f34ca63.png" />
<img alt="../_images/819033af05c5be21479faa5b399e174c43b2e0caa1caaa53243a2a9ae0fa2cc8.png" src="../_images/819033af05c5be21479faa5b399e174c43b2e0caa1caaa53243a2a9ae0fa2cc8.png" />
</div>
</div>
<p>The results are very similar to scCODA’s findings:</p>
<ul class="simple">
<li><p>For the Salmonella infection, we get an aggregated increase in clusters that approximately represent Enterocytes in the cell type clustering. This increase is even stronger for cluster 12, as indicated by the additional positive effect on the leaf level</p></li>
<li><p>For the Heligmosomoides polygyrus infection, we get no credible changes after 3 days. After 10 days, we pick up decreases in clusters that contain Stem- and transit-amplifying cells, as well as a less strong decrease of Enterocytes and Enterocyte progenitors, which was also picked up by scCODA.</p></li>
</ul>
</section>
<section id="without-labeled-clusters">
<span id="conditions-compositional-key-takeaway-2"></span><h2><span class="section-number">17.6. </span>Without labeled clusters<a class="headerlink" href="#without-labeled-clusters" title="Link to this heading">#</a></h2>
<p>It is not always possible or practical to use precisely labeled clusters such as cell-type definitions, especially when we are interested in studying transitional states between cell type clusters, such as during developmental processes, or when we expect only a subpopulation of a cell type to be affected by the condition of interest. In such cases, determining compositional changes based on known annotations may not be appropriate.</p>
<p>A set of methods exist to detect compositional changes occurring in subpopulations of cells smaller than the cell type clusters, usually defined starting from a k-nearest neighbor (KNN) graph computed from similarities in the same low dimensional space used for clustering.</p>
<ul class="simple">
<li><p>DA-seq computes, for each cell, a score based on the relative prevalence of cells from both biological states in the cell’s neighborhood, using a range of k values<span id="id19">[<a class="reference internal" href="#id349" title="Jun Zhao, Ariel Jaffe, Henry Li, Ofir Lindenbaum, Esen Sefik, Ruaidhrí Jackson, Xiuyuan Cheng, Richard A. Flavell, and Yuval Kluger. Detection of differentially abundant cell subpopulations in scrna-seq data. Proceedings of the National Academy of Sciences, 118(22):e2100293118, 2021. URL: https://www.pnas.org/doi/abs/10.1073/pnas.2100293118, arXiv:https://www.pnas.org/doi/pdf/10.1073/pnas.2100293118, doi:10.1073/pnas.2100293118.">Zhao <em>et al.</em>, 2021</a>]</span>. The scores are used as input for a logistic classifier to predict the biological condition of each cell.</p></li>
<li><p>Milo assigns cells to partially overlapping neighborhoods on the KNN graph, then differential abundance (DA) testing is performed modelling cell counts with a generalized linear model (GLM) <span id="id20">[<a class="reference internal" href="#id350" title="Emma Dann, Neil C. Henderson, Sarah A. Teichmann, Michael D. Morgan, and John C. Marioni. Differential abundance testing on single-cell data using k-nearest neighbor graphs. Nature Biotechnology, 40(2):245-253, Feb 2022. URL: https://doi.org/10.1038/s41587-021-01033-z, doi:10.1038/s41587-021-01033-z.">Dann <em>et al.</em>, 2022</a>]</span>.</p></li>
<li><p>MELD calculates a relative likelihood estimate of observing each cell in every condition using graph-based density estimate<span id="id21">[<a class="reference internal" href="#id351" title="Daniel B. Burkhardt, Jay S. Stanley, Alexander Tong, Ana Luisa Perdigoto, Scott A. Gigante, Kevan C. Herold, Guy Wolf, Antonio J. Giraldez, David van Dijk, and Smita Krishnaswamy. Quantifying the effect of experimental perturbations at single-cell resolution. Nature Biotechnology, 39(5):619-629, May 2021. URL: https://doi.org/10.1038/s41587-020-00803-5, doi:10.1038/s41587-020-00803-5.">Burkhardt <em>et al.</em>, 2021</a>]</span>.</p></li>
</ul>
<p>These methods have unique strengths and weaknesses. Because it relies on logistic classification, DA-seq is designed for pairwise comparisons between two biological conditions, but can’t be applied to test for differences associated with a continuous covariate (such as age or timepoints). DA-seq and Milo use the variance in the abundance statistic between replicate samples of the same condition to estimate the significance of the differential abundance, while MELD doesn’t use this information. While considering consistency across replicates reduces the number of false positives driven by one or a few samples, all KNN-based methods are sensitive to a loss of information if the conditions of interest and confounders, defined by technical or experimental sources of variation, are strongly correlated. The impact of confounders can be mitigated using batch integration methods before KNN graph construction and/or incorporating the confounding covariates in the model for DA testing, as we discuss further in the example below. Another limitation of KNN-based methods to bare in mind is that cells in a neighborhood may not necessarily represent a specific, unique biological subpopulation, because a cellular state may span over multiple neighborhoods. Reducing k for the KNN graph or constructing a graph on cells from a particular lineage of interest can help mitigate this issue and ensure the predicted effects are robust to the choice of parameters and to the data subset used<span id="id22">[<a class="reference internal" href="#id350" title="Emma Dann, Neil C. Henderson, Sarah A. Teichmann, Michael D. Morgan, and John C. Marioni. Differential abundance testing on single-cell data using k-nearest neighbor graphs. Nature Biotechnology, 40(2):245-253, Feb 2022. URL: https://doi.org/10.1038/s41587-021-01033-z, doi:10.1038/s41587-021-01033-z.">Dann <em>et al.</em>, 2022</a>]</span>.</p>
<p>Generally, if large differences are apparent in large clusters by visualization or the imbalances between cell types are of interest, direct analysis with cell-type aware methods, such as scCODA, might be more suitable. KNN-based methods are more powerful when we are interested in differences in cell abundances that might appear in transitional states between cell types or in a specific subset of cells of a given cell type.</p>
<p>We will now apply Milo to the Haber dataset to try to find over- or underrepresented neighborhoods of cells upon infection.</p>
<p>Milo is available as <a class="reference external" href="https://github.com/MarioniLab/miloR">miloR</a> for R users and in <a class="reference external" href="https://github.com/theislab/pertpy">Pertpy</a> for Python users in the scverse ecosystem. In the following demonstration, we will use milo which is easiest to use with our AnnData object due to its scverse compatibility. Be aware that milo in its current state also requires a working <a class="reference external" href="https://bioconductor.org/packages/release/bioc/html/edgeR.html">edgeR</a> installation.</p>
<p>To perform DA analysis with Milo, we need to construct a KNN graph that is representative of the biological similarities between cells, as we do when performing clustering or UMAP visualization of a single-cell dataset. This means (A) building a common low-dimensional space for all samples and (B) minimizing cell-cell similarities driven by technical factors (i.e. batch effects).</p>
<p>We first use the standard scanpy workflow for dimensionality reduction to qualitatively assess whether we see a batch effect in this dataset.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">milo</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">tl</span><span class="o">.</span><span class="n">Milo</span><span class="p">()</span>
<span class="n">adata</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">haber_2017_regions</span><span class="p">()</span>
<span class="n">mdata</span> <span class="o">=</span> <span class="n">milo</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">adata</span><span class="p">)</span>
<span class="n">mdata</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><pre>MuData object with n_obs × n_vars = 9842 × 15215
  2 modalities
    rna:	9842 x 15215
      obs:	&#x27;batch&#x27;, &#x27;barcode&#x27;, &#x27;condition&#x27;, &#x27;cell_label&#x27;
    milo:	0 x 0</pre></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># use logcounts to calculate PCA and neighbors</span>
<span class="n">adata</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="s2">&quot;counts&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">X</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">adata</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="s2">&quot;logcounts&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">pp</span><span class="o">.</span><span class="n">log1p</span><span class="p">(</span><span class="n">adata</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="s2">&quot;counts&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">adata</span><span class="o">.</span><span class="n">X</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="s2">&quot;logcounts&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

<span class="n">sc</span><span class="o">.</span><span class="n">pp</span><span class="o">.</span><span class="n">highly_variable_genes</span><span class="p">(</span>
    <span class="n">adata</span><span class="p">,</span> <span class="n">n_top_genes</span><span class="o">=</span><span class="mi">3000</span><span class="p">,</span> <span class="n">subset</span><span class="o">=</span><span class="kc">False</span>
<span class="p">)</span>  <span class="c1"># 3k genes as used by authors for clustering</span>

<span class="n">sc</span><span class="o">.</span><span class="n">pp</span><span class="o">.</span><span class="n">pca</span><span class="p">(</span><span class="n">adata</span><span class="p">)</span>
<span class="n">sc</span><span class="o">.</span><span class="n">pp</span><span class="o">.</span><span class="n">neighbors</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="n">n_neighbors</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">n_pcs</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
<span class="n">sc</span><span class="o">.</span><span class="n">tl</span><span class="o">.</span><span class="n">umap</span><span class="p">(</span><span class="n">adata</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>OMP: Info #276: omp_set_nested routine deprecated, please use omp_set_max_active_levels instead.
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sc</span><span class="o">.</span><span class="n">pl</span><span class="o">.</span><span class="n">umap</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;condition&quot;</span><span class="p">,</span> <span class="s2">&quot;batch&quot;</span><span class="p">,</span> <span class="s2">&quot;cell_label&quot;</span><span class="p">],</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">wspace</span><span class="o">=</span><span class="mf">0.25</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/b15ee1738bf2954733e558a8ef99bcd50eb03571506ef9aa4a51e2c3562504ec.png" src="../_images/b15ee1738bf2954733e558a8ef99bcd50eb03571506ef9aa4a51e2c3562504ec.png" />
</div>
</div>
<p>While cell type clusters are broadly captured, we can see residual separation between batches, also for replicates of the same treatment. If we define neighbourhoods on this KNN graph we might have a large fraction of neighbourhoods containing cells from just one or a few batches. This could introduce false negatives, if the variance in number of cells between replicates is too low (e.g. 0 cells for all replicates) or too high (e.g. all zero cells except for one replicate with a large number of cells), but also false positives, especially when, like in this case, the number of replicates per condition is low.</p>
<p>To minimize these errors, we apply the scVI method to learn a batch-corrected latent space, as introduced in the <a class="reference internal" href="#"><span class="xref myst">integration chapter</span></a>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">scvi</span>

<span class="n">adata_scvi</span> <span class="o">=</span> <span class="n">adata</span><span class="p">[:,</span> <span class="n">adata</span><span class="o">.</span><span class="n">var</span><span class="p">[</span><span class="s2">&quot;highly_variable&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">scvi</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">SCVI</span><span class="o">.</span><span class="n">setup_anndata</span><span class="p">(</span><span class="n">adata_scvi</span><span class="p">,</span> <span class="n">layer</span><span class="o">=</span><span class="s2">&quot;counts&quot;</span><span class="p">,</span> <span class="n">batch_key</span><span class="o">=</span><span class="s2">&quot;batch&quot;</span><span class="p">)</span>
<span class="n">model_scvi</span> <span class="o">=</span> <span class="n">scvi</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">SCVI</span><span class="p">(</span><span class="n">adata_scvi</span><span class="p">)</span>
<span class="n">max_epochs_scvi</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">([</span><span class="nb">round</span><span class="p">((</span><span class="mi">20000</span> <span class="o">/</span> <span class="n">adata</span><span class="o">.</span><span class="n">n_obs</span><span class="p">)</span> <span class="o">*</span> <span class="mi">400</span><span class="p">),</span> <span class="mi">400</span><span class="p">]))</span>
<span class="n">model_scvi</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">max_epochs</span><span class="o">=</span><span class="n">max_epochs_scvi</span><span class="p">)</span>
<span class="n">adata</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="s2">&quot;X_scVI&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">model_scvi</span><span class="o">.</span><span class="n">get_latent_representation</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sc</span><span class="o">.</span><span class="n">pp</span><span class="o">.</span><span class="n">neighbors</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="n">use_rep</span><span class="o">=</span><span class="s2">&quot;X_scVI&quot;</span><span class="p">)</span>
<span class="n">sc</span><span class="o">.</span><span class="n">tl</span><span class="o">.</span><span class="n">umap</span><span class="p">(</span><span class="n">adata</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sc</span><span class="o">.</span><span class="n">pl</span><span class="o">.</span><span class="n">umap</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;condition&quot;</span><span class="p">,</span> <span class="s2">&quot;batch&quot;</span><span class="p">,</span> <span class="s2">&quot;cell_label&quot;</span><span class="p">],</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">wspace</span><span class="o">=</span><span class="mf">0.25</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/7c8fc1f40b243570a9426f73bd416126522b1a29d9aef3400cdf6b658273cf1d.png" src="../_images/7c8fc1f40b243570a9426f73bd416126522b1a29d9aef3400cdf6b658273cf1d.png" />
</div>
</div>
<p>Here we can see much better mixing between batches and cell labels form much more uniform clusters.</p>
<div class="admonition-will-batch-correction-remove-biological-differences-between-conditions admonition">
<p class="admonition-title">Will batch correction remove biological differences between conditions?</p>
<p>This really boils down to good experimental design. In an ideal set-up replicates from the same condition will be processed in different batches. This allows to estimate technical differences more accurately and possibly also incorporate the batch as a confounder in the linear model for differential abundance analysis (see below), to further minimize false positives. When, like in this example, batches are confounded with the biological condition of interest, we have to recognize that while we might be minimizing false positives, the rate of false negatives might also increase. The analyst can decide which type of error is more detrimental depending on the dataset and purpose of the differential abundance analysis.</p>
</div>
<section id="define-neighbourhoods">
<h3><span class="section-number">17.6.1. </span>Define neighbourhoods<a class="headerlink" href="#define-neighbourhoods" title="Link to this heading">#</a></h3>
<p>Milo is a KNN-based model, where cell abundance is quantified on neighbourhoods of cells. In Milo, a neighbourhood is defined as the group of cells connected by an edge to the same cell (<em>index cell</em>) in an undirected KNN graph. While we could in principle have one neighbourhood for each cell in the graph, this would be inefficient and significantly increase the multiple testing burden. Therefore Milo samples a refined set of cells as index cells for neighbourhoods, starting from a random sample of a fraction of cells. The initial proportion can be specified using the <code class="docutils literal notranslate"><span class="pre">prop</span></code> argument in the <code class="docutils literal notranslate"><span class="pre">milo.make_nhoods</span></code> function. As by default, we recommend using <code class="docutils literal notranslate"><span class="pre">prop=0.1</span></code> (10% of cells) and to reduce to 5% or 2% to increase scalability on large datasets (&gt; 100k cells).</p>
<p>If no <code class="docutils literal notranslate"><span class="pre">neighbors_key</span></code> parameter is specified, Milo uses the neighbours from <code class="docutils literal notranslate"><span class="pre">.obsp</span></code>. Therefore, ensure that <code class="docutils literal notranslate"><span class="pre">sc.pp.neighbors</span></code> was run on the correct representation, i.e. an integrated latent space if batch correction was required.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">milo</span><span class="o">.</span><span class="n">make_nhoods</span><span class="p">(</span><span class="n">mdata</span><span class="p">,</span> <span class="n">prop</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Now the binary assignment of cells to neighbourhood is stored in <code class="docutils literal notranslate"><span class="pre">adata.obsm['nhoods']</span></code>. Here we can see that, as expected, the number of neighbourhoods should be less or equal to the number of cells in the graph times the <code class="docutils literal notranslate"><span class="pre">prop</span></code> parameter. In this case, less or equal than 984 neighbourhoods.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">adata</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="s2">&quot;nhoods&quot;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;9842x847 sparse matrix of type &#39;&lt;class &#39;numpy.float32&#39;&gt;&#39;
	with 22864 stored elements in Compressed Sparse Row format&gt;
</pre></div>
</div>
</div>
</div>
<p>At this point we need to check the median number of cells in each neighbourhood, to make sure the neighbourhoods contain enough cells to detect differences between samples.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">nhood_size</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="s2">&quot;nhoods&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">toarray</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">nhood_size</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;# cells in neighbourhood&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;# neighbouthoods&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/f5ac99e33719e19019cd291df8b5b9f8e0577e355b950e15fdee45ec3c711e47.png" src="../_images/f5ac99e33719e19019cd291df8b5b9f8e0577e355b950e15fdee45ec3c711e47.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">nhood_size</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>26.0
</pre></div>
</div>
</div>
</div>
<p>We expect the minimum number of cells to be equal to the k parameter used during graph construction (k=10 in this case). To increase the statistical power for DA testing, we need a sufficient number of cells from all samples in the majority of the neighbourhoods. We can use the following rule of thumb: to have a median of 3 cells from each sample in a neighbourhood, the number of cells in a neighbourhood should be at least 3 times the number of samples. In this case, we have data from 10 samples. If we want to have on average 3 cells from each sample in a neighbourhood, the minimum number of cells should be 30.</p>
<p>Based on the plot above, we have a large number of neighbourhoods with less than 30 cells, which could lead to an underpowered test. To solve this, we just need to recompute the KNN graph using <code class="docutils literal notranslate"><span class="pre">n_neighbors=30</span></code>. To distinguish this KNN graph used for neighbourhood-level DA analysis from the graph used for UMAP building, we will store this as a distinct graph in <code class="docutils literal notranslate"><span class="pre">adata.obsp</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sc</span><span class="o">.</span><span class="n">pp</span><span class="o">.</span><span class="n">neighbors</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="n">n_neighbors</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">use_rep</span><span class="o">=</span><span class="s2">&quot;X_scVI&quot;</span><span class="p">,</span> <span class="n">key_added</span><span class="o">=</span><span class="s2">&quot;milo&quot;</span><span class="p">)</span>
<span class="n">milo</span><span class="o">.</span><span class="n">make_nhoods</span><span class="p">(</span><span class="n">mdata</span><span class="p">,</span> <span class="n">neighbors_key</span><span class="o">=</span><span class="s2">&quot;milo&quot;</span><span class="p">,</span> <span class="n">prop</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Let’s check that the distribution of neighbourhood sizes has shifted.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">nhood_size</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="s2">&quot;nhoods&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">toarray</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">nhood_size</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;# cells in neighbourhood&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;# neighbouthoods&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/f281f80117a79d021d857b966d1a84b69656e8707386b61317fb010cfe2e5dfd.png" src="../_images/f281f80117a79d021d857b966d1a84b69656e8707386b61317fb010cfe2e5dfd.png" />
</div>
</div>
</section>
<section id="count-cells-in-neighbourhoods">
<h3><span class="section-number">17.6.2. </span>Count cells in neighbourhoods<a class="headerlink" href="#count-cells-in-neighbourhoods" title="Link to this heading">#</a></h3>
<p>In the next step, Milo counts cells belonging to each of the samples (here identified by the <code class="docutils literal notranslate"><span class="pre">batch</span></code> column in <code class="docutils literal notranslate"><span class="pre">adata.obs</span></code>).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">milo</span><span class="o">.</span><span class="n">count_nhoods</span><span class="p">(</span><span class="n">mdata</span><span class="p">,</span> <span class="n">sample_col</span><span class="o">=</span><span class="s2">&quot;batch&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><pre>MuData object with n_obs × n_vars = 9842 × 15215
  2 modalities
    rna:	9842 x 15215
      obs:	&#x27;batch&#x27;, &#x27;barcode&#x27;, &#x27;condition&#x27;, &#x27;cell_label&#x27;, &#x27;nhood_ixs_random&#x27;, &#x27;nhood_ixs_refined&#x27;, &#x27;nhood_kth_distance&#x27;
      var:	&#x27;highly_variable&#x27;, &#x27;means&#x27;, &#x27;dispersions&#x27;, &#x27;dispersions_norm&#x27;
      uns:	&#x27;hvg&#x27;, &#x27;pca&#x27;, &#x27;neighbors&#x27;, &#x27;umap&#x27;, &#x27;condition_colors&#x27;, &#x27;batch_colors&#x27;, &#x27;cell_label_colors&#x27;, &#x27;nhood_neighbors_key&#x27;, &#x27;milo&#x27;
      obsm:	&#x27;X_pca&#x27;, &#x27;X_umap&#x27;, &#x27;X_scVI&#x27;, &#x27;nhoods&#x27;
      varm:	&#x27;PCs&#x27;
      layers:	&#x27;counts&#x27;, &#x27;logcounts&#x27;
      obsp:	&#x27;distances&#x27;, &#x27;connectivities&#x27;, &#x27;milo_distances&#x27;, &#x27;milo_connectivities&#x27;
    milo_compositional:	10 x 808
      var:	&#x27;index_cell&#x27;, &#x27;kth_distance&#x27;
      uns:	&#x27;sample_col&#x27;</pre></div></div>
</div>
<p>This stores a neighbourhood-level AnnData object, where <code class="docutils literal notranslate"><span class="pre">nhood_adata.X</span></code> stores the number of cells from each sample in each neighbourhood.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mdata</span><span class="p">[</span><span class="s2">&quot;milo&quot;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>AnnData object with n_obs × n_vars = 10 × 808
    var: &#39;index_cell&#39;, &#39;kth_distance&#39;
    uns: &#39;sample_col&#39;
</pre></div>
</div>
</div>
</div>
<p>We can verify that the average number of cells per sample times the number of samples roughly corresponds to the number of cells in a neighbourhood.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mean_n_cells</span> <span class="o">=</span> <span class="n">mdata</span><span class="p">[</span><span class="s2">&quot;milo&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">X</span><span class="o">.</span><span class="n">toarray</span><span class="p">()</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">nhood_size</span><span class="p">,</span> <span class="n">mean_n_cells</span><span class="p">,</span> <span class="s2">&quot;.&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;# cells in nhood&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Mean # cells per sample in nhood&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/f9ecf388f4e6075f13495fceeb057f7cfb2137580988e98c1e1609e19438a493.png" src="../_images/f9ecf388f4e6075f13495fceeb057f7cfb2137580988e98c1e1609e19438a493.png" />
</div>
</div>
</section>
<section id="run-differential-abundance-test-on-neighbourhoods">
<h3><span class="section-number">17.6.3. </span>Run differential abundance test on neighbourhoods<a class="headerlink" href="#run-differential-abundance-test-on-neighbourhoods" title="Link to this heading">#</a></h3>
<p>Milo uses edgeR’s QLF test to test if there are statistically significant differences between the number of cells from a condition of interest in each neighborhood.</p>
<p>Here we are interested in detecting in which neighbourhoods there is a significant increase or decrease of cells in response to infection. Since the <code class="docutils literal notranslate"><span class="pre">condition</span></code> covariate stores many different types of infection, we need to specify which conditions we need to contrast in our differential abundance test (following a convention used in R, by default the last level of the covariate against the rest will be used, in this case Salmonella vs rest). To specify the comparison, we use <a class="reference external" href="https://genomicsclass.github.io/book/pages/expressing_design_formula.html">the syntax used for GLMs in R</a>.</p>
<p>Let’s first test for differences associated with Salmonella infection.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">milo</span><span class="o">.</span><span class="n">da_nhoods</span><span class="p">(</span>
    <span class="n">mdata</span><span class="p">,</span> <span class="n">design</span><span class="o">=</span><span class="s2">&quot;~condition&quot;</span><span class="p">,</span> <span class="n">model_contrasts</span><span class="o">=</span><span class="s2">&quot;conditionSalmonella-conditionControl&quot;</span>
<span class="p">)</span>
<span class="n">milo_results_salmonella</span> <span class="o">=</span> <span class="n">mdata</span><span class="p">[</span><span class="s2">&quot;milo&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">milo_results_salmonella</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>condition</th>
      <th>batch</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>B1</th>
      <td>Control</td>
      <td>B1</td>
    </tr>
    <tr>
      <th>B2</th>
      <td>Control</td>
      <td>B2</td>
    </tr>
    <tr>
      <th>B3</th>
      <td>Control</td>
      <td>B3</td>
    </tr>
    <tr>
      <th>B4</th>
      <td>Control</td>
      <td>B4</td>
    </tr>
    <tr>
      <th>B5</th>
      <td>Hpoly.Day3</td>
      <td>B5</td>
    </tr>
    <tr>
      <th>B6</th>
      <td>Hpoly.Day3</td>
      <td>B6</td>
    </tr>
    <tr>
      <th>B7</th>
      <td>Hpoly.Day10</td>
      <td>B7</td>
    </tr>
    <tr>
      <th>B8</th>
      <td>Hpoly.Day10</td>
      <td>B8</td>
    </tr>
    <tr>
      <th>B9</th>
      <td>Salmonella</td>
      <td>B9</td>
    </tr>
    <tr>
      <th>B10</th>
      <td>Salmonella</td>
      <td>B10</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>For each neighbourhood, we calculate a set of statistics. The most important ones to understand are:</p>
<ul class="simple">
<li><p><strong>log-Fold Change (logFC):</strong> this represents the effect size of the difference in cell abundance and corresponds to the coefficient associated with the condition of interest in the GLM. If logFC &gt; 0 the neighbourhood is enriched in cells from the condition of interest, if logFC &lt; 0 the neighbourhood is depleted in cells from the condition of interest.</p></li>
<li><p><strong>Uncorrected p-value (PValue):</strong> this is the p-value for the QLF test before multiple testing correction.</p></li>
<li><p><strong>SpatialFDR:</strong> this is the p-value adjusted for multiple testing to limit the false discovery rate. This is calculated adapting the weighted Benjamini-Hochberg (BH) correction introduced by Lun et al <span id="id23">[<a class="reference internal" href="#id358" title="Aaron T. L. Lun, Arianne C. Richard, and John C. Marioni. Testing for differential abundance in mass cytometry data. Nature Methods, 14(7):707–709, July 2017. doi:10.1038/nmeth.4295.">Lun <em>et al.</em>, 2017</a>]</span>, which accounts for the fact that because neighbourhoods are partially overlapping (i.e. one cell can belong to multiple neighbourhoods) the DA tests on different neighbourhoods are not completely independent. In practice, the BH correction is weighted by the reciprocal of the distance to the k-th nearest neighbor to the index cell (stored in <code class="docutils literal notranslate"><span class="pre">kth_distance</span></code>), which is used as a proxy for the amount of overlap with other neighbourhoods. You might notice that the SpatialFDR values are always lower or equal to the FDR values, calculated with a conventional BH correction.</p></li>
</ul>
<p>Before any exploration and interpretation of the results, we can visualize these statistics with a set of diagnostics plots to sanity check our statistical test:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">plot_milo_diagnostics</span><span class="p">(</span><span class="n">mdata</span><span class="p">):</span>
    <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.1</span>  <span class="c1">## significance threshold</span>

    <span class="k">with</span> <span class="n">matplotlib</span><span class="o">.</span><span class="n">rc_context</span><span class="p">({</span><span class="s2">&quot;figure.figsize&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">12</span><span class="p">,</span> <span class="mi">12</span><span class="p">]}):</span>
        <span class="c1">## Check P-value histogram</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">mdata</span><span class="p">[</span><span class="s2">&quot;milo&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">var</span><span class="p">[</span><span class="s2">&quot;PValue&quot;</span><span class="p">],</span> <span class="n">bins</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Uncorrected P-value&quot;</span><span class="p">)</span>

        <span class="c1">## Visualize extent of multiple-testing correction</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
            <span class="n">mdata</span><span class="p">[</span><span class="s2">&quot;milo&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">var</span><span class="p">[</span><span class="s2">&quot;PValue&quot;</span><span class="p">],</span>
            <span class="n">mdata</span><span class="p">[</span><span class="s2">&quot;milo&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">var</span><span class="p">[</span><span class="s2">&quot;SpatialFDR&quot;</span><span class="p">],</span>
            <span class="n">s</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Uncorrected P-value&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;SpatialFDR&quot;</span><span class="p">)</span>

        <span class="c1">## Visualize volcano plot</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
            <span class="n">mdata</span><span class="p">[</span><span class="s2">&quot;milo&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">var</span><span class="p">[</span><span class="s2">&quot;logFC&quot;</span><span class="p">],</span>
            <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">mdata</span><span class="p">[</span><span class="s2">&quot;milo&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">var</span><span class="p">[</span><span class="s2">&quot;SpatialFDR&quot;</span><span class="p">]),</span>
            <span class="n">s</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span>
            <span class="n">y</span><span class="o">=-</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">alpha</span><span class="p">),</span>
            <span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">,</span>
            <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">alpha</span><span class="o">*</span><span class="mi">100</span><span class="p">)</span><span class="si">}</span><span class="s2"> % SpatialFDR&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;log-Fold Change&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;- log10(SpatialFDR)&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

        <span class="c1">## Visualize MA plot</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">mdata</span><span class="p">[</span><span class="s2">&quot;milo&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">var</span>
        <span class="n">emp_null</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;SpatialFDR&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">alpha</span><span class="p">][</span><span class="s2">&quot;logFC&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Sig&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;SpatialFDR&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">alpha</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
        <span class="n">sns</span><span class="o">.</span><span class="n">scatterplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">df</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s2">&quot;logCPM&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">&quot;logFC&quot;</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="s2">&quot;Sig&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;grey&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">emp_null</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;purple&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;&lt; </span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">alpha</span><span class="o">*</span><span class="mi">100</span><span class="p">)</span><span class="si">}</span><span class="s2"> % SpatialFDR&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Mean log-counts&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;log-Fold Change&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>


<span class="n">plot_milo_diagnostics</span><span class="p">(</span><span class="n">mdata</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/20648319e674cc1e1c5ab91b7b8056d266c1e2aaba7e10b25689518dd57af318.png" src="../_images/20648319e674cc1e1c5ab91b7b8056d266c1e2aaba7e10b25689518dd57af318.png" />
</div>
</div>
<ol class="arabic simple">
<li><p>The <strong>P-value histogram</strong> shows the distribution of P-values before multiple testing correction. By definition, we expect the p-values under the null hypothesis (&gt; significance level) to be uniformly distributed, while the peak of p-values close to zero represents the significant results. This gives you an idea of how conservative your test is, and it might help to spot early some pathological cases. For example, if the distribution of P-values looks bimodal, with a second peak close to 1, this might indicate that you have a large number of neighbourhoods with no variance between replicates of one condition (e.g. all replicates from one condition have 0 cells) which might indicate a residual batch effect or that you need to increase the size of neighbourhoods; if the p-value histogram is left-skewed this might indicate a <a class="reference external" href="https://github.com/MarioniLab/miloR/issues/220#issuecomment-1140812805">confounding covariate</a> has not been accounted for in the model. For other pathological cases and possible interpretations see <a class="reference external" href="http://varianceexplained.org/statistics/interpreting-pvalue-histogram/">this blogpost</a>.</p></li>
<li><p>For each neighbourhood we plot the uncorrected P-Value VS the p-value controlling for the Spatial FDR. Here we expect the adjusted p-values to be larger (so points above the diagonal). If the FDR correction is especially severe (i.e. many values close to 1) this might indicate a pathological case. You might be testing on too many neighbourhoods (you can reduce <code class="docutils literal notranslate"><span class="pre">prop</span></code> in <code class="docutils literal notranslate"><span class="pre">milo.make_nhoods</span></code>) or there might be too much overlap between neighbourhoods (you might need to decrease <em>k</em> when constructing the KNN graph).</p></li>
<li><p>The <strong>volcano plot</strong> gives us an idea of how many neighbourhoods show significant DA after multiple testing correction ( - log(SpatialFDR) &gt; 1) and shows how many neighbourhoods are enriched or depleted of cells from the condition of interest.</p></li>
<li><p>The <strong>MA plot</strong> shows the dependency between average number of cells per sample and the log-Fold Change of the test. In a balanced scenario, we expect points to be concentrated around logFC = 0, otherwise the shift might indicate a strong imbalance in average number of cells between samples from different conditions. For more tips on how to interpret the MA plot see <a class="github reference external" href="https://github.com/MarioniLab/miloR/issues/208">MarioniLab/miloR#208</a>.</p></li>
</ol>
<p>After sanity check, we can visualize the DA results for each neighbourhood by the position of the index cell on the UMAP embedding, to qualitatively assess which cell types may be most affected by the infection.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">milo</span><span class="o">.</span><span class="n">build_nhood_graph</span><span class="p">(</span><span class="n">mdata</span><span class="p">)</span>
<span class="k">with</span> <span class="n">matplotlib</span><span class="o">.</span><span class="n">rc_context</span><span class="p">({</span><span class="s2">&quot;figure.figsize&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">]}):</span>
    <span class="n">milo</span><span class="o">.</span><span class="n">plot_nhood_graph</span><span class="p">(</span><span class="n">mdata</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">min_size</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">plot_edges</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">sc</span><span class="o">.</span><span class="n">pl</span><span class="o">.</span><span class="n">umap</span><span class="p">(</span><span class="n">mdata</span><span class="p">[</span><span class="s2">&quot;rna&quot;</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;cell_label&quot;</span><span class="p">,</span> <span class="n">legend_loc</span><span class="o">=</span><span class="s2">&quot;on data&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/2e7c54a140dad2d491170eae92b08708abe8de57f626f1480556b3d369c409d3.png" src="../_images/2e7c54a140dad2d491170eae92b08708abe8de57f626f1480556b3d369c409d3.png" />
<img alt="../_images/0bf95f109f572955ba4d2e88bf00bf91587a4a46e5644f479f02e3d53ee221da.png" src="../_images/0bf95f109f572955ba4d2e88bf00bf91587a4a46e5644f479f02e3d53ee221da.png" />
</div>
</div>
<p>This shows a set of neighbourhoods enriched upon Salmonella infection corresponding to mature enterocytes, and a depletion in a subset of stem cell neighbourhoods. For interpretation of results, it’s often useful to annotate neighbourhoods by the cell type cluster that they overlap with.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">milo</span><span class="o">.</span><span class="n">annotate_nhoods</span><span class="p">(</span><span class="n">mdata</span><span class="p">,</span> <span class="n">anno_col</span><span class="o">=</span><span class="s2">&quot;cell_label&quot;</span><span class="p">)</span>
<span class="c1"># Define as mixed if fraction of cells in nhood with same label is lower than 0.75</span>

<span class="n">mdata</span><span class="p">[</span><span class="s2">&quot;milo&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
    <span class="n">mdata</span><span class="p">[</span><span class="s2">&quot;milo&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">var</span><span class="p">[</span><span class="s2">&quot;nhood_annotation_frac&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">0.75</span><span class="p">,</span> <span class="s2">&quot;nhood_annotation&quot;</span>
<span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Mixed&quot;</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">milo</span><span class="o">.</span><span class="n">plot_da_beeswarm</span><span class="p">(</span><span class="n">mdata</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/eb7b75f606c891f63454bf9b86910b519958d77343015d62b4f30980abcfa0de.png" src="../_images/eb7b75f606c891f63454bf9b86910b519958d77343015d62b4f30980abcfa0de.png" />
</div>
</div>
<div class="admonition-what-about-the-compositional-effect admonition">
<p class="admonition-title">What about the compositional effect?</p>
<p>Comparing the Milo results to the scCODA results, here we identify a strong enrichment upon <em>Salmonella</em> infection in the Enterocytes, but also a depletion in a subset of Stem cells, similarly to what the original authors reported<span id="id24">[<a class="reference internal" href="#id343" title="Adam L. Haber, Moshe Biton, Noga Rogel, Rebecca H. Herbst, Karthik Shekhar, Christopher Smillie, Grace Burgin, Toni M. Delorey, Michael R. Howitt, Yarden Katz, Itay Tirosh, Semir Beyaz, Danielle Dionne, Mei Zhang, Raktima Raychowdhury, Wendy S. Garrett, Orit Rozenblatt-Rosen, Hai Ning Shi, Omer Yilmaz, Ramnik J. Xavier, and Aviv Regev. A single-cell survey of the small intestinal epithelium. Nature, 551(7680):333-339, Nov 2017. URL: https://doi.org/10.1038/nature24489, doi:10.1038/nature24489.">Haber <em>et al.</em>, 2017</a>]</span>. Although we don’t have a ground truth to verify whether the decrease in abundance of stem cells is real, it’s important to note that the GLM in Milo doesn’t explicitly model the compositional nature of cell abundances in neighborhoods, so in theory the results could be affected by compositional biases. In practice, performing a test on a large number of neighbourhoods alleviates this issue, since the effect in the opposite direction is distributed across thousands of neighborhoods rather than tens of cell types. Additionally, the test used in Milo uses the trimmed mean of M values normalization method (TMM normalization <span id="id25">[<a class="reference internal" href="#id359" title="Mark D. Robinson and Alicia Oshlack. A scaling normalization method for differential expression analysis of RNA-seq data. Genome Biology, 11(3):R25, March 2010. doi:10.1186/gb-2010-11-3-r25.">Robinson and Oshlack, 2010</a>]</span>) to estimate normalization factors robust to compositional differences across samples. In this particular example, residual compositional effects might be explained by (A) the relatively small number of neighborhoods (&lt; 1000), (B) the very large effect size in Enterocyte neighbourhoods or (C) the very small number of replicates per condition.</p>
</div>
<p>Of note, the GLM framework used by Milo allows to test for cell enrichment/depletion also for continuous covariates. We demonstrate this by testing for differential abundance along the <em>Heligmosomoides polygyrus</em> infection time course.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">## Turn into continuous variable</span>
<span class="n">mdata</span><span class="p">[</span><span class="s2">&quot;rna&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;Hpoly_timecourse&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">mdata</span><span class="p">[</span><span class="s2">&quot;rna&quot;</span><span class="p">]</span>
    <span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;condition&quot;</span><span class="p">]</span>
    <span class="o">.</span><span class="n">cat</span><span class="o">.</span><span class="n">reorder_categories</span><span class="p">([</span><span class="s2">&quot;Salmonella&quot;</span><span class="p">,</span> <span class="s2">&quot;Control&quot;</span><span class="p">,</span> <span class="s2">&quot;Hpoly.Day3&quot;</span><span class="p">,</span> <span class="s2">&quot;Hpoly.Day10&quot;</span><span class="p">])</span>
<span class="p">)</span>
<span class="n">mdata</span><span class="p">[</span><span class="s2">&quot;rna&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;Hpoly_timecourse&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mdata</span><span class="p">[</span><span class="s2">&quot;rna&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;Hpoly_timecourse&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">cat</span><span class="o">.</span><span class="n">codes</span>

<span class="c1">## Here we exclude salmonella samples</span>
<span class="n">test_samples</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">mdata</span><span class="p">[</span><span class="s2">&quot;rna&quot;</span><span class="p">]</span>
    <span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">batch</span><span class="p">[</span><span class="n">mdata</span><span class="p">[</span><span class="s2">&quot;rna&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">condition</span> <span class="o">!=</span> <span class="s2">&quot;Salmonella&quot;</span><span class="p">]</span>
    <span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;str&quot;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">unique</span><span class="p">()</span>
<span class="p">)</span>
<span class="n">milo</span><span class="o">.</span><span class="n">da_nhoods</span><span class="p">(</span><span class="n">mdata</span><span class="p">,</span> <span class="n">design</span><span class="o">=</span><span class="s2">&quot;~ Hpoly_timecourse&quot;</span><span class="p">,</span> <span class="n">subset_samples</span><span class="o">=</span><span class="n">test_samples</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plot_milo_diagnostics</span><span class="p">(</span><span class="n">mdata</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/33bd3d35b43d3d61782069476ab79e7892d1676f18921a407ae42fc34ba50509.png" src="../_images/33bd3d35b43d3d61782069476ab79e7892d1676f18921a407ae42fc34ba50509.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">matplotlib</span><span class="o">.</span><span class="n">rc_context</span><span class="p">({</span><span class="s2">&quot;figure.figsize&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">]}):</span>
    <span class="n">milo</span><span class="o">.</span><span class="n">plot_nhood_graph</span><span class="p">(</span><span class="n">mdata</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">min_size</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">plot_edges</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/1a426461c9e6667080b2627acbd086b2489ed1e1ed73f2afccc96ce69f18884a.png" src="../_images/1a426461c9e6667080b2627acbd086b2489ed1e1ed73f2afccc96ce69f18884a.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">milo</span><span class="o">.</span><span class="n">plot_da_beeswarm</span><span class="p">(</span><span class="n">mdata</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/eee8e93d829a904624b9d86527be9ef015ffa479199432ab315e6db00ea6cb36.png" src="../_images/eee8e93d829a904624b9d86527be9ef015ffa479199432ab315e6db00ea6cb36.png" />
</div>
</div>
<p>We can verify that the test captures a linear increase in cell numbers across the time course by plotting the number of cells per sample by condition in neighborhoods where significant enrichment or depletion was detected.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">entero_ixs</span> <span class="o">=</span> <span class="n">mdata</span><span class="p">[</span><span class="s2">&quot;milo&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">var_names</span><span class="p">[</span>
    <span class="p">(</span><span class="n">mdata</span><span class="p">[</span><span class="s2">&quot;milo&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">var</span><span class="p">[</span><span class="s2">&quot;SpatialFDR&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">0.1</span><span class="p">)</span>
    <span class="o">&amp;</span> <span class="p">(</span><span class="n">mdata</span><span class="p">[</span><span class="s2">&quot;milo&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">var</span><span class="p">[</span><span class="s2">&quot;logFC&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
    <span class="o">&amp;</span> <span class="p">(</span><span class="n">mdata</span><span class="p">[</span><span class="s2">&quot;milo&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">var</span><span class="p">[</span><span class="s2">&quot;nhood_annotation&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Enterocyte&quot;</span><span class="p">)</span>
<span class="p">]</span>

<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Enterocyte&quot;</span><span class="p">)</span>
<span class="n">milo</span><span class="o">.</span><span class="n">plot_nhood_counts_by_cond</span><span class="p">(</span>
    <span class="n">mdata</span><span class="p">,</span> <span class="n">test_var</span><span class="o">=</span><span class="s2">&quot;Hpoly_timecourse&quot;</span><span class="p">,</span> <span class="n">subset_nhoods</span><span class="o">=</span><span class="n">entero_ixs</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>


<span class="n">tuft_ixs</span> <span class="o">=</span> <span class="n">mdata</span><span class="p">[</span><span class="s2">&quot;milo&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">var_names</span><span class="p">[</span>
    <span class="p">(</span><span class="n">mdata</span><span class="p">[</span><span class="s2">&quot;milo&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">var</span><span class="p">[</span><span class="s2">&quot;SpatialFDR&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">0.1</span><span class="p">)</span>
    <span class="o">&amp;</span> <span class="p">(</span><span class="n">mdata</span><span class="p">[</span><span class="s2">&quot;milo&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">var</span><span class="p">[</span><span class="s2">&quot;logFC&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
    <span class="o">&amp;</span> <span class="p">(</span><span class="n">mdata</span><span class="p">[</span><span class="s2">&quot;milo&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">var</span><span class="p">[</span><span class="s2">&quot;nhood_annotation&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Tuft&quot;</span><span class="p">)</span>
<span class="p">]</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Tuft cells&quot;</span><span class="p">)</span>
<span class="n">milo</span><span class="o">.</span><span class="n">plot_nhood_counts_by_cond</span><span class="p">(</span>
    <span class="n">mdata</span><span class="p">,</span> <span class="n">test_var</span><span class="o">=</span><span class="s2">&quot;Hpoly_timecourse&quot;</span><span class="p">,</span> <span class="n">subset_nhoods</span><span class="o">=</span><span class="n">tuft_ixs</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/cfc8f2c0b7367412501dde3f65c5a0f44344af80db586dfb123a2bf0261fffd0.png" src="../_images/cfc8f2c0b7367412501dde3f65c5a0f44344af80db586dfb123a2bf0261fffd0.png" />
<img alt="../_images/3f98c0df87f39369722c6dd47bc5ae2ccd18a381cae0558a75ee52120167cbb2.png" src="../_images/3f98c0df87f39369722c6dd47bc5ae2ccd18a381cae0558a75ee52120167cbb2.png" />
</div>
</div>
<p>Interestingly the DA test on the neighbourhoods detects an enrichment upon infection in Tuft cells and in a subset of goblet cells. We can characterize the difference between cell type subpopulations enriched upon infection by examining the mean gene expression profiles of cells in neighbourhoods. For example, if we take the neighbourhoods of Goblet cells, we can see that neighbourhoods enriched upon infection display a higher expression of Retnlb, which is a gene implicated in anti-parasitic immunity <span id="id26">[<a class="reference internal" href="#id343" title="Adam L. Haber, Moshe Biton, Noga Rogel, Rebecca H. Herbst, Karthik Shekhar, Christopher Smillie, Grace Burgin, Toni M. Delorey, Michael R. Howitt, Yarden Katz, Itay Tirosh, Semir Beyaz, Danielle Dionne, Mei Zhang, Raktima Raychowdhury, Wendy S. Garrett, Orit Rozenblatt-Rosen, Hai Ning Shi, Omer Yilmaz, Ramnik J. Xavier, and Aviv Regev. A single-cell survey of the small intestinal epithelium. Nature, 551(7680):333-339, Nov 2017. URL: https://doi.org/10.1038/nature24489, doi:10.1038/nature24489.">Haber <em>et al.</em>, 2017</a>]</span>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">## Compute average Retnlb expression per neighbourhood</span>
<span class="c1"># (you can add mean expression for all genes using milo.utils.add_nhood_expression)</span>
<span class="n">mdata</span><span class="p">[</span><span class="s2">&quot;rna&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;Retnlb_expression&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">mdata</span><span class="p">[</span><span class="s2">&quot;rna&quot;</span><span class="p">][:,</span> <span class="s2">&quot;Retnlb&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="s2">&quot;logcounts&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">toarray</span><span class="p">()</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
<span class="p">)</span>
<span class="n">milo</span><span class="o">.</span><span class="n">annotate_nhoods_continuous</span><span class="p">(</span><span class="n">mdata</span><span class="p">,</span> <span class="s2">&quot;Retnlb_expression&quot;</span><span class="p">)</span>
<span class="c1"># milo.annotate_nhoods(mdata, &quot;Retnlb_expression&quot;)</span>

<span class="c1">## Subset to Goblet cell neighbourhoods</span>
<span class="n">nhood_df</span> <span class="o">=</span> <span class="n">mdata</span><span class="p">[</span><span class="s2">&quot;milo&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">nhood_df</span> <span class="o">=</span> <span class="n">nhood_df</span><span class="p">[</span><span class="n">nhood_df</span><span class="p">[</span><span class="s2">&quot;nhood_annotation&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Goblet&quot;</span><span class="p">]</span>

<span class="n">sns</span><span class="o">.</span><span class="n">scatterplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">nhood_df</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s2">&quot;logFC&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">&quot;nhood_Retnlb_expression&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/b895553d323bf705f72190c5da139ee691fd3c0a14d3c464d79541091585539f.png" src="../_images/b895553d323bf705f72190c5da139ee691fd3c0a14d3c464d79541091585539f.png" />
</div>
</div>
<blockquote>
<div><p><strong>Accounting for confounding covariates:</strong> several confounding factors might affect cell abundances and proportions other than our condition of interest. For example, different set of samples might have been processed or sequenced in the same batch, or a set of samples could contain cells FAC-sorted using different markers to enrich a subset of populations of interest. As long as these factors are not completely correlated with the condition of interest, we can include these covariates in the model used for differential abundance testing, to estimate differential abundance associated with the condition of interest, while minimizing differences explained by the confounding factors. In Milo, we can express this type of test design using the syntax <code class="docutils literal notranslate"><span class="pre">~</span> <span class="pre">confounder</span> <span class="pre">+</span> <span class="pre">condition</span></code>.</p>
</div></blockquote>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">## Make dummy confounder for the sake of this example</span>
<span class="n">nhood_adata</span> <span class="o">=</span> <span class="n">mdata</span><span class="p">[</span><span class="s2">&quot;milo&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">conf_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
    <span class="nb">zip</span><span class="p">(</span>
        <span class="n">nhood_adata</span><span class="o">.</span><span class="n">obs_names</span><span class="p">,</span>
        <span class="n">rng</span><span class="o">.</span><span class="n">choice</span><span class="p">([</span><span class="s2">&quot;group1&quot;</span><span class="p">,</span> <span class="s2">&quot;group2&quot;</span><span class="p">],</span> <span class="n">nhood_adata</span><span class="o">.</span><span class="n">n_obs</span><span class="p">),</span>
    <span class="p">)</span>
<span class="p">)</span>
<span class="n">mdata</span><span class="p">[</span><span class="s2">&quot;rna&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;dummy_confounder&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">conf_dict</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">mdata</span><span class="p">[</span><span class="s2">&quot;rna&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;batch&quot;</span><span class="p">]]</span>

<span class="n">milo</span><span class="o">.</span><span class="n">da_nhoods</span><span class="p">(</span><span class="n">mdata</span><span class="p">,</span> <span class="n">design</span><span class="o">=</span><span class="s2">&quot;~ dummy_confounder+condition&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mdata</span><span class="p">[</span><span class="s2">&quot;milo&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">var</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>index_cell</th>
      <th>kth_distance</th>
      <th>SpatialFDR</th>
      <th>Sig</th>
      <th>Nhood_size</th>
      <th>nhood_annotation</th>
      <th>nhood_annotation_frac</th>
      <th>nhood_Retnlb_expression</th>
      <th>logFC</th>
      <th>logCPM</th>
      <th>F</th>
      <th>PValue</th>
      <th>FDR</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>B1_AAAGGCCTAAGGCG_Control_Stem</td>
      <td>1.304513</td>
      <td>0.056105</td>
      <td>False</td>
      <td>53.0</td>
      <td>Stem</td>
      <td>0.830189</td>
      <td>0.033807</td>
      <td>-3.696119</td>
      <td>10.690300</td>
      <td>9.083460</td>
      <td>0.002595</td>
      <td>0.066143</td>
    </tr>
    <tr>
      <th>1</th>
      <td>B1_AACACGTGATGCTG_Control_TA.Early</td>
      <td>1.335187</td>
      <td>0.938353</td>
      <td>False</td>
      <td>67.0</td>
      <td>Mixed</td>
      <td>0.477612</td>
      <td>0.020691</td>
      <td>-0.248959</td>
      <td>10.926409</td>
      <td>0.078934</td>
      <td>0.778762</td>
      <td>0.941976</td>
    </tr>
    <tr>
      <th>2</th>
      <td>B1_AACTTGCTGGTATC_Control_Enterocyte</td>
      <td>1.519376</td>
      <td>0.693653</td>
      <td>False</td>
      <td>49.0</td>
      <td>Enterocyte</td>
      <td>1.000000</td>
      <td>0.000000</td>
      <td>0.951949</td>
      <td>10.727155</td>
      <td>1.416844</td>
      <td>0.233993</td>
      <td>0.720537</td>
    </tr>
    <tr>
      <th>3</th>
      <td>B1_AAGAACGATGACTG_Control_Enterocyte</td>
      <td>2.143153</td>
      <td>0.746709</td>
      <td>False</td>
      <td>39.0</td>
      <td>Enterocyte</td>
      <td>1.000000</td>
      <td>0.000000</td>
      <td>0.879631</td>
      <td>10.467676</td>
      <td>1.109896</td>
      <td>0.292168</td>
      <td>0.769131</td>
    </tr>
    <tr>
      <th>4</th>
      <td>B1_AATTACGAAACAGA_Control_Enterocyte.Progenitor</td>
      <td>1.600587</td>
      <td>0.436180</td>
      <td>False</td>
      <td>37.0</td>
      <td>Enterocyte.Progenitor</td>
      <td>0.945946</td>
      <td>0.000000</td>
      <td>-2.440105</td>
      <td>10.296494</td>
      <td>3.202427</td>
      <td>0.073604</td>
      <td>0.478744</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>803</th>
      <td>B10_TTAGGTCTAGACTC_Salmonella_Goblet</td>
      <td>1.547428</td>
      <td>0.400895</td>
      <td>False</td>
      <td>48.0</td>
      <td>Goblet</td>
      <td>1.000000</td>
      <td>0.126426</td>
      <td>1.931002</td>
      <td>10.566431</td>
      <td>3.591423</td>
      <td>0.058150</td>
      <td>0.443255</td>
    </tr>
    <tr>
      <th>804</th>
      <td>B10_TTAGTCACCATGGT_Salmonella_TA.Early</td>
      <td>1.348982</td>
      <td>0.880493</td>
      <td>False</td>
      <td>64.0</td>
      <td>TA.Early</td>
      <td>0.875000</td>
      <td>0.010830</td>
      <td>-0.553709</td>
      <td>10.876626</td>
      <td>0.342947</td>
      <td>0.558166</td>
      <td>0.886244</td>
    </tr>
    <tr>
      <th>805</th>
      <td>B10_TTATGGCTTAACGC_Salmonella_TA.Early</td>
      <td>1.357123</td>
      <td>0.981884</td>
      <td>False</td>
      <td>51.0</td>
      <td>TA.Early</td>
      <td>0.862745</td>
      <td>0.000000</td>
      <td>0.071987</td>
      <td>10.649724</td>
      <td>0.007052</td>
      <td>0.933080</td>
      <td>0.982928</td>
    </tr>
    <tr>
      <th>806</th>
      <td>B10_TTCATCGACCGTAA_Salmonella_TA.Early</td>
      <td>1.313244</td>
      <td>0.908718</td>
      <td>False</td>
      <td>66.0</td>
      <td>TA.Early</td>
      <td>0.787879</td>
      <td>0.021004</td>
      <td>-0.403998</td>
      <td>10.825716</td>
      <td>0.176318</td>
      <td>0.674579</td>
      <td>0.916060</td>
    </tr>
    <tr>
      <th>807</th>
      <td>B10_TTGAACCTCATTTC_Salmonella_TA.Early</td>
      <td>1.333960</td>
      <td>0.787177</td>
      <td>False</td>
      <td>55.0</td>
      <td>Mixed</td>
      <td>0.454545</td>
      <td>0.012603</td>
      <td>0.774925</td>
      <td>10.712952</td>
      <td>0.811296</td>
      <td>0.367791</td>
      <td>0.805382</td>
    </tr>
  </tbody>
</table>
<p>808 rows × 13 columns</p>
</div></div></div>
</div>
</section>
</section>
<section id="quiz">
<h2><span class="section-number">17.7. </span>Quiz<a class="headerlink" href="#quiz" title="Link to this heading">#</a></h2>
<div class="cell tag_remove_input docutils container">
<div class="cell_output docutils container">
<div class="output text_html">
    <style>
        .output.text_html {
            --pst-color-text-base: transparent !important;
        }
        .flip-card-q1 {
            background-color: transparent;
            width: 350px;
            height: 200px;
            perspective: 1000px;
            display: inline-block;
            margin: 10px;
            text-align: center;
            padding: 10px;
        }
        .flip-card-inner-q1 {
            position: relative;
            width: 100%;
            height: 100%;
            text-align: center;
            transition: transform 0.6s;
            transform-style: preserve-3d;
            transform-origin: center;
        }
        .flip-card-q1:hover .flip-card-inner-q1 {
            transform: rotateY(180deg);
        }
        .flip-card-front-q1, .flip-card-back-q1 {
            position: absolute;
            width: 100%;
            height: 100%;
            min-height: 200px;
            backface-visibility: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            padding: 20px;
            border-radius: 15px;
            box-sizing: border-box;
            overflow: hidden;
            text-align: center;
        }
        .flip-card-front-q1 {
            background-color: #3965a3;
            font-size: 20px;
        }
        .flip-card-back-q1 {
            background-color: #a8d480;
            transform: rotateY(180deg);
            font-size: 15px;
        }_b
    </style>

    <div class="flip-card-q1">
        <div class="flip-card-inner-q1">
            <div class="flip-card-front-q1">
                It is tricky to deduce compositional changes visually. Why?
            </div>
            <div class="flip-card-back-q1">
                Interpreting compositional changes visually is challenging because shifts in cell type proportions may be subtle or confounded by the high dimensionality and variability inherent in single-cell data, making it difficult to discern significant differences without statistical analysis.
            </div>
        </div>
    </div>
    <noscript>
        <p><strong>Q:</strong> It is tricky to deduce compositional changes visually. Why?</p>
        <p><strong>Answer:</strong> Interpreting compositional changes visually is challenging because shifts in cell type proportions may be subtle or confounded by the high dimensionality and variability inherent in single-cell data, making it difficult to discern significant differences without statistical analysis.</p>
    </noscript>
    </div><div class="output text_html">
    <style>
        .output.text_html {
            --pst-color-text-base: transparent !important;
        }
        .flip-card-q2 {
            background-color: transparent;
            width: 350px;
            height: 200px;
            perspective: 1000px;
            display: inline-block;
            margin: 10px;
            text-align: center;
            padding: 10px;
        }
        .flip-card-inner-q2 {
            position: relative;
            width: 100%;
            height: 100%;
            text-align: center;
            transition: transform 0.6s;
            transform-style: preserve-3d;
            transform-origin: center;
        }
        .flip-card-q2:hover .flip-card-inner-q2 {
            transform: rotateY(180deg);
        }
        .flip-card-front-q2, .flip-card-back-q2 {
            position: absolute;
            width: 100%;
            height: 100%;
            min-height: 200px;
            backface-visibility: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            padding: 20px;
            border-radius: 15px;
            box-sizing: border-box;
            overflow: hidden;
            text-align: center;
        }
        .flip-card-front-q2 {
            background-color: #3965a3;
            font-size: 20px;
        }
        .flip-card-back-q2 {
            background-color: #a8d480;
            transform: rotateY(180deg);
            font-size: 13px;
        }_b
    </style>

    <div class="flip-card-q2">
        <div class="flip-card-inner-q2">
            <div class="flip-card-front-q2">
                Why is it necessary to interpret cell type ubundances as proportions instead of absolute counts? What are the dangers of not doing so?
            </div>
            <div class="flip-card-back-q2">
                Interpreting cell type abundances as proportions rather than absolute counts is essential because the total number of cells can vary between samples; failing to account for this can lead to misleading conclusions, as apparent changes in cell counts might simply reflect differences in sample sizes rather than true biological variations.
            </div>
        </div>
    </div>
    <noscript>
        <p><strong>Q:</strong> Why is it necessary to interpret cell type ubundances as proportions instead of absolute counts? What are the dangers of not doing so?</p>
        <p><strong>Answer:</strong> Interpreting cell type abundances as proportions rather than absolute counts is essential because the total number of cells can vary between samples; failing to account for this can lead to misleading conclusions, as apparent changes in cell counts might simply reflect differences in sample sizes rather than true biological variations.</p>
    </noscript>
    </div><div class="output text_html">
    <style>
        .output.text_html {
            --pst-color-text-base: transparent !important;
        }
        .flip-card-q3 {
            background-color: transparent;
            width: 350px;
            height: 200px;
            perspective: 1000px;
            display: inline-block;
            margin: 10px;
            text-align: center;
            padding: 10px;
        }
        .flip-card-inner-q3 {
            position: relative;
            width: 100%;
            height: 100%;
            text-align: center;
            transition: transform 0.6s;
            transform-style: preserve-3d;
            transform-origin: center;
        }
        .flip-card-q3:hover .flip-card-inner-q3 {
            transform: rotateY(180deg);
        }
        .flip-card-front-q3, .flip-card-back-q3 {
            position: absolute;
            width: 100%;
            height: 100%;
            min-height: 200px;
            backface-visibility: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            padding: 20px;
            border-radius: 15px;
            box-sizing: border-box;
            overflow: hidden;
            text-align: center;
        }
        .flip-card-front-q3 {
            background-color: #3965a3;
            font-size: 20px;
        }
        .flip-card-back-q3 {
            background-color: #a8d480;
            transform: rotateY(180deg);
            font-size: 12px;
        }_b
    </style>

    <div class="flip-card-q3">
        <div class="flip-card-inner-q3">
            <div class="flip-card-front-q3">
                In which cases should tools that use cluster information, such as cell types be used, and in which cases tools that do not use cluster information?
            </div>
            <div class="flip-card-back-q3">
                Tools that utilize cluster information, such as cell types, are appropriate when distinct clusters are identifiable, allowing for targeted analysis of known populations. Conversely, methods that do not rely on clustering are beneficial when data lacks clear separations, such as during continuous developmental processes, enabling the detection of subtle changes across a spectrum of cell states.
            </div>
        </div>
    </div>
    <noscript>
        <p><strong>Q:</strong> In which cases should tools that use cluster information, such as cell types be used, and in which cases tools that do not use cluster information?</p>
        <p><strong>Answer:</strong> Tools that utilize cluster information, such as cell types, are appropriate when distinct clusters are identifiable, allowing for targeted analysis of known populations. Conversely, methods that do not rely on clustering are beneficial when data lacks clear separations, such as during continuous developmental processes, enabling the detection of subtle changes across a spectrum of cell states.</p>
    </noscript>
    </div></div>
</div>
</section>
<section id="references">
<h2><span class="section-number">17.8. </span>References<a class="headerlink" href="#references" title="Link to this heading">#</a></h2>
<div class="docutils container" id="id27">
<div role="list" class="citation-list">
<div class="citation" id="id344" role="doc-biblioentry">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id2">compAit82</a><span class="fn-bracket">]</span></span>
<p>J. Aitchison. The statistical analysis of compositional data. <em>Journal of the Royal Statistical Society: Series B (Methodological)</em>, 44(2):139–160, 1982. URL: <a class="reference external" href="https://rss.onlinelibrary.wiley.com/doi/abs/10.1111/j.2517-6161.1982.tb01195.x">https://rss.onlinelibrary.wiley.com/doi/abs/10.1111/j.2517-6161.1982.tb01195.x</a>, <a class="reference external" href="https://arxiv.org/abs/https://rss.onlinelibrary.wiley.com/doi/pdf/10.1111/j.2517-6161.1982.tb01195.x">arXiv:https://rss.onlinelibrary.wiley.com/doi/pdf/10.1111/j.2517-6161.1982.tb01195.x</a>, <a class="reference external" href="https://doi.org/https://doi.org/10.1111/j.2517-6161.1982.tb01195.x">doi:https://doi.org/10.1111/j.2517-6161.1982.tb01195.x</a>.</p>
</div>
<div class="citation" id="id353" role="doc-biblioentry">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id4">compBAH19</a><span class="fn-bracket">]</span></span>
<p>Barak Brill, Amnon Amir, and Ruth Heller. Testing for differential abundance in compositional counts data, with application to microbiome studies. <em>ArXiv</em>, April 2019. URL: <a class="reference external" href="http://arxiv.org/abs/1904.08937">http://arxiv.org/abs/1904.08937</a>, <a class="reference external" href="https://arxiv.org/abs/1904.08937">arXiv:1904.08937</a>.</p>
</div>
<div class="citation" id="id351" role="doc-biblioentry">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id21">compBST+21</a><span class="fn-bracket">]</span></span>
<p>Daniel B. Burkhardt, Jay S. Stanley, Alexander Tong, Ana Luisa Perdigoto, Scott A. Gigante, Kevan C. Herold, Guy Wolf, Antonio J. Giraldez, David van Dijk, and Smita Krishnaswamy. Quantifying the effect of experimental perturbations at single-cell resolution. <em>Nature Biotechnology</em>, 39(5):619–629, May 2021. URL: <a class="reference external" href="https://doi.org/10.1038/s41587-020-00803-5">https://doi.org/10.1038/s41587-020-00803-5</a>, <a class="reference external" href="https://doi.org/10.1038/s41587-020-00803-5">doi:10.1038/s41587-020-00803-5</a>.</p>
</div>
<div class="citation" id="id346" role="doc-biblioentry">
<span class="label"><span class="fn-bracket">[</span>compButtnerOMuller+21<span class="fn-bracket">]</span></span>
<span class="backrefs">(<a role="doc-backlink" href="#id9">1</a>,<a role="doc-backlink" href="#id10">2</a>,<a role="doc-backlink" href="#id11">3</a>)</span>
<p>M. Büttner, J. Ostner, C. L. Müller, F. J. Theis, and B. Schubert. Sccoda is a bayesian model for compositional single-cell data analysis. <em>Nature Communications</em>, 12(1):6876, Nov 2021. URL: <a class="reference external" href="https://doi.org/10.1038/s41467-021-27150-6">https://doi.org/10.1038/s41467-021-27150-6</a>, <a class="reference external" href="https://doi.org/10.1038/s41467-021-27150-6">doi:10.1038/s41467-021-27150-6</a>.</p>
</div>
<div class="citation" id="id345" role="doc-biblioentry">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id3">compCLO+19</a><span class="fn-bracket">]</span></span>
<p>Yue Cao, Yingxin Lin, John T. Ormerod, Pengyi Yang, Jean Y.H. Yang, and Kitty K. Lo. Scdc: single cell differential composition analysis. <em>BMC Bioinformatics</em>, 20(19):721, Dec 2019. URL: <a class="reference external" href="https://doi.org/10.1186/s12859-019-3211-9">https://doi.org/10.1186/s12859-019-3211-9</a>, <a class="reference external" href="https://doi.org/10.1186/s12859-019-3211-9">doi:10.1186/s12859-019-3211-9</a>.</p>
</div>
<div class="citation" id="id350" role="doc-biblioentry">
<span class="label"><span class="fn-bracket">[</span>compDHT+22<span class="fn-bracket">]</span></span>
<span class="backrefs">(<a role="doc-backlink" href="#id20">1</a>,<a role="doc-backlink" href="#id22">2</a>)</span>
<p>Emma Dann, Neil C. Henderson, Sarah A. Teichmann, Michael D. Morgan, and John C. Marioni. Differential abundance testing on single-cell data using k-nearest neighbor graphs. <em>Nature Biotechnology</em>, 40(2):245–253, Feb 2022. URL: <a class="reference external" href="https://doi.org/10.1038/s41587-021-01033-z">https://doi.org/10.1038/s41587-021-01033-z</a>, <a class="reference external" href="https://doi.org/10.1038/s41587-021-01033-z">doi:10.1038/s41587-021-01033-z</a>.</p>
</div>
<div class="citation" id="id354" role="doc-biblioentry">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id5">compEPGMFBarceloV03</a><span class="fn-bracket">]</span></span>
<p>J J Egozcue, V Pawlowsky-Glahn, G Mateu-Figueras, and C Barceló-Vidal. Isometric logratio transformations for compositional data analysis. <em>Math. Geol.</em>, 35(3):279–300, April 2003. URL: <a class="reference external" href="https://doi.org/10.1023/A:1023818214614">https://doi.org/10.1023/A:1023818214614</a>, <a class="reference external" href="https://doi.org/10.1023/A:1023818214614">doi:10.1023/A:1023818214614</a>.</p>
</div>
<div class="citation" id="id357" role="doc-biblioentry">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id8">compFRM+14</a><span class="fn-bracket">]</span></span>
<p>Andrew D Fernandes, Jennifer Ns Reid, Jean M Macklaim, Thomas A McMurrough, David R Edgell, and Gregory B Gloor. Unifying the analysis of high-throughput sequencing datasets: characterizing RNA-seq, 16S rRNA gene sequencing and selective growth experiments by compositional data analysis. <em>Microbiome</em>, 2:15, May 2014. URL: <a class="reference external" href="http://dx.doi.org/10.1186/2049-2618-2-15">http://dx.doi.org/10.1186/2049-2618-2-15</a>, <a class="reference external" href="https://doi.org/10.1186/2049-2618-2-15">doi:10.1186/2049-2618-2-15</a>.</p>
</div>
<div class="citation" id="id355" role="doc-biblioentry">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id6">compGMPGE17</a><span class="fn-bracket">]</span></span>
<p>Gregory B Gloor, Jean M Macklaim, Vera Pawlowsky-Glahn, and Juan J Egozcue. Microbiome datasets are compositional: and this is not optional. <em>Front. Microbiol.</em>, 8:2224, November 2017. URL: <a class="reference external" href="http://dx.doi.org/10.3389/fmicb.2017.02224">http://dx.doi.org/10.3389/fmicb.2017.02224</a>, <a class="reference external" href="https://doi.org/10.3389/fmicb.2017.02224">doi:10.3389/fmicb.2017.02224</a>.</p>
</div>
<div class="citation" id="id343" role="doc-biblioentry">
<span class="label"><span class="fn-bracket">[</span>compHBR+17<span class="fn-bracket">]</span></span>
<span class="backrefs">(<a role="doc-backlink" href="#id1">1</a>,<a role="doc-backlink" href="#id12">2</a>,<a role="doc-backlink" href="#id13">3</a>,<a role="doc-backlink" href="#id14">4</a>,<a role="doc-backlink" href="#id24">5</a>,<a role="doc-backlink" href="#id26">6</a>)</span>
<p>Adam L. Haber, Moshe Biton, Noga Rogel, Rebecca H. Herbst, Karthik Shekhar, Christopher Smillie, Grace Burgin, Toni M. Delorey, Michael R. Howitt, Yarden Katz, Itay Tirosh, Semir Beyaz, Danielle Dionne, Mei Zhang, Raktima Raychowdhury, Wendy S. Garrett, Orit Rozenblatt-Rosen, Hai Ning Shi, Omer Yilmaz, Ramnik J. Xavier, and Aviv Regev. A single-cell survey of the small intestinal epithelium. <em>Nature</em>, 551(7680):333–339, Nov 2017. URL: <a class="reference external" href="https://doi.org/10.1038/nature24489">https://doi.org/10.1038/nature24489</a>, <a class="reference external" href="https://doi.org/10.1038/nature24489">doi:10.1038/nature24489</a>.</p>
</div>
<div class="citation" id="id356" role="doc-biblioentry">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id7">compLP20</a><span class="fn-bracket">]</span></span>
<p>Huang Lin and Shyamal Das Peddada. Analysis of compositions of microbiomes with bias correction. <em>Nat. Commun.</em>, 11(1):3514, July 2020. URL: <a class="reference external" href="http://dx.doi.org/10.1038/s41467-020-17041-7">http://dx.doi.org/10.1038/s41467-020-17041-7</a>, <a class="reference external" href="https://doi.org/10.1038/s41467-020-17041-7">doi:10.1038/s41467-020-17041-7</a>.</p>
</div>
<div class="citation" id="id358" role="doc-biblioentry">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id23">compLRM17</a><span class="fn-bracket">]</span></span>
<p>Aaron T. L. Lun, Arianne C. Richard, and John C. Marioni. Testing for differential abundance in mass cytometry data. <em>Nature Methods</em>, 14(7):707–709, July 2017. <a class="reference external" href="https://doi.org/10.1038/nmeth.4295">doi:10.1038/nmeth.4295</a>.</p>
</div>
<div class="citation" id="id352" role="doc-biblioentry">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id16">compMGC21</a><span class="fn-bracket">]</span></span>
<p>Leonardo Morelli, Valentina Giansanti, and Davide Cittaro. Nested stochastic block models applied to the analysis of single cell data. <em>BMC Bioinformatics</em>, 22(1):576, November 2021. URL: <a class="reference external" href="http://dx.doi.org/10.1186/s12859-021-04489-7">http://dx.doi.org/10.1186/s12859-021-04489-7</a>, <a class="reference external" href="https://doi.org/10.1186/s12859-021-04489-7">doi:10.1186/s12859-021-04489-7</a>.</p>
</div>
<div class="citation" id="id347" role="doc-biblioentry">
<span class="label"><span class="fn-bracket">[</span>compOCM21<span class="fn-bracket">]</span></span>
<span class="backrefs">(<a role="doc-backlink" href="#id15">1</a>,<a role="doc-backlink" href="#id17">2</a>)</span>
<p>Johannes Ostner, Salomé Carcy, and Christian L. Müller. Tasccoda: bayesian tree-aggregated analysis of compositional amplicon and single-cell data. <em>Frontiers in Genetics</em>, 2021. URL: <a class="reference external" href="https://www.frontiersin.org/article/10.3389/fgene.2021.766405">https://www.frontiersin.org/article/10.3389/fgene.2021.766405</a>, <a class="reference external" href="https://doi.org/10.3389/fgene.2021.766405">doi:10.3389/fgene.2021.766405</a>.</p>
</div>
<div class="citation" id="id359" role="doc-biblioentry">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id25">compRO10</a><span class="fn-bracket">]</span></span>
<p>Mark D. Robinson and Alicia Oshlack. A scaling normalization method for differential expression analysis of RNA-seq data. <em>Genome Biology</em>, 11(3):R25, March 2010. <a class="reference external" href="https://doi.org/10.1186/gb-2010-11-3-r25">doi:10.1186/gb-2010-11-3-r25</a>.</p>
</div>
<div class="citation" id="id348" role="doc-biblioentry">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id18">compSSH+22</a><span class="fn-bracket">]</span></span>
<p>Stefan Salcher, Gregor Sturm, Lena Horvath, Gerold Untergasser, Georgios Fotakis, Elisa Panizzolo, Agnieszka Martowicz, Georg Pall, Gabriele Gamerith, Martina Sykora, Florian Augustin, Katja Schmitz, Francesca Finotello, Dietmar Rieder, Sieghart Sopper, Dominik Wolf, Andreas Pircher, and Zlatko Trajanoski. High-resolution single-cell atlas reveals diversity and plasticity of tissue-resident neutrophils in non-small cell lung cancer. <em>bioRxiv</em>, 2022. URL: <a class="reference external" href="https://www.biorxiv.org/content/early/2022/05/10/2022.05.09.491204">https://www.biorxiv.org/content/early/2022/05/10/2022.05.09.491204</a>, <a class="reference external" href="https://arxiv.org/abs/https://www.biorxiv.org/content/early/2022/05/10/2022.05.09.491204.full.pdf">arXiv:https://www.biorxiv.org/content/early/2022/05/10/2022.05.09.491204.full.pdf</a>, <a class="reference external" href="https://doi.org/10.1101/2022.05.09.491204">doi:10.1101/2022.05.09.491204</a>.</p>
</div>
<div class="citation" id="id349" role="doc-biblioentry">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id19">compZJL+21</a><span class="fn-bracket">]</span></span>
<p>Jun Zhao, Ariel Jaffe, Henry Li, Ofir Lindenbaum, Esen Sefik, Ruaidhrí Jackson, Xiuyuan Cheng, Richard A. Flavell, and Yuval Kluger. Detection of differentially abundant cell subpopulations in scrna-seq data. <em>Proceedings of the National Academy of Sciences</em>, 118(22):e2100293118, 2021. URL: <a class="reference external" href="https://www.pnas.org/doi/abs/10.1073/pnas.2100293118">https://www.pnas.org/doi/abs/10.1073/pnas.2100293118</a>, <a class="reference external" href="https://arxiv.org/abs/https://www.pnas.org/doi/pdf/10.1073/pnas.2100293118">arXiv:https://www.pnas.org/doi/pdf/10.1073/pnas.2100293118</a>, <a class="reference external" href="https://doi.org/10.1073/pnas.2100293118">doi:10.1073/pnas.2100293118</a>.</p>
</div>
</div>
</div>
</section>
<section id="contributors">
<h2><span class="section-number">17.9. </span>Contributors<a class="headerlink" href="#contributors" title="Link to this heading">#</a></h2>
<p>We gratefully acknowledge the contributions of:</p>
<section id="authors">
<h3><span class="section-number">17.9.1. </span>Authors<a class="headerlink" href="#authors" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p>Johannes Ostner</p></li>
<li><p>Emma Dann</p></li>
<li><p>Lukas Heumos</p></li>
<li><p>Anastasia Litinetskaya</p></li>
</ul>
</section>
<section id="reviewers">
<h3><span class="section-number">17.9.2. </span>Reviewers<a class="headerlink" href="#reviewers" title="Link to this heading">#</a></h3>
</section>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./conditions"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="differential_gene_expression.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title"><span class="section-number">16. </span>Differential gene expression analysis</p>
      </div>
    </a>
    <a class="right-next"
       href="gsea_pathway.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title"><span class="section-number">18. </span>Gene set enrichment and pathway analysis</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#motivation">17.1. Motivation</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#data-loading">17.2. Data loading</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#why-cell-type-count-data-is-compositional">17.3. Why cell-type count data is compositional</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#with-labeled-clusters">17.4. With labeled clusters</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#with-labeled-clusters-and-hierarchical-structure">17.5. With labeled clusters and hierarchical structure</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#without-labeled-clusters">17.6. Without labeled clusters</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#define-neighbourhoods">17.6.1. Define neighbourhoods</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#count-cells-in-neighbourhoods">17.6.2. Count cells in neighbourhoods</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#run-differential-abundance-test-on-neighbourhoods">17.6.3. Run differential abundance test on neighbourhoods</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#quiz">17.7. Quiz</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#references">17.8. References</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#contributors">17.9. Contributors</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#authors">17.9.1. Authors</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#reviewers">17.9.2. Reviewers</a></li>
</ul>
</li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Lukas Heumos, Anna Schaar, single-cell best practices consortium
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2023.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
<div class="extra_footer">
  <div>
  Brought to you by
  <a href="https://www.github.com/theislab">Theislab</a>, with many thanks to the single-cell community as a whole!
</div>

</div>
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>