
<!DOCTYPE html>


<html lang="en" data-content_root="../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>11. Annotation &#8212; Single-cell best practices</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/sphinx-book-theme.css?v=eba8b062" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css?v=9c3e77be" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.8ecb98da25f57f5357bf6f572d296f466b2cfe2517ffebfabe82451661e28f02.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-design.min.css?v=95c83b7e" />
    <link rel="stylesheet" type="text/css" href="../_static/book.css?v=148c11e2" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="../_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="../_static/doctools.js?v=9a2dae69"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../_static/copybutton.js?v=f281be69"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js?v=1ae7504c"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../_static/design-tabs.js?v=f930bc37"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="../_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'cellular_structure/annotation';</script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="../_static/book.js?v=57d67cd3"></script>
    <link rel="icon" href="../_static/favicon.ico"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="12. Data integration" href="integration.html" />
    <link rel="prev" title="10. Clustering" href="clustering.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="../preamble.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../_static/logo.png" class="logo__image only-light" alt="Single-cell best practices - Home"/>
    <script>document.write(`<img src="../_static/logo.png" class="logo__image only-dark" alt="Single-cell best practices - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Introduction</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../introduction/prior_art.html">1. Prior art</a></li>
<li class="toctree-l1"><a class="reference internal" href="../introduction/scrna_seq.html">2. Single-cell RNA sequencing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../introduction/raw_data_processing.html">3. Raw data processing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../introduction/analysis_tools.html">4. Analysis frameworks and tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../introduction/interoperability.html">5. Interoperability</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Preprocessing and visualization</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../preprocessing_visualization/quality_control.html">6. Quality Control</a></li>
<li class="toctree-l1"><a class="reference internal" href="../preprocessing_visualization/normalization.html">7. Normalization</a></li>
<li class="toctree-l1"><a class="reference internal" href="../preprocessing_visualization/feature_selection.html">8. Feature selection</a></li>
<li class="toctree-l1"><a class="reference internal" href="../preprocessing_visualization/dimensionality_reduction.html">9. Dimensionality Reduction</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Identifying cellular structure</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="clustering.html">10. Clustering</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">11. Annotation</a></li>
<li class="toctree-l1"><a class="reference internal" href="integration.html">12. Data integration</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Inferring trajectories</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../trajectories/pseudotemporal.html">13. Pseudotemporal ordering</a></li>
<li class="toctree-l1"><a class="reference internal" href="../trajectories/rna_velocity.html">14. RNA velocity</a></li>
<li class="toctree-l1"><a class="reference internal" href="../trajectories/lineage_tracing.html">15. Lineage tracing</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Dealing with conditions</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../conditions/differential_gene_expression.html">16. Differential gene expression analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="../conditions/compositional.html">17. Compositional analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="../conditions/gsea_pathway.html">18. Gene set enrichment and pathway analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="../conditions/perturbation_modeling.html">19. Perturbation modeling</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Modeling mechanisms</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../mechanisms/gene_regulatory_networks.html">20. Gene regulatory networks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mechanisms/cell_cell_communication.html">21. Cell-cell communication</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Deconvolution</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../deconvolution/bulk_deconvolution.html">22. Bulk deconvolution</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Chromatin Accessibility</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../chromatin_accessibility/introduction.html">23. Single-cell ATAC sequencing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../chromatin_accessibility/quality_control.html">24. Quality Control</a></li>
<li class="toctree-l1"><a class="reference internal" href="../chromatin_accessibility/gene_regulatory_networks_atac.html">25. Gene regulatory networks</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Spatial omics</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../spatial/introduction.html">26. Single-cell data resolved in space</a></li>
<li class="toctree-l1"><a class="reference internal" href="../spatial/neighborhood.html">27. Neighborhood analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="../spatial/domains.html">28. Spatial domains</a></li>
<li class="toctree-l1"><a class="reference internal" href="../spatial/spatially_variable_genes.html">29. Spatially variable genes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../spatial/deconvolution.html">30. Spatial deconvolution</a></li>
<li class="toctree-l1"><a class="reference internal" href="../spatial/imputation.html">31. Imputation</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Surface protein</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../surface_protein/quality_control.html">32. Quality control</a></li>
<li class="toctree-l1"><a class="reference internal" href="../surface_protein/normalization.html">33. Normalization</a></li>
<li class="toctree-l1"><a class="reference internal" href="../surface_protein/doublet_detection.html">34. Doublet detection</a></li>
<li class="toctree-l1"><a class="reference internal" href="../surface_protein/dimensionality_reduction.html">35. Dimensionality Reduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../surface_protein/batch_correction.html">36. Batch correction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../surface_protein/annotation.html">37. Annotation</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Adaptive immune receptor repertoire</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../air_repertoire/ir_profiling.html">38. Immune Receptor Profiling</a></li>
<li class="toctree-l1"><a class="reference internal" href="../air_repertoire/clonotype.html">39. Clonotype analysis</a></li>



<li class="toctree-l1"><a class="reference internal" href="../air_repertoire/specificity.html">40. Specificity analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="../air_repertoire/multimodal_integration.html">41. Integrating AIR and transcriptomics</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Multimodal integration</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../multimodal_integration/paired_integration.html">42. Paired integration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../multimodal_integration/advanced_integration.html">43. Advanced integration</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Outlook</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../outlook.html">44. Outlook</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Acknowledgements</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../acknowledgements.html">45. Acknowledgements</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Glossary</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../glossary.html">46. Glossary</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Changelog</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../CHANGELOG.html">Changelog</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/theislab/single-cell-best-practices" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/theislab/single-cell-best-practices/edit/main/jupyter-book/cellular_structure/annotation.ipynb" target="_blank"
   class="btn btn-sm btn-source-edit-button dropdown-item"
   title="Suggest edit"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-pencil-alt"></i>
  </span>
<span class="btn__text-container">Suggest edit</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/theislab/single-cell-best-practices/issues/new?title=Issue%20on%20page%20%2Fcellular_structure/annotation.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../_sources/cellular_structure/annotation.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Annotation</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#motivation">11.1. Motivation</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#environment-setup">11.2. Environment setup</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#load-data">11.3. Load data</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#manual-annotation">11.4. Manual annotation</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#from-markers-to-cluster-annotation">11.4.1. From markers to cluster annotation</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#from-cluster-differentially-expressed-genes-to-cluster-annotation">11.4.2. From cluster differentially expressed genes to cluster annotation</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#automated-annotation">11.5. Automated annotation</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#general-remarks">11.5.1. General remarks</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#marker-gene-based-classifiers">11.5.2. Marker gene-based classifiers</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#classifiers-based-on-a-wider-set-of-genes">11.5.3. Classifiers based on a wider set of genes</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#annotation-by-mapping-to-a-reference">11.5.4. Annotation by mapping to a reference</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#references">11.6. References</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#contributors">11.7. Contributors</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#authors">11.7.1. Authors</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#reviewers">11.7.2. Reviewers</a></li>
</ul>
</li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="annotation">
<h1><span class="section-number">11. </span>Annotation<a class="headerlink" href="#annotation" title="Link to this heading">#</a></h1>
<details class="sd-sphinx-override sd-dropdown sd-card sd-mb-3">
<summary class="sd-summary-title sd-card-header">
<span class="sd-summary-text"><i class="fas fa-brain"></i>   Key takeaways</span><span class="sd-summary-state-marker sd-summary-chevron-right"><svg version="1.1" width="1.5em" height="1.5em" class="sd-octicon sd-octicon-chevron-right" viewBox="0 0 24 24" aria-hidden="true"><path d="M8.72 18.78a.75.75 0 0 1 0-1.06L14.44 12 8.72 6.28a.751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018l6.25 6.25a.75.75 0 0 1 0 1.06l-6.25 6.25a.75.75 0 0 1-1.06 0Z"></path></svg></span></summary><div class="sd-summary-content sd-card-body docutils">
<div class="sd-card sd-sphinx-override sd-mb-3 sd-shadow-sm sd-card-hover docutils">
<div class="sd-card-body docutils">
<p class="sd-card-text">Cell annotation is the process of labeling groups of cells based on known or unknown cellular phenotypes, which is crucial for understanding the cellular composition of your data.</p>
</div>
<a class="sd-stretched-link sd-hide-link-text reference internal" href="#cellular-structure-annotation-key-takeaway-1"><span class="std std-ref">Motivation</span></a></div>
<div class="sd-card sd-sphinx-override sd-mb-3 sd-shadow-sm sd-card-hover docutils">
<div class="sd-card-body docutils">
<p class="sd-card-text">Manual annotation relies on known marker genes and clustering, but it can be subjective and labor-intensive.</p>
</div>
<a class="sd-stretched-link sd-hide-link-text reference internal" href="#cellular-structure-annotation-key-takeaway-2"><span class="std std-ref">Manual annotation</span></a></div>
<div class="sd-card sd-sphinx-override sd-mb-3 sd-shadow-sm sd-card-hover docutils">
<div class="sd-card-body docutils">
<p class="sd-card-text">Automated annotation methods, such as CellTypist and scArches, offer faster and more scalable alternatives, but their accuracy depends on the quality of the reference data and the similarity between the reference and the query dataset.</p>
</div>
<a class="sd-stretched-link sd-hide-link-text reference internal" href="#cellular-structure-annotation-key-takeaway-3"><span class="std std-ref">Automated annotation</span></a></div>
</div>
</details><details class="sd-sphinx-override sd-dropdown sd-card sd-mb-3">
<summary class="sd-summary-title sd-card-header">
<span class="sd-summary-text"><i class="fa-solid fa-gear"></i>   Environment setup</span><span class="sd-summary-state-marker sd-summary-chevron-right"><svg version="1.1" width="1.5em" height="1.5em" class="sd-octicon sd-octicon-chevron-right" viewBox="0 0 24 24" aria-hidden="true"><path d="M8.72 18.78a.75.75 0 0 1 0-1.06L14.44 12 8.72 6.28a.751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018l6.25 6.25a.75.75 0 0 1 0 1.06l-6.25 6.25a.75.75 0 0 1-1.06 0Z"></path></svg></span></summary><div class="sd-summary-content sd-card-body docutils">
<div class="sd-tab-set docutils">
<input checked="checked" id="sd-tab-item-0" name="sd-tab-set-0" type="radio">
<label class="sd-tab-label" for="sd-tab-item-0">
Steps</label><div class="sd-tab-content docutils">
<ol class="arabic">
<li><p class="sd-card-text"><strong>Install conda</strong>:</p>
<ul class="simple">
<li><p class="sd-card-text">Before creating the environment, ensure that <a class="reference external" href="https://docs.conda.io/projects/conda/en/latest/user-guide/install/index.html">conda</a> is installed on your system.</p></li>
</ul>
</li>
<li><p class="sd-card-text"><strong>Save the yml content</strong>:</p>
<ul class="simple">
<li><p class="sd-card-text">Copy the content from the yml tab into a file named <code class="docutils literal notranslate"><span class="pre">environment.yml</span></code>.</p></li>
</ul>
</li>
<li><p class="sd-card-text"><strong>Create the environment</strong>:</p>
<ul>
<li><p class="sd-card-text">Open a terminal or command prompt.</p></li>
<li><p class="sd-card-text">Run the following command:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>conda<span class="w"> </span>env<span class="w"> </span>create<span class="w"> </span>-f<span class="w"> </span>environment.yml
</pre></div>
</div>
</li>
</ul>
</li>
<li><p class="sd-card-text"><strong>Activate the environment</strong>:</p>
<ul>
<li><p class="sd-card-text">After the environment is created, activate it using:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>conda<span class="w"> </span>activate<span class="w"> </span>&lt;environment_name&gt;
</pre></div>
</div>
</li>
<li><p class="sd-card-text">Replace <code class="docutils literal notranslate"><span class="pre">&lt;environment_name&gt;</span></code> with the name specified in the <code class="docutils literal notranslate"><span class="pre">environment.yml</span></code> file. In the yml file it will look like this:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">&lt;environment_name&gt;</span>
</pre></div>
</div>
</li>
</ul>
</li>
<li><p class="sd-card-text"><strong>Verify the installation</strong>:</p>
<ul>
<li><p class="sd-card-text">Check that the environment was created successfully by running:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>conda<span class="w"> </span>env<span class="w"> </span>list
</pre></div>
</div>
</li>
</ul>
</li>
</ol>
</div>
<input id="sd-tab-item-1" name="sd-tab-set-0" type="radio">
<label class="sd-tab-label" for="sd-tab-item-1">
yml</label><div class="sd-tab-content docutils">
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">annotation</span>

<span class="nt">channels</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">conda-forge</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bioconda</span>
<span class="nt">dependencies</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">conda-forge::python=3.12.9</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">conda-forge::ipykernel=6.29.5</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">conda-forge::scanpy=1.11.1</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">conda-forge::leidenalg=0.10.2</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">conda-forge::umap-learn=0.5.7</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">conda-forge::pynndescent=0.5.13</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">conda-forge::scvi-tools=1.3.1</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">conda-forge::anndata=0.11.4</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">pip</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">pip</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">scarches==0.6.1</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">celltypist==1.6.3</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">lamindb</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">pandas==2.2.3</span>
</pre></div>
</div>
</div>
</div>
</div>
</details><details class="sd-sphinx-override sd-dropdown sd-card sd-mb-3">
<summary class="sd-summary-title sd-card-header">
<span class="sd-summary-text"><i class="fa-solid fa-database"></i>   Get data and notebooks</span><span class="sd-summary-state-marker sd-summary-chevron-right"><svg version="1.1" width="1.5em" height="1.5em" class="sd-octicon sd-octicon-chevron-right" viewBox="0 0 24 24" aria-hidden="true"><path d="M8.72 18.78a.75.75 0 0 1 0-1.06L14.44 12 8.72 6.28a.751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018l6.25 6.25a.75.75 0 0 1 0 1.06l-6.25 6.25a.75.75 0 0 1-1.06 0Z"></path></svg></span></summary><div class="sd-summary-content sd-card-body docutils">
<p class="sd-card-text">This book uses <a class="reference external" href="https://github.com/laminlabs/lamindb">lamindb</a> to store, share, and load datasets and notebooks using the <a class="reference external" href="https://lamin.ai/theislab/sc-best-practices">theislab/sc-best-practices instance</a>.
We acknowledge free hosting from <a class="reference external" href="https://lamin.ai/">Lamin Labs</a>.</p>
<ol class="arabic">
<li><p class="sd-card-text"><strong>Install lamindb</strong></p>
<ul class="simple">
<li><p class="sd-card-text">Install the lamindb Python package:</p></li>
</ul>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>pip<span class="w"> </span>install<span class="w"> </span>lamindb
</pre></div>
</div>
</li>
<li><p class="sd-card-text"><strong>Optionally create a lamin account</strong></p>
<ul class="simple">
<li><p class="sd-card-text">Sign up and log in following <a class="reference external" href="https://docs.lamin.ai/setup#sign-up-log-in">the instructions</a></p></li>
</ul>
</li>
<li><p class="sd-card-text"><strong>Verify your setup</strong></p>
<ul class="simple">
<li><p class="sd-card-text">Run the <code class="docutils literal notranslate"><span class="pre">lamin</span> <span class="pre">connect</span></code> command:</p></li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">lamindb</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">ln</span>

<span class="n">ln</span><span class="o">.</span><span class="n">Artifact</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s2">&quot;theislab/sc-best-practices&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">df</span><span class="p">()</span>
</pre></div>
</div>
<p class="sd-card-text">You should now see up to 100 of the stored datasets.</p>
</li>
<li><p class="sd-card-text"><strong>Accessing datasets (Artifacts)</strong></p>
<ul class="simple">
<li><p class="sd-card-text">Search for the datasets on the <a class="reference external" href="https://lamin.ai/theislab/sc-best-practices/artifacts">Artifacts page</a></p></li>
<li><p class="sd-card-text">Load an Artifact and the corresponding object:</p></li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">lamindb</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">ln</span>
<span class="n">af</span> <span class="o">=</span> <span class="n">ln</span><span class="o">.</span><span class="n">Artifact</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s2">&quot;theislab/sc-best-practices&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="s2">&quot;key_of_dataset&quot;</span><span class="p">,</span> <span class="n">is_latest</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">obj</span> <span class="o">=</span> <span class="n">af</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>
</pre></div>
</div>
<p class="sd-card-text">The object is now accessible in memory and is ready for analysis.
Adapt the <code class="docutils literal notranslate"><span class="pre">ln.Artifact.connect(&quot;theislab/sc-best-practices&quot;).get(&quot;SOMEIDXXXX&quot;)</span></code> suffix to get respective versions.</p>
</li>
<li><p class="sd-card-text"><strong>Accessing notebooks (Transforms)</strong></p>
<ul class="simple">
<li><p class="sd-card-text">Search for the notebook on the <a class="reference external" href="https://lamin.ai/theislab/sc-best-practices/transforms">Transforms page</a></p></li>
<li><p class="sd-card-text">Load the notebook:</p></li>
</ul>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>lamin<span class="w"> </span>load<span class="w"> </span>&lt;notebook<span class="w"> </span>url&gt;
</pre></div>
</div>
<p class="sd-card-text">which will download the notebook to the current working directory.
Analogously to <code class="docutils literal notranslate"><span class="pre">Artifacts</span></code>, you can adapt the suffix ID to get older versions.</p>
</li>
</ol>
</div>
</details><!-- END DROPDOWNS -->
<section id="motivation">
<span id="cellular-structure-annotation-key-takeaway-1"></span><h2><span class="section-number">11.1. </span>Motivation<a class="headerlink" href="#motivation" title="Link to this heading">#</a></h2>
<p>To understand your data better and make use of existing knowledge, it is important to figure out the “cellular identity” of each of the cells in your data.
The process of labeling groups of cells in your data based on known (or sometimes unknown) cellular phenotypes is called “cell annotation”.
Whereas there are many ways to annotate your cells (e.g. based on batch, disease, sex and more), in this notebook we will focus on the annotation of “cell types”.</p>
<p>So what is a cell type?
Biologists use the term cell type to denote a cellular phenotype that is robust across datasets, identifiable based on expression of specific markers (i.e. proteins or gene transcripts), and often linked to specific functions.
For example, a plasma B cell is a type of white blood cell that secretes antibodies used to fight pathogens and it can be identified using specific markers.
Knowing which cell types are in your sample is essential in understanding your data.
For example, knowing that there are specific immune cell types in a tumor or unusual hematopoietic stem cells in your bone marrow sample can be a valuable insight into the disease you might be studying.</p>
<p>However, like with any categorization the size of categories and the borders drawn between them are partly subjective and can change over time, e.g. because new technologies allow for a higher resolution view of cells, or because specific “sub-phenotypes” that were not considered biologically meaningful are found to have important biological implications (see e.g. <span id="id1">[<a class="reference internal" href="#id183" title="Preetish Kadur Lakshminarasimha Murthy, Vishwaraj Sontake, Aleksandra Tata, Yoshihiko Kobayashi, Lauren Macadlo, Kenichi Okuda, Ansley S. Conchola, Satoko Nakano, Simon Gregory, Lisa A. Miller, Jason R. Spence, John F. Engelhardt, Richard C. Boucher, Jason R. Rock, Scott H. Randell, and Purushothama Rao Tata. Human distal lung maps and lineage hierarchies reveal a bipotent progenitor. Nature, 604(7904):111-119, Apr 2022. URL: https://doi.org/10.1038/s41586-022-04541-3, doi:10.1038/s41586-022-04541-3.">Kadur Lakshminarasimha Murthy <em>et al.</em>, 2022</a>]</span>).
Cell types are therefore often further classified into “subtypes” or “cell states” (e.g. activated versus resting) and some researchers use the term “cell identity” to avoid this sometimes arbitrary distinction of cell types, cell subtypes and cell states.
For a more detailed discussion of this topic, we recommend the review by Wagner et al. <span id="id2">[<a class="reference internal" href="#id184" title="Allon Wagner, Aviv Regev, and Nir Yosef. Revealing the vectors of cellular identity with single-cell genomics. Nature Biotechnology, 34(11):1145-1160, Nov 2016. URL: https://doi.org/10.1038/nbt.3711, doi:10.1038/nbt.3711.">Wagner <em>et al.</em>, 2016</a>]</span> and the recently published review by Zeng <span id="id3">[<a class="reference internal" href="#id193" title="Hongkui Zeng. What is a cell type and how to define it? Cell, 185(15):2739-2755, 2022. URL: https://www.sciencedirect.com/science/article/pii/S0092867422007838, doi:https://doi.org/10.1016/j.cell.2022.06.031.">Zeng, 2022</a>]</span>.</p>
<p>Similarly, multiple cell types can be part of a single continuum, where one cell type might transition or differentiate into another.
For example, in hematopoiesis cells differentiate from a stem cell into a specific immune cell type.
Although hard borders between early and late stages of this differentiation are often drawn, the state of these cells can more accurately be described by the differentiation coordinate between the less and more differentiated cellular phenotypes.
We will discuss differentiation and cellular trajectories in subsequent chapters.</p>
<p>So how do we go about annotating cells in single-cell data?
There are multiple ways to do it and we will give an overview of different approaches below.
As we are working with transcriptomic data, each of these methods is ultimately based on the expression of specific genes or gene sets, or general transcriptomic similarity between cells.</p>
</section>
<section id="environment-setup">
<h2><span class="section-number">11.2. </span>Environment setup<a class="headerlink" href="#environment-setup" title="Link to this heading">#</a></h2>
<p>We’ll filter out some deprecation and performance warnings that do not affect our code:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">warnings</span>

<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="ne">DeprecationWarning</span><span class="p">)</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">numba.core.errors</span><span class="w"> </span><span class="kn">import</span> <span class="n">NumbaDeprecationWarning</span>

<span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="n">NumbaDeprecationWarning</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Load the needed modules:</p>
<div class="cell tag_hide_output docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">shutil</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">celltypist</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">lamindb</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">ln</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas.core.indexes.base</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pandas_indexes_base</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">scanpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sc</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">scarches</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sca</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">seaborn</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sns</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">celltypist</span><span class="w"> </span><span class="kn">import</span> <span class="n">models</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.sparse</span><span class="w"> </span><span class="kn">import</span> <span class="n">csr_matrix</span>

<span class="k">assert</span> <span class="n">ln</span><span class="o">.</span><span class="n">setup</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">instance</span><span class="o">.</span><span class="n">slug</span> <span class="o">==</span> <span class="s2">&quot;theislab/sc-best-practices&quot;</span>

<span class="n">ln</span><span class="o">.</span><span class="n">track</span><span class="p">(</span><span class="s2">&quot;BnpvfJLWjHuE&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>→ loaded Transform(&#39;BnpvfJLWjHuE0000&#39;, key=&#39;annotation.ipynb&#39;), re-started Run(&#39;93AaIjvLkC7oqvcUhr04&#39;) at 2026-02-16 18:49:04 UTC
→ notebook imports: celltypist==1.6.3 lamindb==2.0.1 matplotlib==3.10.8 numba==0.63.1 numpy==2.3.5 pandas==2.2.3 scArches==0.6.1 scanpy==1.11.1 scipy==1.16.3 seaborn==0.13.2
</pre></div>
</div>
</div>
</div>
<p>One more pandas warning to filter:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">PerformanceWarning</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>We will continue working with the scRNA-seq dataset that we earlier preprocessed and will now annotate it.</p>
<p>Set figure parameters:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sc</span><span class="o">.</span><span class="n">set_figure_params</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="load-data">
<h2><span class="section-number">11.3. </span>Load data<a class="headerlink" href="#load-data" title="Link to this heading">#</a></h2>
<p>Let’s read in the toy dataset we will use for this tutorial. It includes a single sample (“site4-donor8”) of the data also used in other parts of the book. Moreover, cells that didn’t pass QC have already been removed.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">af</span> <span class="o">=</span> <span class="n">ln</span><span class="o">.</span><span class="n">Artifact</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="s2">&quot;cellular_structure/s4d8_clustered.h5ad&quot;</span><span class="p">,</span> <span class="n">is_latest</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">adata</span> <span class="o">=</span> <span class="n">af</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">is_run_input</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="manual-annotation">
<span id="cellular-structure-annotation-key-takeaway-2"></span><h2><span class="section-number">11.4. </span>Manual annotation<a class="headerlink" href="#manual-annotation" title="Link to this heading">#</a></h2>
<p>The classical or oldest way to perform cell type annotation is based on a single or small set of <a class="reference internal" href="../glossary.html#term-Marker-gene"><span class="xref std std-term">marker genes</span></a> known to be associated with a particular cell type.
This approach dates back to “pre-scRNA-seq times”, when single-cell data was low-dimensional (e.g., FACS data with gene panels consisting of no more than 30-40 genes).
It is a fast and transparent way to annotate your data.
However, when no unique markers exist for a specific cell type (which is often the case), this approach can get more complicated and even less objective, with combinations of markers or expression thresholds necessary for proper annotation.
A robust set of marker genes and prior knowledge or annotation experience can help here, but the approach comes with the risk of unclear and subjective decision-making.</p>
<p>In this setting, the data is often clustered before annotation, so that we can annotate groups of cells instead of making a per-cell call.
This is not only less laborious but also more robust to noise: a single cell might not have a count for a specific marker even if it was expressed in that cell, simply due to the inherent sparsity of single-cell data.
Clustering enables the detection of cells highly similar in overall gene expression and can therefore account for drop-outs at the single-cell level.</p>
<p>Finally, there are two angles from which to approach the marker-gene-based annotation.
One option is to work from a table of marker genes for all the cell types you expect in your data and check in which clusters those genes are expressed.
The other option is to check which genes are highly expressed in the clusters you defined and then check if they are associated with known cell types or states.
If necessary, one can move back and forth between those approaches.
We will show examples of both below.</p>
<section id="from-markers-to-cluster-annotation">
<h3><span class="section-number">11.4.1. </span>From markers to cluster annotation<a class="headerlink" href="#from-markers-to-cluster-annotation" title="Link to this heading">#</a></h3>
<p>Let’s get started with the known-marker-based approach.
We will first list a set of markers for cell types in the bone marrow here that is based on literature: previous papers that study specific cell types and subtypes and report marker genes for those cell types.
Note that markers at the protein level (e.g., used for FACS) sometimes do not work as well in transcriptomic data; hence, using markers from RNA-based papers is often more likely to work.
Moreover, sometimes markers in one dataset do not turn out to work as well in other datasets.
Ideally, a marker set is therefore validated across multiple datasets.
Finally, it is often useful to work together with experts: as a bioinformatician, try to team up with a biologist who has more extensive knowledge of the tissue, the biology, the expected cell types and markers, etc.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># keys: cell types or populations, values: lists of marker genes</span>
<span class="n">marker_genes</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;CD14+ Mono&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;FCN1&quot;</span><span class="p">,</span> <span class="s2">&quot;CD14&quot;</span><span class="p">],</span>
    <span class="s2">&quot;CD16+ Mono&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;TCF7L2&quot;</span><span class="p">,</span> <span class="s2">&quot;FCGR3A&quot;</span><span class="p">,</span> <span class="s2">&quot;LYN&quot;</span><span class="p">],</span>
    <span class="s2">&quot;ID2-hi myeloid prog&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="s2">&quot;CD14&quot;</span><span class="p">,</span>
        <span class="s2">&quot;ID2&quot;</span><span class="p">,</span>
        <span class="s2">&quot;VCAN&quot;</span><span class="p">,</span>
        <span class="s2">&quot;S100A9&quot;</span><span class="p">,</span>
        <span class="s2">&quot;CLEC12A&quot;</span><span class="p">,</span>
        <span class="s2">&quot;KLF4&quot;</span><span class="p">,</span>
        <span class="s2">&quot;PLAUR&quot;</span><span class="p">,</span>
    <span class="p">],</span>
    <span class="s2">&quot;cDC1&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;CLEC9A&quot;</span><span class="p">,</span> <span class="s2">&quot;CADM1&quot;</span><span class="p">],</span>
    <span class="s2">&quot;cDC2&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="s2">&quot;CST3&quot;</span><span class="p">,</span>
        <span class="s2">&quot;COTL1&quot;</span><span class="p">,</span>
        <span class="s2">&quot;LYZ&quot;</span><span class="p">,</span>
        <span class="s2">&quot;DMXL2&quot;</span><span class="p">,</span>
        <span class="s2">&quot;CLEC10A&quot;</span><span class="p">,</span>
        <span class="s2">&quot;FCER1A&quot;</span><span class="p">,</span>
    <span class="p">],</span>  <span class="c1"># Note: DMXL2 should be negative</span>
    <span class="s2">&quot;Normoblast&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;SLC4A1&quot;</span><span class="p">,</span> <span class="s2">&quot;SLC25A37&quot;</span><span class="p">,</span> <span class="s2">&quot;HBB&quot;</span><span class="p">,</span> <span class="s2">&quot;HBA2&quot;</span><span class="p">,</span> <span class="s2">&quot;HBA1&quot;</span><span class="p">,</span> <span class="s2">&quot;TFRC&quot;</span><span class="p">],</span>
    <span class="s2">&quot;Erythroblast&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;MKI67&quot;</span><span class="p">,</span> <span class="s2">&quot;HBA1&quot;</span><span class="p">,</span> <span class="s2">&quot;HBB&quot;</span><span class="p">],</span>
    <span class="s2">&quot;Proerythroblast&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="s2">&quot;CDK6&quot;</span><span class="p">,</span>
        <span class="s2">&quot;SYNGR1&quot;</span><span class="p">,</span>
        <span class="s2">&quot;HBM&quot;</span><span class="p">,</span>
        <span class="s2">&quot;GYPA&quot;</span><span class="p">,</span>
    <span class="p">],</span>  <span class="c1"># Note HBM and GYPA are negative markers</span>
    <span class="s2">&quot;NK&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;GNLY&quot;</span><span class="p">,</span> <span class="s2">&quot;NKG7&quot;</span><span class="p">,</span> <span class="s2">&quot;CD247&quot;</span><span class="p">,</span> <span class="s2">&quot;GRIK4&quot;</span><span class="p">,</span> <span class="s2">&quot;FCER1G&quot;</span><span class="p">,</span> <span class="s2">&quot;TYROBP&quot;</span><span class="p">,</span> <span class="s2">&quot;KLRG1&quot;</span><span class="p">,</span> <span class="s2">&quot;FCGR3A&quot;</span><span class="p">],</span>
    <span class="s2">&quot;ILC&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;ID2&quot;</span><span class="p">,</span> <span class="s2">&quot;PLCG2&quot;</span><span class="p">,</span> <span class="s2">&quot;GNLY&quot;</span><span class="p">,</span> <span class="s2">&quot;SYNE1&quot;</span><span class="p">],</span>
    <span class="s2">&quot;Lymph prog&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="s2">&quot;VPREB1&quot;</span><span class="p">,</span>
        <span class="s2">&quot;MME&quot;</span><span class="p">,</span>
        <span class="s2">&quot;EBF1&quot;</span><span class="p">,</span>
        <span class="s2">&quot;SSBP2&quot;</span><span class="p">,</span>
        <span class="s2">&quot;BACH2&quot;</span><span class="p">,</span>
        <span class="s2">&quot;CD79B&quot;</span><span class="p">,</span>
        <span class="s2">&quot;IGHM&quot;</span><span class="p">,</span>
        <span class="s2">&quot;PAX5&quot;</span><span class="p">,</span>
        <span class="s2">&quot;PRKCE&quot;</span><span class="p">,</span>
        <span class="s2">&quot;DNTT&quot;</span><span class="p">,</span>
        <span class="s2">&quot;IGLL1&quot;</span><span class="p">,</span>
    <span class="p">],</span>
    <span class="s2">&quot;Naive CD20+ B&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;MS4A1&quot;</span><span class="p">,</span> <span class="s2">&quot;IL4R&quot;</span><span class="p">,</span> <span class="s2">&quot;IGHD&quot;</span><span class="p">,</span> <span class="s2">&quot;FCRL1&quot;</span><span class="p">,</span> <span class="s2">&quot;IGHM&quot;</span><span class="p">],</span>
    <span class="s2">&quot;B1 B&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="s2">&quot;MS4A1&quot;</span><span class="p">,</span>
        <span class="s2">&quot;SSPN&quot;</span><span class="p">,</span>
        <span class="s2">&quot;ITGB1&quot;</span><span class="p">,</span>
        <span class="s2">&quot;EPHA4&quot;</span><span class="p">,</span>
        <span class="s2">&quot;COL4A4&quot;</span><span class="p">,</span>
        <span class="s2">&quot;PRDM1&quot;</span><span class="p">,</span>
        <span class="s2">&quot;IRF4&quot;</span><span class="p">,</span>
        <span class="s2">&quot;CD38&quot;</span><span class="p">,</span>
        <span class="s2">&quot;XBP1&quot;</span><span class="p">,</span>
        <span class="s2">&quot;PAX5&quot;</span><span class="p">,</span>
        <span class="s2">&quot;BCL11A&quot;</span><span class="p">,</span>
        <span class="s2">&quot;BLK&quot;</span><span class="p">,</span>
        <span class="s2">&quot;IGHD&quot;</span><span class="p">,</span>
        <span class="s2">&quot;IGHM&quot;</span><span class="p">,</span>
        <span class="s2">&quot;ZNF215&quot;</span><span class="p">,</span>
    <span class="p">],</span>  <span class="c1"># Note IGHD and IGHM are negative markers</span>
    <span class="s2">&quot;Transitional B&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;MME&quot;</span><span class="p">,</span> <span class="s2">&quot;CD38&quot;</span><span class="p">,</span> <span class="s2">&quot;CD24&quot;</span><span class="p">,</span> <span class="s2">&quot;ACSM3&quot;</span><span class="p">,</span> <span class="s2">&quot;MSI2&quot;</span><span class="p">],</span>
    <span class="s2">&quot;Plasma cells&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;MZB1&quot;</span><span class="p">,</span> <span class="s2">&quot;HSP90B1&quot;</span><span class="p">,</span> <span class="s2">&quot;FNDC3B&quot;</span><span class="p">,</span> <span class="s2">&quot;PRDM1&quot;</span><span class="p">,</span> <span class="s2">&quot;IGKC&quot;</span><span class="p">,</span> <span class="s2">&quot;JCHAIN&quot;</span><span class="p">],</span>
    <span class="s2">&quot;Plasmablast&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;XBP1&quot;</span><span class="p">,</span> <span class="s2">&quot;RF4&quot;</span><span class="p">,</span> <span class="s2">&quot;PRDM1&quot;</span><span class="p">,</span> <span class="s2">&quot;PAX5&quot;</span><span class="p">],</span>  <span class="c1"># Note PAX5 is a negative marker</span>
    <span class="s2">&quot;CD4+ T activated&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;CD4&quot;</span><span class="p">,</span> <span class="s2">&quot;IL7R&quot;</span><span class="p">,</span> <span class="s2">&quot;TRBC2&quot;</span><span class="p">,</span> <span class="s2">&quot;ITGB1&quot;</span><span class="p">],</span>
    <span class="s2">&quot;CD4+ T naive&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;CD4&quot;</span><span class="p">,</span> <span class="s2">&quot;IL7R&quot;</span><span class="p">,</span> <span class="s2">&quot;TRBC2&quot;</span><span class="p">,</span> <span class="s2">&quot;CCR7&quot;</span><span class="p">],</span>
    <span class="s2">&quot;CD8+ T&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;CD8A&quot;</span><span class="p">,</span> <span class="s2">&quot;CD8B&quot;</span><span class="p">,</span> <span class="s2">&quot;GZMK&quot;</span><span class="p">,</span> <span class="s2">&quot;GZMA&quot;</span><span class="p">,</span> <span class="s2">&quot;CCL5&quot;</span><span class="p">,</span> <span class="s2">&quot;GZMB&quot;</span><span class="p">,</span> <span class="s2">&quot;GZMH&quot;</span><span class="p">,</span> <span class="s2">&quot;GZMA&quot;</span><span class="p">],</span>
    <span class="s2">&quot;T activation&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;CD69&quot;</span><span class="p">,</span> <span class="s2">&quot;CD38&quot;</span><span class="p">],</span>  <span class="c1"># CD69 much better marker!</span>
    <span class="s2">&quot;T naive&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;LEF1&quot;</span><span class="p">,</span> <span class="s2">&quot;CCR7&quot;</span><span class="p">,</span> <span class="s2">&quot;TCF7&quot;</span><span class="p">],</span>
    <span class="s2">&quot;pDC&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;GZMB&quot;</span><span class="p">,</span> <span class="s2">&quot;IL3RA&quot;</span><span class="p">,</span> <span class="s2">&quot;COBLL1&quot;</span><span class="p">,</span> <span class="s2">&quot;TCF4&quot;</span><span class="p">],</span>
    <span class="s2">&quot;G/M prog&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;MPO&quot;</span><span class="p">,</span> <span class="s2">&quot;BCL2&quot;</span><span class="p">,</span> <span class="s2">&quot;KCNQ5&quot;</span><span class="p">,</span> <span class="s2">&quot;CSF3R&quot;</span><span class="p">],</span>
    <span class="s2">&quot;HSC&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;NRIP1&quot;</span><span class="p">,</span> <span class="s2">&quot;MECOM&quot;</span><span class="p">,</span> <span class="s2">&quot;PROM1&quot;</span><span class="p">,</span> <span class="s2">&quot;NKAIN2&quot;</span><span class="p">,</span> <span class="s2">&quot;CD34&quot;</span><span class="p">],</span>
    <span class="s2">&quot;MK/E prog&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="s2">&quot;ZNF385D&quot;</span><span class="p">,</span>
        <span class="s2">&quot;ITGA2B&quot;</span><span class="p">,</span>
        <span class="s2">&quot;RYR3&quot;</span><span class="p">,</span>
        <span class="s2">&quot;PLCB1&quot;</span><span class="p">,</span>
    <span class="p">],</span>  <span class="c1"># Note PLCB1 is a negative marker</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div class="dropdown admonition">
<p class="admonition-title">Negative markers</p>
<p>A negative marker is a gene that is not expressed in a specific cell type or condition, and is used to exclude or distinguish that group from others.
While positive markers are genes actively expressed to identify a cell type (e.g., CD4 for helper T cells),
Negative markers are genes that a cell type should not express—their absence helps confirm identity.</p>
</div>
<p>Subset to only the markers that were detected in our data.
We will loop through all cell types and keep only the genes that we find in our adata object as markers for that cell type.
This will prevent errors once we start plotting.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">marker_genes_in_data</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">for</span> <span class="n">ct</span><span class="p">,</span> <span class="n">markers</span> <span class="ow">in</span> <span class="n">marker_genes</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="n">markers_found</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">marker</span> <span class="ow">in</span> <span class="n">markers</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">marker</span> <span class="ow">in</span> <span class="n">adata</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
            <span class="n">markers_found</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">marker</span><span class="p">)</span>
    <span class="n">marker_genes_in_data</span><span class="p">[</span><span class="n">ct</span><span class="p">]</span> <span class="o">=</span> <span class="n">markers_found</span>
</pre></div>
</div>
</div>
</div>
<p>To see where these markers are expressed, we can work with a 2-dimensional visualization of the data, such as a UMAP.
We’ll construct that UMAP here based on the scran-normalized count data, using only the highly deviant genes.
Note that we first perform a PCA on the normalized counts to reduce the dimensionality of the data before we generate the UMAP.</p>
<p>To start we store our raw counts in <code class="docutils literal notranslate"><span class="pre">.layers['counts']</span></code>, so that we will still have access to them later if needed.
We then set our <code class="docutils literal notranslate"><span class="pre">adata.X</span></code> to the scran-normalized, log-transformed counts.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">adata</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="s2">&quot;counts&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">X</span>
<span class="n">adata</span><span class="o">.</span><span class="n">X</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="s2">&quot;scran_normalization&quot;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<p>We furthermore set our <code class="docutils literal notranslate"><span class="pre">adata.var.highly_variable</span></code> to the highly deviant genes.
Scanpy uses this var column in downstream calculations, such as the PCA below.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">adata</span><span class="o">.</span><span class="n">var</span><span class="p">[</span><span class="s2">&quot;highly_variable&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">var</span><span class="p">[</span><span class="s2">&quot;highly_deviant&quot;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<p>Now perform PCA.
We use the highly deviant genes (set as “highly variable” above) to reduce noise and strengthen signal in our data and set number of components to the default n=50.
50 is on the high side for data of a single sample, but it will ensure that we don’t ignore important variation in our data.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sc</span><span class="o">.</span><span class="n">tl</span><span class="o">.</span><span class="n">pca</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="n">n_comps</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">use_highly_variable</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Calculate the neighbor graph based on the PCs:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sc</span><span class="o">.</span><span class="n">pp</span><span class="o">.</span><span class="n">neighbors</span><span class="p">(</span><span class="n">adata</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>And use that neighbor graph to calculate a 2-dimensional UMAP embedding of the data:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sc</span><span class="o">.</span><span class="n">tl</span><span class="o">.</span><span class="n">umap</span><span class="p">(</span><span class="n">adata</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Now show expression of the markers using the calculated UMAP.
We’ll limit ourselves to B/plasma cell subtypes for this example.
Note from the marker dictionary above that there are three negative markers in our list: IGHD and IGHM for B1 B, and PAX5 for plasmablasts, meaning that this cell type is expected not to or to lowly express those markers.</p>
<p>Let’s list the B cell subtypes we want to show the markers for:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">B_plasma_cts</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;Naive CD20+ B&quot;</span><span class="p">,</span>
    <span class="s2">&quot;B1 B&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Transitional B&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Plasma cells&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Plasmablast&quot;</span><span class="p">,</span>
<span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<p>And now plot one UMAP per marker for each of the B cell subtypes. Note that we can only plot the markers that are present in our data.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">ct</span> <span class="ow">in</span> <span class="n">B_plasma_cts</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ct</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span><span class="si">}</span><span class="s2">:&quot;</span><span class="p">)</span>  <span class="c1"># print cell subtype name</span>
    <span class="n">sc</span><span class="o">.</span><span class="n">pl</span><span class="o">.</span><span class="n">umap</span><span class="p">(</span>
        <span class="n">adata</span><span class="p">,</span>
        <span class="n">color</span><span class="o">=</span><span class="n">marker_genes_in_data</span><span class="p">[</span><span class="n">ct</span><span class="p">],</span>
        <span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">vmax</span><span class="o">=</span><span class="s2">&quot;p99&quot;</span><span class="p">,</span>  <span class="c1"># set vmax to the 99th percentile of the gene count instead of the maximum, to prevent outliers from making expression in other cells invisible. Note that this can cause problems for extremely lowly expressed genes.</span>
        <span class="n">sort_order</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>  <span class="c1"># do not plot highest expression on top, to not get a biased view of the mean expression among cells</span>
        <span class="n">frameon</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;Reds&quot;</span><span class="p">,</span>  <span class="c1"># or choose another color map e.g. from here: https://matplotlib.org/stable/tutorials/colors/colormaps.html</span>
    <span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n\n\n</span><span class="s2">&quot;</span><span class="p">)</span>  <span class="c1"># print white space for legibility</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>NAIVE CD20+ B:
</pre></div>
</div>
<a class="reference internal image-reference" href="../_images/aaf73dcd5a6eec18d73be9efa79bf680f5e0132086197bcf44f266831f72a436.png"><img alt="../_images/aaf73dcd5a6eec18d73be9efa79bf680f5e0132086197bcf44f266831f72a436.png" src="../_images/aaf73dcd5a6eec18d73be9efa79bf680f5e0132086197bcf44f266831f72a436.png" style="width: 1530px; height: 698px;" />
</a>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>B1 B:
</pre></div>
</div>
<a class="reference internal image-reference" href="../_images/3ad56a15557b32ab4b7eb1b81cadbca2285c9fb134d896ac30abdc87325fb699.png"><img alt="../_images/3ad56a15557b32ab4b7eb1b81cadbca2285c9fb134d896ac30abdc87325fb699.png" src="../_images/3ad56a15557b32ab4b7eb1b81cadbca2285c9fb134d896ac30abdc87325fb699.png" style="width: 1529px; height: 1394px;" />
</a>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>TRANSITIONAL B:
</pre></div>
</div>
<a class="reference internal image-reference" href="../_images/c9c378f3077b6334d4b9c2011509cfae7088cc748c26c5dd849a0171b2181587.png"><img alt="../_images/c9c378f3077b6334d4b9c2011509cfae7088cc748c26c5dd849a0171b2181587.png" src="../_images/c9c378f3077b6334d4b9c2011509cfae7088cc748c26c5dd849a0171b2181587.png" style="width: 1521px; height: 698px;" />
</a>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>PLASMA CELLS:
</pre></div>
</div>
<a class="reference internal image-reference" href="../_images/49890339a02982f9c34fe415cb272e681663942bd35b3f4784c05bab80168717.png"><img alt="../_images/49890339a02982f9c34fe415cb272e681663942bd35b3f4784c05bab80168717.png" src="../_images/49890339a02982f9c34fe415cb272e681663942bd35b3f4784c05bab80168717.png" style="width: 1521px; height: 698px;" />
</a>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>PLASMABLAST:
</pre></div>
</div>
<a class="reference internal image-reference" href="../_images/5d58d5a0f7dd5c1004a7b71f9cf268dce9047f657bc42bda08edbdaf22125d2f.png"><img alt="../_images/5d58d5a0f7dd5c1004a7b71f9cf268dce9047f657bc42bda08edbdaf22125d2f.png" src="../_images/5d58d5a0f7dd5c1004a7b71f9cf268dce9047f657bc42bda08edbdaf22125d2f.png" style="width: 1156px; height: 350px;" />
</a>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
</div>
</div>
<p>As you can see, even markers for a single cell type are often expressed in different subsets of the data, i.e. individual markers are often not uniquely expressed in a single cell type.
Rather, it is the intersection of those subsets that will tell you where your cell type of interest is.</p>
<p>Another thing you might notice is that markers are often sparsely expressed, i.e., it is often only a subset of cells of a cell type in which a marker was detected.
This is due to the nature of scRNA-seq data: we only sequence a small subset of the total amount of RNA molecules in the cell, and due to this subsampling, we will sometimes not sample transcripts from specific genes in a cell even if they were expressed in that cell.
Therefore, we do not annotate single cells based on a minimum expression threshold of, e.g., a set of markers.
Instead, we first subdivide the data into groups of similar cells (i.e., “partition” the data) by clustering, thereby accounting for “missing transcripts” of single genes and rather grouping based on overall transcriptomic similarity.
We can then annotate those clusters based on their overall marker expression patterns.</p>
<p>Let us cluster our data now.
We will use the Leiden algorithm <span id="id4">[<a class="reference internal" href="#id194" title="V. A. Traag, L. Waltman, and N. J. van Eck. From louvain to leiden: guaranteeing well-connected communities. Scientific Reports, 9(1):5233, Mar 2019. URL: https://doi.org/10.1038/s41598-019-41695-z, doi:10.1038/s41598-019-41695-z.">Traag <em>et al.</em>, 2019</a>]</span> as discussed in the Clustering chapter to define a grouping of our data into similar subsets of cells:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sc</span><span class="o">.</span><span class="n">tl</span><span class="o">.</span><span class="n">leiden</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="n">resolution</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">key_added</span><span class="o">=</span><span class="s2">&quot;leiden_1&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sc</span><span class="o">.</span><span class="n">pl</span><span class="o">.</span><span class="n">umap</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;leiden_1&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<a class="reference internal image-reference" href="../_images/b66c3ad2bbd94e184e30bc34ebcf87f716810145014b8ab339d7d09c6ab55cca.png"><img alt="../_images/b66c3ad2bbd94e184e30bc34ebcf87f716810145014b8ab339d7d09c6ab55cca.png" src="../_images/b66c3ad2bbd94e184e30bc34ebcf87f716810145014b8ab339d7d09c6ab55cca.png" style="width: 394px; height: 357px;" />
</a>
</div>
</div>
<p>In case you want the partitioning to be finer, you can change the resolution to a higher level by changing the resolution parameter of the clustering:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sc</span><span class="o">.</span><span class="n">tl</span><span class="o">.</span><span class="n">leiden</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="n">resolution</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">key_added</span><span class="o">=</span><span class="s2">&quot;leiden_2&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sc</span><span class="o">.</span><span class="n">pl</span><span class="o">.</span><span class="n">umap</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;leiden_2&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<a class="reference internal image-reference" href="../_images/0cf215111c98b9f0d6987837722e9ef869fd4c851035e2a2c74bbc4bd3c4ddf0.png"><img alt="../_images/0cf215111c98b9f0d6987837722e9ef869fd4c851035e2a2c74bbc4bd3c4ddf0.png" src="../_images/0cf215111c98b9f0d6987837722e9ef869fd4c851035e2a2c74bbc4bd3c4ddf0.png" style="width: 443px; height: 357px;" />
</a>
</div>
</div>
<p>Or with cluster numbers in the UMAP:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sc</span><span class="o">.</span><span class="n">pl</span><span class="o">.</span><span class="n">umap</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;leiden_2&quot;</span><span class="p">,</span> <span class="n">legend_loc</span><span class="o">=</span><span class="s2">&quot;on data&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<a class="reference internal image-reference" href="../_images/6ee2fb3d193fff0d9d10741e70cc722e3a3e8739f3e934709a4ccdecb765a4d5.png"><img alt="../_images/6ee2fb3d193fff0d9d10741e70cc722e3a3e8739f3e934709a4ccdecb765a4d5.png" src="../_images/6ee2fb3d193fff0d9d10741e70cc722e3a3e8739f3e934709a4ccdecb765a4d5.png" style="width: 346px; height: 357px;" />
</a>
</div>
</div>
<p>This clustering is much finer and, in some cases, will help you annotate the data with more detail.
You can play around with the resolution parameter to find the setting that best captures the marker expression patterns you observe.
In our case, we will stick to the original resolution:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sc</span><span class="o">.</span><span class="n">pl</span><span class="o">.</span><span class="n">umap</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;leiden_1&quot;</span><span class="p">,</span> <span class="n">legend_loc</span><span class="o">=</span><span class="s2">&quot;on data&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<a class="reference internal image-reference" href="../_images/13fba61d36cb52b2370d8fede162831add3bfef35360b33dadfb1c1ff89b9886.png"><img alt="../_images/13fba61d36cb52b2370d8fede162831add3bfef35360b33dadfb1c1ff89b9886.png" src="../_images/13fba61d36cb52b2370d8fede162831add3bfef35360b33dadfb1c1ff89b9886.png" style="width: 346px; height: 357px;" />
</a>
</div>
</div>
<p>Scrolling back up, you will see that cluster 3 consistently expresses Naive CD20+ B cell markers.
We can also visualize this using a dotplot:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">B_plasma_markers</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">ct</span><span class="p">:</span> <span class="p">[</span><span class="n">m</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">ct_markers</span> <span class="k">if</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">adata</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">index</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">ct</span><span class="p">,</span> <span class="n">ct_markers</span> <span class="ow">in</span> <span class="n">marker_genes</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">ct</span> <span class="ow">in</span> <span class="n">B_plasma_cts</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sc</span><span class="o">.</span><span class="n">pl</span><span class="o">.</span><span class="n">dotplot</span><span class="p">(</span>
    <span class="n">adata</span><span class="p">,</span>
    <span class="n">groupby</span><span class="o">=</span><span class="s2">&quot;leiden_1&quot;</span><span class="p">,</span>
    <span class="n">var_names</span><span class="o">=</span><span class="n">B_plasma_markers</span><span class="p">,</span>
    <span class="n">standard_scale</span><span class="o">=</span><span class="s2">&quot;var&quot;</span><span class="p">,</span>  <span class="c1"># standard scale: normalize each gene to range from 0 to 1</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<a class="reference internal image-reference" href="../_images/5be0edfb1827b714bbe45abae6bc24152538155fe0c511c70706e4279e2fb853.png"><img alt="../_images/5be0edfb1827b714bbe45abae6bc24152538155fe0c511c70706e4279e2fb853.png" src="../_images/5be0edfb1827b714bbe45abae6bc24152538155fe0c511c70706e4279e2fb853.png" style="width: 902px; height: 476px;" />
</a>
</div>
</div>
<p>Using a combination of visual inspection of the UMAPs and the dotplot above we can now start annotating the clusters:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cl_annotation</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;3&quot;</span><span class="p">:</span> <span class="s2">&quot;Naive CD20+ B&quot;</span><span class="p">,</span>
    <span class="s2">&quot;5&quot;</span><span class="p">:</span> <span class="s2">&quot;Transitional B&quot;</span><span class="p">,</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<p>You might notice that the annotation of B1 B cells is difficult, with none of the clusters expressing all the B1 B markers and several clusters expressing some of the markers.
We often see that markers that work for one dataset do not work as well for others.
This can be due to differences in sequencing depth, but also due to other sources of variation between datasets or samples.</p>
<p>Let’s visualize our annotations so far:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;manual_celltype_annotation&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">leiden_1</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">cl_annotation</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sc</span><span class="o">.</span><span class="n">pl</span><span class="o">.</span><span class="n">umap</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;manual_celltype_annotation&quot;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>... storing &#39;manual_celltype_annotation&#39; as categorical
</pre></div>
</div>
<a class="reference internal image-reference" href="../_images/18168036c2a7d11fab83515f6fba6b1d6583723918c33e2926ddb3a55aaaa206.png"><img alt="../_images/18168036c2a7d11fab83515f6fba6b1d6583723918c33e2926ddb3a55aaaa206.png" src="../_images/18168036c2a7d11fab83515f6fba6b1d6583723918c33e2926ddb3a55aaaa206.png" style="width: 477px; height: 357px;" />
</a>
</div>
</div>
</section>
<section id="from-cluster-differentially-expressed-genes-to-cluster-annotation">
<h3><span class="section-number">11.4.2. </span>From cluster differentially expressed genes to cluster annotation<a class="headerlink" href="#from-cluster-differentially-expressed-genes-to-cluster-annotation" title="Link to this heading">#</a></h3>
<p>Conversely, we can calculate marker genes per cluster and then look up whether we can link those marker genes to any known biology, such as cell types and/or states.
For marker gene calculation of clusters, simple methods such as the Wilcoxon rank-sum test are thought to perform best <span id="id5">[<a class="reference internal" href="#id186" title="Jeffrey M. Pullin and Davis J. McCarthy. A comparison of marker gene selection methods for single-cell rna sequencing data. bioRxiv, 2022. URL: https://www.biorxiv.org/content/early/2022/05/10/2022.05.09.490241, arXiv:https://www.biorxiv.org/content/early/2022/05/10/2022.05.09.490241.full.pdf, doi:10.1101/2022.05.09.490241.">Pullin and McCarthy, 2022</a>]</span>.
Importantly, as the definition of the clusters is based on the same data as used for these statistical tests, the p-values of these tests will be inflated as also described here <span id="id6">[<a class="reference internal" href="#id191" title="Jesse M. Zhang, Govinda M. Kamath, and David N. Tse. Valid post-clustering differential analysis for single-cell rna-seq. Cell Systems, 9(4):383-392.e6, 2019. URL: https://www.sciencedirect.com/science/article/pii/S2405471219302698, doi:https://doi.org/10.1016/j.cels.2019.07.012.">Zhang <em>et al.</em>, 2019</a>]</span>.</p>
<p>Let’s calculate the differentially expressed genes for every cluster, compared to the rest of the cells in our adata:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sc</span><span class="o">.</span><span class="n">tl</span><span class="o">.</span><span class="n">rank_genes_groups</span><span class="p">(</span>
    <span class="n">adata</span><span class="p">,</span> <span class="n">groupby</span><span class="o">=</span><span class="s2">&quot;leiden_1&quot;</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;wilcoxon&quot;</span><span class="p">,</span> <span class="n">key_added</span><span class="o">=</span><span class="s2">&quot;dea_leiden_1&quot;</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>We can visualize expression of the top differentially expressed genes per cluster with a standard scanpy dotplot:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sc</span><span class="o">.</span><span class="n">pl</span><span class="o">.</span><span class="n">rank_genes_groups_dotplot</span><span class="p">(</span>
    <span class="n">adata</span><span class="p">,</span> <span class="n">groupby</span><span class="o">=</span><span class="s2">&quot;leiden_1&quot;</span><span class="p">,</span> <span class="n">standard_scale</span><span class="o">=</span><span class="s2">&quot;var&quot;</span><span class="p">,</span> <span class="n">n_genes</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s2">&quot;dea_leiden_1&quot;</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>WARNING: dendrogram data not found (using key=dendrogram_leiden_1). Running `sc.tl.dendrogram` with default parameters. For fine tuning it is recommended to run `sc.tl.dendrogram` independently.
</pre></div>
</div>
<a class="reference internal image-reference" href="../_images/a5c42efd581e72434a979d080a61d74809917c1a43f356ce535336cbd0509e75.png"><img alt="../_images/a5c42efd581e72434a979d080a61d74809917c1a43f356ce535336cbd0509e75.png" src="../_images/a5c42efd581e72434a979d080a61d74809917c1a43f356ce535336cbd0509e75.png" style="width: 1691px; height: 441px;" />
</a>
</div>
</div>
<p>As you can see above, a lot of the differentially expressed genes are highly expressed in multiple clusters.
We can filter the differentially expressed genes to select for more cluster-specific differentially expressed genes:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sc</span><span class="o">.</span><span class="n">tl</span><span class="o">.</span><span class="n">filter_rank_genes_groups</span><span class="p">(</span>
    <span class="n">adata</span><span class="p">,</span>
    <span class="n">min_in_group_fraction</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span>
    <span class="n">max_out_group_fraction</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span>
    <span class="n">key</span><span class="o">=</span><span class="s2">&quot;dea_leiden_1&quot;</span><span class="p">,</span>
    <span class="n">key_added</span><span class="o">=</span><span class="s2">&quot;dea_leiden_1_filtered&quot;</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Visualize the filtered genes :</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sc</span><span class="o">.</span><span class="n">pl</span><span class="o">.</span><span class="n">rank_genes_groups_dotplot</span><span class="p">(</span>
    <span class="n">adata</span><span class="p">,</span>
    <span class="n">groupby</span><span class="o">=</span><span class="s2">&quot;leiden_1&quot;</span><span class="p">,</span>
    <span class="n">standard_scale</span><span class="o">=</span><span class="s2">&quot;var&quot;</span><span class="p">,</span>
    <span class="n">n_genes</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
    <span class="n">key</span><span class="o">=</span><span class="s2">&quot;dea_leiden_1_filtered&quot;</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<a class="reference internal image-reference" href="../_images/5c0676add1f9137c9fdd36567f6863f017485a711c29ad0d8801188838af71d1.png"><img alt="../_images/5c0676add1f9137c9fdd36567f6863f017485a711c29ad0d8801188838af71d1.png" src="../_images/5c0676add1f9137c9fdd36567f6863f017485a711c29ad0d8801188838af71d1.png" style="width: 1691px; height: 441px;" />
</a>
</div>
</div>
<p>Let’s take a look at cluster 8, which seems to have a set of relatively unique markers including CD247, MOM2, KLRD1, PRF1, and KLRF1.
Some googling tells us that e.g. KLRD1 is a marker for NK cells <span id="id7">[<a class="reference internal" href="#id204" title="Ignacio Isola, Fara Brasó-Maristany, David F. Moreno, Mari-Pau Mena, Aina Oliver-Calders, Laia Paré, Luis Gerardo Rodríguez-Lobato, Beatriz Martin-Antonio, María Teresa Cibeira, Joan Bladé, Laura Rosiñol, Aleix Prat, Ester Lozano, and Carlos Fernández De Larrea. Gene Expression Analysis of the Bone Marrow Microenvironment Reveals Distinct Immunotypes in Smoldering Multiple Myeloma Associated to Progression to Symptomatic Disease. Frontiers in Immunology, 12:792609, November 2021. doi:10.3389/fimmu.2021.792609.">Isola <em>et al.</em>, 2021</a>]</span>.
In the UMAP we can see that these genes are expressed throughout cluster 8:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sc</span><span class="o">.</span><span class="n">pl</span><span class="o">.</span><span class="n">umap</span><span class="p">(</span>
    <span class="n">adata</span><span class="p">,</span>
    <span class="n">color</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;CD247&quot;</span><span class="p">,</span> <span class="s2">&quot;MYOM2&quot;</span><span class="p">,</span> <span class="s2">&quot;KLRD1&quot;</span><span class="p">,</span> <span class="s2">&quot;PRF1&quot;</span><span class="p">,</span> <span class="s2">&quot;KLRF1&quot;</span><span class="p">,</span> <span class="s2">&quot;leiden_1&quot;</span><span class="p">],</span>
    <span class="n">vmax</span><span class="o">=</span><span class="s2">&quot;p99&quot;</span><span class="p">,</span>
    <span class="n">legend_loc</span><span class="o">=</span><span class="s2">&quot;on data&quot;</span><span class="p">,</span>
    <span class="n">frameon</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;Reds&quot;</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<a class="reference internal image-reference" href="../_images/70add32e3d229022890a9304d632df8c0f13baf19964f6e4e8ae19a241f3388a.png"><img alt="../_images/70add32e3d229022890a9304d632df8c0f13baf19964f6e4e8ae19a241f3388a.png" src="../_images/70add32e3d229022890a9304d632df8c0f13baf19964f6e4e8ae19a241f3388a.png" style="width: 1530px; height: 698px;" />
</a>
</div>
</div>
<p>However, marker-based annotation can be sensitive to the cluster resolution you choose, the robustness and uniqueness of the marker sets you have, and your knowledge of the cell types to be expected in your data.
Therefore, cluster annotations are not guaranteed to be definitive and should be interpreted with caution.</p>
<p>For this reason, the field is partly trying to move away from manual cluster annotation and rather moving towards automated annotation algorithms instead.
The rest of this tutorial will focus on those options.</p>
<p>Before we move on, store the final bit of annotation information in our adata:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cl_annotation</span><span class="p">[</span><span class="s2">&quot;8&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;NK cells (?)&quot;</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;manual_celltype_annotation&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">leiden_1</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">cl_annotation</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="automated-annotation">
<span id="cellular-structure-annotation-key-takeaway-3"></span><h2><span class="section-number">11.5. </span>Automated annotation<a class="headerlink" href="#automated-annotation" title="Link to this heading">#</a></h2>
<section id="general-remarks">
<h3><span class="section-number">11.5.1. </span>General remarks<a class="headerlink" href="#general-remarks" title="Link to this heading">#</a></h3>
<p>The remainder of the discussed methods will be methods for automated, rather than manual annotation of your data.
Unlike the method showcased above, each of these methods enables you to annotate your data in an automated way.
They are based on different principles, sometimes requiring pre-defined sets of markers, other times trained on pre-existing full scRNA-seq datasets.
As discussed below, the resulting annotations can be of varying quality.
It is therefore important to regard these methods as a starting point rather than an end-point of the annotation process.
See also several reviews <span id="id8">[<a class="reference internal" href="#id187" title="Giovanni Pasquini, Jesus Eduardo Rojo Arias, Patrick Schäfer, and Volker Busskamp. Automated methods for cell type annotation on scrna-seq data. Computational and Structural Biotechnology Journal, 19:961-969, 2021. URL: https://www.sciencedirect.com/science/article/pii/S2001037021000192, doi:https://doi.org/10.1016/j.csbj.2021.01.015.">Pasquini <em>et al.</em>, 2021</a>]</span>, <span id="id9">[<a class="reference internal" href="#id188" title="Tamim Abdelaal, Lieke Michielsen, Davy Cats, Dylan Hoogduin, Hailiang Mei, Marcel J. T. Reinders, and Ahmed Mahfouz. A comparison of automatic cell identification methods for single-cell rna sequencing data. Genome Biology, 20(1):194, Sep 2019. URL: https://doi.org/10.1186/s13059-019-1795-z, doi:10.1186/s13059-019-1795-z.">Abdelaal <em>et al.</em>, 2019</a>]</span> for a more elaborate discussion of automated annotation methods.</p>
<p>As said, the quality of automatically generated annotations can vary.
More specifically, the quality of the annotations depends on:</p>
<ol class="arabic simple">
<li><p>The type of classifier chosen: Previous benchmark studies have shown that different types of classifiers often perform comparably, with neural network-based methods generally not outperforming general-purpose models such as support vector machines or linear regression models<span id="id10">[<a class="reference internal" href="#id188" title="Tamim Abdelaal, Lieke Michielsen, Davy Cats, Dylan Hoogduin, Hailiang Mei, Marcel J. T. Reinders, and Ahmed Mahfouz. A comparison of automatic cell identification methods for single-cell rna sequencing data. Genome Biology, 20(1):194, Sep 2019. URL: https://doi.org/10.1186/s13059-019-1795-z, doi:10.1186/s13059-019-1795-z.">Abdelaal <em>et al.</em>, 2019</a>]</span>, <span id="id11">[<a class="reference internal" href="#id187" title="Giovanni Pasquini, Jesus Eduardo Rojo Arias, Patrick Schäfer, and Volker Busskamp. Automated methods for cell type annotation on scrna-seq data. Computational and Structural Biotechnology Journal, 19:961-969, 2021. URL: https://www.sciencedirect.com/science/article/pii/S2001037021000192, doi:https://doi.org/10.1016/j.csbj.2021.01.015.">Pasquini <em>et al.</em>, 2021</a>]</span>, <span id="id12">[<a class="reference internal" href="#id190" title="Yixuan Huang and Peng Zhang. Evaluation of machine learning approaches for cell-type identification from single-cell transcriptomics data. Briefings in Bioinformatics, February 2021. URL: https://doi.org/10.1093/bib/bbab035, doi:10.1093/bib/bbab035.">Huang and Zhang, 2021</a>]</span>.<br></p></li>
<li><p>The quality of the data that the classifier was trained on.
If the training data was not well annotated or annotated at low resolution, the classifier will do the same.
Similarly, if the training data and/or its annotation was noisy, the classifier might not perform well.<br></p></li>
<li><p>The similarity of your own data to the data that the classifier was trained on.
For example, if the classifier was trained on a drop-seq single cell dataset and your data is 10X single nucleus rather than single cell drop-seq, this might worsen the quality of the annotation.
Classifiers trained on cross-dataset atlases including a diversity of datasets might give more robust and better quality annotations than classifiers trained on a single dataset.
An example is the CellTypist (an automated annotation method that will be discussed more extensively below) classifier trained on the Human Lung Cell Atlas <span id="id13">[<a class="reference internal" href="#id192" title="Lisa Sikkema, Ciro Ram\'ırez-Suástegui, Daniel C. Strobl, Tessa E. Gillett, Luke Zappia, Elo Madissoon, Nikolay S. Markov, Laure-Emmanuelle Zaragosi, Yuge Ji, Meshal Ansari, Marie-Jeanne Arguel, Leonie Apperloo, Martin Banchero, Christophe Bécavin, Marijn Berg, Evgeny Chichelnitskiy, Mei-i Chung, Antoine Collin, Aurore C. A. Gay, Janine Gote-Schniering, Baharak Hooshiar Kashani, Kemal Inecik, Manu Jain, Theodore S. Kapellos, Tessa M. Kole, Sylvie Leroy, Christoph H. Mayr, Amanda J. Oliver, Michael von Papen, Lance Peter, Chase J. Taylor, Thomas Walzthoeni, Chuan Xu, Linh T. Bui, Carlo De Donno, Leander Dony, Alen Faiz, Minzhe Guo, Austin J. Gutierrez, Lukas Heumos, Ni Huang, Ignacio L. Ibarra, Nathan D. Jackson, Preetish Kadur Lakshminarasimha Murthy, Mohammad Lotfollahi, Tracy Tabib, Carlos Talavera-López, Kyle J. Travaglini, Anna Wilbrey-Clark, Kaylee B. Worlock, Masahiro Yoshida, Yuexin Chen, James S. Hagood, Ahmed Agami, Peter Horvath, Joakim Lundeberg, Charles-Hugo Marquette, Gloria Pryhuber, Chistos Samakovlis, Xin Sun, Lorraine B. Ware, Kun Zhang, Maarten van den Berge, Yohan Bossé, Tushar J. Desai, Oliver Eickelberg, Naftali Kaminski, Mark A. Krasnow, Robert Lafyatis, Marko Z. Nikolic, Joseph E. Powell, Jayaraj Rajagopal, Mauricio Rojas, Orit Rozenblatt-Rosen, Max A. Seibold, Dean Sheppard, Douglas P. Shepherd, Don D. Sin, Wim Timens, Alexander M. Tsankov, Jeffrey Whitsett, Yan Xu, Nicholas E. Banovich, Pascal Barbry, Thu Elizabeth Duong, Christine S. Falk, Kerstin B. Meyer, Jonathan A. Kropski, Dana Pe'er, Herbert B. Schiller, Purushothama Rao Tata, Joachim L. Schultze, Sara A. Teichmann, Alexander V. Misharin, Martijn C. Nawijn, Malte D. Luecken, and Fabian J. Theis and. An integrated cell atlas of the lung in health and disease. Nature Medicine, June 2023. URL: https://doi.org/10.1038/s41591-023-02327-2, doi:10.1038/s41591-023-02327-2.">Sikkema <em>et al.</em>, 2023</a>]</span> which includes 14 different lung datasets.
This model is likely to perform better on new lung data than a model that was trained on a single lung dataset.</p></li>
</ol>
<p>The aforementioned points highlight possible disadvantages of using classifiers, depending on the training data and model type.
Nonetheless, there are several important advantages of using pre-trained classifiers to annotate your data.
First, it is a fast and easy way to annotate your data.
The annotation does not require the downloading nor preprocessing of the training data and sometimes merely involves the upload of your data to an online webpage.
Second, these methods don’t rely on a partitioning of your data into clusters, as the manual annotation does.
Third, pre-trained classifiers enable you to directly leverage the knowledge and information from previous studies, such as a high quality annotation.
And finally, using such classifiers can help with harmonizing cell-type definitions across a field, thereby clearing the path towards a field-wide consensus on these definitions.</p>
<p>Finally, as these classifiers are often less transparent than e.g. manual marker-based annotation, a good uncertainty measure quantifying annotation uncertainty will improve the quality and usability of the method.
We will discuss this more extensively further down.</p>
</section>
<section id="marker-gene-based-classifiers">
<h3><span class="section-number">11.5.2. </span>Marker gene-based classifiers<a class="headerlink" href="#marker-gene-based-classifiers" title="Link to this heading">#</a></h3>
<p>One class of automated cell type annotation methods relies on a predefined set of marker genes.
Cells are classified into cell types based on their expression levels of these marker genes.
Examples of such methods are Garnett <span id="id14">[<a class="reference internal" href="#id200" title="Hannah A. Pliner, Jay Shendure, and Cole Trapnell. Supervised classification enables rapid annotation of cell atlases. Nature Methods, 16(10):983-986, Oct 2019. URL: https://doi.org/10.1038/s41592-019-0535-3, doi:10.1038/s41592-019-0535-3.">Pliner <em>et al.</em>, 2019</a>]</span> and CellAssign <span id="id15">[<a class="reference internal" href="#id201" title="Allen W. Zhang, Ciara O'Flanagan, Elizabeth A. Chavez, Jamie L. P. Lim, Nicholas Ceglia, Andrew McPherson, Matt Wiens, Pascale Walters, Tim Chan, Brittany Hewitson, Daniel Lai, Anja Mottok, Clementine Sarkozy, Lauren Chong, Tomohiro Aoki, Xuehai Wang, Andrew P. Weng, Jessica N. McAlpine, Samuel Aparicio, Christian Steidl, Kieran R. Campbell, and Sohrab P. Shah. Probabilistic cell-type assignment of single-cell rna-seq for tumor microenvironment profiling. Nature Methods, 16(10):1007-1015, Oct 2019. URL: https://doi.org/10.1038/s41592-019-0529-1, doi:10.1038/s41592-019-0529-1.">Zhang <em>et al.</em>, 2019</a>]</span>.
The more robust and generalizable the set of marker genes these models are based on, the better the model will perform.
However, like with other models they are likely to be affected by batch effect-related differences between the data the model was trained on and the data that needs to be labeled.
One of the advantages of these methods compared to models based on larger gene sets (see below) is that they are more transparent: we know on the basis of which genes the classification is done.<br>
We will not show an example of marker-based classifiers in this notebook, but encourage you to explore these yourself if you are interested.</p>
</section>
<section id="classifiers-based-on-a-wider-set-of-genes">
<h3><span class="section-number">11.5.3. </span>Classifiers based on a wider set of genes<a class="headerlink" href="#classifiers-based-on-a-wider-set-of-genes" title="Link to this heading">#</a></h3>
<p>It is worth noting that the methods discussed so far use only a small subset of the genes detected in the data: often a set of only 1 to ~10 marker genes per cell type is used.
An alternative approach is to use a classifier that takes as input a larger set of genes (several thousands or more), thereby making more use of the breadth of scRNA-seq data.
Such classifiers are trained on previously annotated datasets or atlases.
Examples of these are CellTypist <span id="id16">[<a class="reference internal" href="#id185" title="C. Domínguez Conde, C. Xu, L. B. Jarvis, D. B. Rainbow, S. B. Wells, T. Gomes, S. K. Howlett, O. Suchanek, K. Polanski, H. W. King, L. Mamanova, N. Huang, P. A. Szabo, L. Richardson, L. Bolt, E. S. Fasouli, K. T. Mahbubani, M. Prete, L. Tuck, N. Richoz, Z. K. Tuong, L. Campos, H. S. Mousa, E. J. Needham, S. Pritchard, T. Li, R. Elmentaite, J. Park, E. Rahmani, D. Chen, D. K. Menon, O. A. Bayraktar, L. K. James, K. B. Meyer, N. Yosef, M. R. Clatworthy, P. A. Sims, D. L. Farber, K. Saeb-Parsy, J. L. Jones, and S. A. Teichmann. Cross-tissue immune cell analysis reveals tissue-specific features in humans. Science, 376(6594):eabl5197, 2022. URL: https://www.science.org/doi/abs/10.1126/science.abl5197, arXiv:https://www.science.org/doi/pdf/10.1126/science.abl5197, doi:10.1126/science.abl5197.">Conde <em>et al.</em>, 2022</a>]</span> (see also <a class="reference external" href="https://www.celltypist.org">https://www.celltypist.org</a>, where data can be uploaded to a portal to get automated cell annotations) and Clustifyr <span id="id17">[<a class="reference internal" href="#id189" title="Rui Fu, Austin E. Gillen, Ryan M. Sheridan, Chengzhe Tian, Michelle Daya, Yue Hao, Jay R. Hesselberth, and Kent A. Riemondy. Clustifyr: an r package for automated single-cell RNA sequencing cluster classification. F1000Research, 9:223, July 2020. URL: https://doi.org/10.12688/f1000research.22969.2, doi:10.12688/f1000research.22969.2.">Fu <em>et al.</em>, 2020</a>]</span>.</p>
<p>Let’s try out CellTypist on our data.
Based on the CellTypist tutorial (<a class="reference external" href="https://www.celltypist.org/tutorials">https://www.celltypist.org/tutorials</a>) we know we need to prepare our data so that counts are normalized to 10,000 counts per cell, then log1p-transformed:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">adata_celltypist</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>  <span class="c1"># make a copy of our adata</span>
<span class="n">adata_celltypist</span><span class="o">.</span><span class="n">X</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="s2">&quot;counts&quot;</span><span class="p">]</span>  <span class="c1"># set adata.X to raw counts</span>
<span class="n">sc</span><span class="o">.</span><span class="n">pp</span><span class="o">.</span><span class="n">normalize_total</span><span class="p">(</span>
    <span class="n">adata_celltypist</span><span class="p">,</span> <span class="n">target_sum</span><span class="o">=</span><span class="mi">10</span><span class="o">**</span><span class="mi">4</span>
<span class="p">)</span>  <span class="c1"># normalize to 10,000 counts per cell</span>
<span class="n">sc</span><span class="o">.</span><span class="n">pp</span><span class="o">.</span><span class="n">log1p</span><span class="p">(</span><span class="n">adata_celltypist</span><span class="p">)</span>  <span class="c1"># log-transform</span>
<span class="c1"># make .X dense instead of sparse, for compatibility with celltypist:</span>
<span class="n">adata_celltypist</span><span class="o">.</span><span class="n">X</span> <span class="o">=</span> <span class="n">adata_celltypist</span><span class="o">.</span><span class="n">X</span><span class="o">.</span><span class="n">toarray</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>We’ll now download the celltypist models for immune cells:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">models</span><span class="o">.</span><span class="n">download_models</span><span class="p">(</span>
    <span class="n">force_update</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Immune_All_Low.pkl&quot;</span><span class="p">,</span> <span class="s2">&quot;Immune_All_High.pkl&quot;</span><span class="p">]</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>📜 Retrieving model list from server https://celltypist.cog.sanger.ac.uk/models/models.json
📚 Total models in list: 60
📂 Storing models in /Users/seohyon/.celltypist/data/models
💾 Total models to download: 2
💾 Downloading model [1/2]: Immune_All_Low.pkl
💾 Downloading model [2/2]: Immune_All_High.pkl
</pre></div>
</div>
</div>
</div>
<p>Let’s try out both the <code class="docutils literal notranslate"><span class="pre">Immune_All_Low</span></code> and <code class="docutils literal notranslate"><span class="pre">Immune_All_High</span></code> models (these annotate immune cell types finer annotation level (low) and coarser (high)):</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model_low</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="s2">&quot;Immune_All_Low.pkl&quot;</span><span class="p">)</span>
<span class="n">model_high</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="s2">&quot;Immune_All_High.pkl&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>For each of these, we can see which cell types it includes to see if bone marrow cell types are included:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model_high</span><span class="o">.</span><span class="n">cell_types</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([&#39;B cells&#39;, &#39;B-cell lineage&#39;, &#39;Cycling cells&#39;, &#39;DC&#39;, &#39;DC precursor&#39;,
       &#39;Double-negative thymocytes&#39;, &#39;Double-positive thymocytes&#39;, &#39;ETP&#39;,
       &#39;Early MK&#39;, &#39;Endothelial cells&#39;, &#39;Epithelial cells&#39;,
       &#39;Erythrocytes&#39;, &#39;Erythroid&#39;, &#39;Fibroblasts&#39;, &#39;Granulocytes&#39;,
       &#39;HSC/MPP&#39;, &#39;ILC&#39;, &#39;ILC precursor&#39;, &#39;MNP&#39;, &#39;Macrophages&#39;,
       &#39;Mast cells&#39;, &#39;Megakaryocyte precursor&#39;,
       &#39;Megakaryocytes/platelets&#39;, &#39;Mono-mac&#39;, &#39;Monocyte precursor&#39;,
       &#39;Monocytes&#39;, &#39;Myelocytes&#39;, &#39;Plasma cells&#39;, &#39;Promyelocytes&#39;,
       &#39;T cells&#39;, &#39;pDC&#39;, &#39;pDC precursor&#39;], dtype=object)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model_low</span><span class="o">.</span><span class="n">cell_types</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([&#39;Age-associated B cells&#39;, &#39;Alveolar macrophages&#39;, &#39;B cells&#39;,
       &#39;CD16+ NK cells&#39;, &#39;CD16- NK cells&#39;, &#39;CD8a/a&#39;, &#39;CD8a/b(entry)&#39;,
       &#39;CMP&#39;, &#39;CRTAM+ gamma-delta T cells&#39;, &#39;Classical monocytes&#39;,
       &#39;Cycling B cells&#39;, &#39;Cycling DCs&#39;, &#39;Cycling NK cells&#39;,
       &#39;Cycling T cells&#39;, &#39;Cycling gamma-delta T cells&#39;,
       &#39;Cycling monocytes&#39;, &#39;DC&#39;, &#39;DC precursor&#39;, &#39;DC1&#39;, &#39;DC2&#39;, &#39;DC3&#39;,
       &#39;Double-negative thymocytes&#39;, &#39;Double-positive thymocytes&#39;, &#39;ELP&#39;,
       &#39;ETP&#39;, &#39;Early MK&#39;, &#39;Early erythroid&#39;, &#39;Early lymphoid/T lymphoid&#39;,
       &#39;Endothelial cells&#39;, &#39;Epithelial cells&#39;, &#39;Erythrocytes&#39;,
       &#39;Erythrophagocytic macrophages&#39;, &#39;Fibroblasts&#39;,
       &#39;Follicular B cells&#39;, &#39;Follicular helper T cells&#39;, &#39;GMP&#39;,
       &#39;Germinal center B cells&#39;, &#39;Granulocytes&#39;, &#39;HSC/MPP&#39;,
       &#39;Hofbauer cells&#39;, &#39;ILC&#39;, &#39;ILC precursor&#39;, &#39;ILC1&#39;, &#39;ILC2&#39;, &#39;ILC3&#39;,
       &#39;Intermediate macrophages&#39;, &#39;Intestinal macrophages&#39;,
       &#39;Kidney-resident macrophages&#39;, &#39;Kupffer cells&#39;,
       &#39;Large pre-B cells&#39;, &#39;Late erythroid&#39;, &#39;MAIT cells&#39;, &#39;MEMP&#39;, &#39;MNP&#39;,
       &#39;Macrophages&#39;, &#39;Mast cells&#39;, &#39;Megakaryocyte precursor&#39;,
       &#39;Megakaryocyte-erythroid-mast cell progenitor&#39;,
       &#39;Megakaryocytes/platelets&#39;, &#39;Memory B cells&#39;,
       &#39;Memory CD4+ cytotoxic T cells&#39;, &#39;Mid erythroid&#39;, &#39;Migratory DCs&#39;,
       &#39;Mono-mac&#39;, &#39;Monocyte precursor&#39;, &#39;Monocytes&#39;, &#39;Myelocytes&#39;,
       &#39;NK cells&#39;, &#39;NKT cells&#39;, &#39;Naive B cells&#39;,
       &#39;Neutrophil-myeloid progenitor&#39;, &#39;Neutrophils&#39;,
       &#39;Non-classical monocytes&#39;, &#39;Plasma cells&#39;, &#39;Plasmablasts&#39;,
       &#39;Pre-pro-B cells&#39;, &#39;Pro-B cells&#39;,
       &#39;Proliferative germinal center B cells&#39;, &#39;Promyelocytes&#39;,
       &#39;Regulatory T cells&#39;, &#39;Small pre-B cells&#39;, &#39;T(agonist)&#39;,
       &#39;Tcm/Naive cytotoxic T cells&#39;, &#39;Tcm/Naive helper T cells&#39;,
       &#39;Tem/Effector helper T cells&#39;, &#39;Tem/Effector helper T cells PD1+&#39;,
       &#39;Tem/Temra cytotoxic T cells&#39;, &#39;Tem/Trm cytotoxic T cells&#39;,
       &#39;Transitional B cells&#39;, &#39;Transitional DC&#39;, &#39;Transitional NK&#39;,
       &#39;Treg(diff)&#39;, &#39;Trm cytotoxic T cells&#39;, &#39;Type 1 helper T cells&#39;,
       &#39;Type 17 helper T cells&#39;, &#39;gamma-delta T cells&#39;, &#39;pDC&#39;,
       &#39;pDC precursor&#39;], dtype=object)
</pre></div>
</div>
</div>
</div>
<p>Looks like the models include many different immune cell type progenitors!</p>
<p>Now let’s run the models. First the coarse one:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">predictions_high</span> <span class="o">=</span> <span class="n">celltypist</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span>
    <span class="n">adata_celltypist</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="n">model_high</span><span class="p">,</span> <span class="n">majority_voting</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>🔬 Input data has 8874 cells and 12850 genes
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>🔗 Matching reference genes in the model
🧬 4237 features used for prediction
⚖️ Scaling input data
🖋️ Predicting labels
✅ Prediction done!
👀 Detected a neighborhood graph in the input object, will run over-clustering on the basis of it
⛓️ Over-clustering input data with resolution set to 10
🗳️ Majority voting the predictions
✅ Majority voting done!
</pre></div>
</div>
</div>
</div>
<p>Transform the predictions to adata to get the full output…</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">predictions_high_adata</span> <span class="o">=</span> <span class="n">predictions_high</span><span class="o">.</span><span class="n">to_adata</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>…and copy the results to our original AnnData object:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;celltypist_cell_label_coarse&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">predictions_high_adata</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
    <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="s2">&quot;majority_voting&quot;</span>
<span class="p">]</span>
<span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;celltypist_conf_score_coarse&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">predictions_high_adata</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
    <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="s2">&quot;conf_score&quot;</span>
<span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<p>Now the same for the finer annotations:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">predictions_low</span> <span class="o">=</span> <span class="n">celltypist</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span>
    <span class="n">adata_celltypist</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="n">model_low</span><span class="p">,</span> <span class="n">majority_voting</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>🔬 Input data has 8874 cells and 12850 genes
🔗 Matching reference genes in the model
🧬 4237 features used for prediction
⚖️ Scaling input data
🖋️ Predicting labels
✅ Prediction done!
👀 Detected a neighborhood graph in the input object, will run over-clustering on the basis of it
⛓️ Over-clustering input data with resolution set to 10
🗳️ Majority voting the predictions
✅ Majority voting done!
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">predictions_low_adata</span> <span class="o">=</span> <span class="n">predictions_low</span><span class="o">.</span><span class="n">to_adata</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;celltypist_cell_label_fine&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">predictions_low_adata</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
    <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="s2">&quot;majority_voting&quot;</span>
<span class="p">]</span>
<span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;celltypist_conf_score_fine&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">predictions_low_adata</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
    <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="s2">&quot;conf_score&quot;</span>
<span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<p>Now plot:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sc</span><span class="o">.</span><span class="n">pl</span><span class="o">.</span><span class="n">umap</span><span class="p">(</span>
    <span class="n">adata</span><span class="p">,</span>
    <span class="n">color</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;celltypist_cell_label_coarse&quot;</span><span class="p">,</span> <span class="s2">&quot;celltypist_conf_score_coarse&quot;</span><span class="p">],</span>
    <span class="n">frameon</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">sort_order</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">wspace</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>... storing &#39;manual_celltype_annotation&#39; as categorical
</pre></div>
</div>
<a class="reference internal image-reference" href="../_images/f23fe8926086874d18e14d8941764bf1dd4617b17c806e6cf3a27914d705a4be.png"><img alt="../_images/f23fe8926086874d18e14d8941764bf1dd4617b17c806e6cf3a27914d705a4be.png" src="../_images/f23fe8926086874d18e14d8941764bf1dd4617b17c806e6cf3a27914d705a4be.png" style="width: 1293px; height: 342px;" />
</a>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sc</span><span class="o">.</span><span class="n">pl</span><span class="o">.</span><span class="n">umap</span><span class="p">(</span>
    <span class="n">adata</span><span class="p">,</span>
    <span class="n">color</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;celltypist_cell_label_fine&quot;</span><span class="p">,</span> <span class="s2">&quot;celltypist_conf_score_fine&quot;</span><span class="p">],</span>
    <span class="n">frameon</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">sort_order</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">wspace</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<a class="reference internal image-reference" href="../_images/b104cb254ec81717fc88cc7444d2a51749c91474632645e1fd1e2e392d5d2451.png"><img alt="../_images/b104cb254ec81717fc88cc7444d2a51749c91474632645e1fd1e2e392d5d2451.png" src="../_images/b104cb254ec81717fc88cc7444d2a51749c91474632645e1fd1e2e392d5d2451.png" style="width: 1293px; height: 342px;" />
</a>
</div>
</div>
<p>One way of getting a feeling for the quality of these annotations is by looking if the observed cell type similarities correspond to our expectations:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sc</span><span class="o">.</span><span class="n">pl</span><span class="o">.</span><span class="n">dendrogram</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="n">groupby</span><span class="o">=</span><span class="s2">&quot;celltypist_cell_label_fine&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>WARNING: dendrogram data not found (using key=dendrogram_celltypist_cell_label_fine). Running `sc.tl.dendrogram` with default parameters. For fine tuning it is recommended to run `sc.tl.dendrogram` independently.
</pre></div>
</div>
<a class="reference internal image-reference" href="../_images/4a4407edbd54906291d2765df2c738cd3dbc2216780887e928bab7194e5f757a.png"><img alt="../_images/4a4407edbd54906291d2765df2c738cd3dbc2216780887e928bab7194e5f757a.png" src="../_images/4a4407edbd54906291d2765df2c738cd3dbc2216780887e928bab7194e5f757a.png" style="width: 328px; height: 486px;" />
</a>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;Axes: &gt;
</pre></div>
</div>
</div>
</div>
<p>This dendrogram shows us that the cells are well clustered with each other (e.g., B cells largely clustering together).
It is very important to check the automated annotation manualy before simply taking them!</p>
<div class="dropdown admonition">
<p class="admonition-title">Cross-checking automated annotations with manual annotations</p>
<p>Dendrograms often reveal unexpected patterns, such as a specific B cell subtype failing to cluster with other B cells.
This discrepancy often suggests inaccurate automated labeling.</p>
<p>To diagnose these cases:</p>
<ul class="simple">
<li><p>Validate the clusters using alternative annotation sources or known marker genes.</p></li>
<li><p>Check confidence scores of the automkated annotations. Low scores in “misplaced” clusters are a strong signal that manual intervention is required.</p></li>
</ul>
<p>You can also take a look at the breakdown of a specific clustger to investigate:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>pd.crosstab(adata.obs.leiden_1, adata.obs.celltypist_cell_label_fine).loc[
    &quot;8&quot;, :
].sort_values(ascending=False)
</pre></div>
</div>
<p>Automated annotations may only partially correspond to manual labels and can even be inconsistent between their own coarse and fine classifications.</p>
<p>This underlines that automated annotation algorithms should be used with caution and should be regarded as a starting point for annotating your data, rather than as a final annotation.
Ultimately, expression of known marker genes is still the most accepted support for a cell type annotation.</p>
</div>
</section>
<section id="annotation-by-mapping-to-a-reference">
<h3><span class="section-number">11.5.4. </span>Annotation by mapping to a reference<a class="headerlink" href="#annotation-by-mapping-to-a-reference" title="Link to this heading">#</a></h3>
<p>A final way to annotate your data is based on mapping your data to an existing, annotated single-cell reference and then performing label transfer using the resulting joint embedding.
This reference can for example be a single sample that you annotated manually before, after which you would like to transfer those annotations to the rest of your dataset.
Alternatively, it can be a published and ideally well-curated existing reference. In this context we refer to the “new data”, i.e. the data to be mapped and annotated, as the “query”.</p>
<p>There are multiple existing methods that perform such “query-to-reference mapping”, including scArches <span id="id18">[<a class="reference internal" href="#id197" title="Mohammad Lotfollahi, Mohsen Naghipourfar, Malte D. Luecken, Matin Khajavi, Maren Büttner, Marco Wagenstetter, Žiga Avsec, Adam Gayoso, Nir Yosef, Marta Interlandi, Sergei Rybakov, Alexander V. Misharin, and Fabian J. Theis. Mapping single-cell data to reference atlases by transfer learning. Nature Biotechnology, 40(1):121-130, Jan 2022. URL: https://doi.org/10.1038/s41587-021-01001-7, doi:10.1038/s41587-021-01001-7.">Lotfollahi <em>et al.</em>, 2022</a>]</span>, Symphony <span id="id19">[<a class="reference internal" href="#id198" title="Joyce B. Kang, Aparna Nathan, Kathryn Weinand, Fan Zhang, Nghia Millard, Laurie Rumker, D. Branch Moody, Ilya Korsunsky, and Soumya Raychaudhuri. Efficient and precise single-cell reference atlas mapping with symphony. Nature Communications, 12(1):5890, Oct 2021. URL: https://doi.org/10.1038/s41467-021-25957-x, doi:10.1038/s41467-021-25957-x.">Kang <em>et al.</em>, 2021</a>]</span>, and Azimuth (Seurat) <span id="id20">[<a class="reference internal" href="#id199" title="Yuhan Hao, Stephanie Hao, Erica Andersen-Nissen, William M. Mauck, Shiwei Zheng, Andrew Butler, Maddie J. Lee, Aaron J. Wilk, Charlotte Darby, Michael Zager, Paul Hoffman, Marlon Stoeckius, Efthymia Papalexi, Eleni P. Mimitou, Jaison Jain, Avi Srivastava, Tim Stuart, Lamar M. Fleming, Bertrand Yeung, Angela J. Rogers, Juliana M. McElrath, Catherine A. Blish, Raphael Gottardo, Peter Smibert, and Rahul Satija. Integrated analysis of multimodal single-cell data. Cell, 184(13):3573-3587.e29, 2021. URL: https://www.sciencedirect.com/science/article/pii/S0092867421005833, doi:https://doi.org/10.1016/j.cell.2021.04.048.">Hao <em>et al.</em>, 2021</a>]</span>.
All of these methods enable you to map a new dataset to an existing reference without needing to reintegrate the data from the reference and without needing access to the full reference data.</p>
<p>As query-to-reference mapping involves embedding new data into an <strong>existing</strong> low-dimensional representation of the reference data, the dimensions and axes of that low-dimensional representation are largely pre-defined before learning from the query.
Therefore, learning and incorporating unseen variation that might be present in the query (both new biological variation, e.g. unseen cell types or states and new technical variation, i.e. unseen batch effects that need to be removed) can be a challenge for these models.
As a result, integration of the query data with the reference might not always be optimal and batch effects might not be fully removed from the joint query-reference embedding.
However, as cell type label transfer does not necessarily require perfect integration but merely close proximity of identical cell types in the embedding, even an imperfect mapping can still be extremely helpful in annotating your data.</p>
<p>scArches, which we will use as an example of reference-mapping-based label transfer, takes as its basis an existing (variational autoencoder-based) model that embeds the reference data in a low-dimensional, batch-corrected space.
It then slightly extends that model to enable the mapping of an unseen dataset into the same “latent space” (i.e. the low-dimensional embedding).
This model extension also enables the learning and removal of batch effects present in the mapped dataset.</p>
<p>We will now show how to map data to a reference using scArches and use this mapping to perform label transfer from the reference to the new data (“query”).</p>
<div class="admonition-warning admonition">
<p class="admonition-title">Warning</p>
<p>Note that scArches does not run, or runs very slowly if you do not have access to a GPU.
You might therefore need to run this part of the notebook from a computing cluster/server.</p>
</div>
<p>Let’s start by preparing our data for the mapping to a reference.
scArches, the method that enables us to adapt an existing reference model to new data requires raw, non-normalized counts.
We will therefore keep our counts layer and remove all other layers from our adata to map.
We will set our .X to those raw counts as well.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">adata_to_map</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">adata_to_map</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
    <span class="k">if</span> <span class="n">layer</span> <span class="o">!=</span> <span class="s2">&quot;counts&quot;</span><span class="p">:</span>
        <span class="k">del</span> <span class="n">adata_to_map</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="n">layer</span><span class="p">]</span>
<span class="n">adata_to_map</span><span class="o">.</span><span class="n">X</span> <span class="o">=</span> <span class="n">adata_to_map</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="s2">&quot;counts&quot;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<p>Moreover, it is important that we use the same input features (i.e. genes) as were used for training our reference model and that we put those features in the same order.
The reference model’s feature information is stored together with the model.
Let’s load the feature table.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">af</span> <span class="o">=</span> <span class="n">ln</span><span class="o">.</span><span class="n">Artifact</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s2">&quot;theislab/sc-best-practices&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
    <span class="n">key</span><span class="o">=</span><span class="s2">&quot;cellular_structure/annotation_reference_features.csv&quot;</span><span class="p">,</span> <span class="n">is_latest</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="n">reference_model_features</span> <span class="o">=</span> <span class="n">af</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>The table has both gene names and gene IDs.
As gene IDs are usually less subject to change over genome annotation versions, we will use those to subset our data.
We will therefore set our row names for both our adata and the reference model features to <code class="docutils literal notranslate"><span class="pre">gene_ids</span></code>.
Importantly, we have to make sure to also store the gene names for later use: these are much easier to understand than the gene IDs.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">adata_to_map</span><span class="o">.</span><span class="n">var</span><span class="p">[</span><span class="s2">&quot;gene_names&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">adata_to_map</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">index</span>
<span class="n">adata_to_map</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;gene_id&quot;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">reference_model_features</span><span class="p">[</span><span class="s2">&quot;gene_names&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">reference_model_features</span><span class="o">.</span><span class="n">index</span>
<span class="n">reference_model_features</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;gene_ids&quot;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Now, let’s check if we have all the genes we need in our query data:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Total number of genes needed for mapping:&quot;</span><span class="p">,</span> <span class="n">reference_model_features</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Total number of genes needed for mapping: 4000
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span>
    <span class="s2">&quot;Number of genes found in query dataset:&quot;</span><span class="p">,</span>
    <span class="n">adata_to_map</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">reference_model_features</span><span class="o">.</span><span class="n">index</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Number of genes found in query dataset: 2725
</pre></div>
</div>
</div>
</div>
<p>We are missing some genes.
We will manually add those and set their counts to 0, as it seems like these genes were not detected in our data.
Let’s create an AnnData object for those missing genes with only zero values (including our raw counts layer, which will be used for the mapping).
We will concatenate that to our own AnnData objects afterwards.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">missing_genes</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">gene_id</span>
    <span class="k">for</span> <span class="n">gene_id</span> <span class="ow">in</span> <span class="n">reference_model_features</span><span class="o">.</span><span class="n">index</span>
    <span class="k">if</span> <span class="n">gene_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">adata_to_map</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">index</span>
<span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">missing_gene_adata</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">AnnData</span><span class="p">(</span>
    <span class="n">X</span><span class="o">=</span><span class="n">csr_matrix</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">adata</span><span class="o">.</span><span class="n">n_obs</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">missing_genes</span><span class="p">))),</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float32&quot;</span><span class="p">),</span>
    <span class="n">obs</span><span class="o">=</span><span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">1</span><span class="p">],</span>
    <span class="n">var</span><span class="o">=</span><span class="n">reference_model_features</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">missing_genes</span><span class="p">,</span> <span class="p">:],</span>
<span class="p">)</span>
<span class="n">missing_gene_adata</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="s2">&quot;counts&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">missing_gene_adata</span><span class="o">.</span><span class="n">X</span>
</pre></div>
</div>
</div>
</div>
<p>Concatenate our original adata to the missing genes adata.
To make sure we can do this concatenation without errors, we’ll remove the PCA matrix from varm.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="s2">&quot;PCs&quot;</span> <span class="ow">in</span> <span class="n">adata_to_map</span><span class="o">.</span><span class="n">varm</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
    <span class="k">del</span> <span class="n">adata_to_map</span><span class="o">.</span><span class="n">varm</span><span class="p">[</span><span class="s2">&quot;PCs&quot;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">adata_to_map_augmented</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
    <span class="p">[</span><span class="n">adata_to_map</span><span class="p">,</span> <span class="n">missing_gene_adata</span><span class="p">],</span>
    <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">join</span><span class="o">=</span><span class="s2">&quot;outer&quot;</span><span class="p">,</span>
    <span class="n">index_unique</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">merge</span><span class="o">=</span><span class="s2">&quot;unique&quot;</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Now subset to the genes used in the model and order correctly:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">adata_to_map_augmented</span> <span class="o">=</span> <span class="n">adata_to_map_augmented</span><span class="p">[</span>
    <span class="p">:,</span> <span class="n">reference_model_features</span><span class="o">.</span><span class="n">index</span>
<span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>Check if our adata gene names correspond exactly to the required gene order:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">bool</span><span class="p">((</span><span class="n">adata_to_map_augmented</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">index</span> <span class="o">==</span> <span class="n">reference_model_features</span><span class="o">.</span><span class="n">index</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>True
</pre></div>
</div>
</div>
</div>
<p>We can now set the gene indices back to gene names for easy interpretation:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">adata_to_map_augmented</span><span class="o">.</span><span class="n">var</span><span class="p">[</span><span class="s2">&quot;gene_ids&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">adata_to_map_augmented</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">index</span>
<span class="n">adata_to_map_augmented</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;gene_names&quot;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Finally, this reference model used <code class="docutils literal notranslate"><span class="pre">adata.obs['batch']</span></code> as our batch variable.
We will therefore check that we have this set to one value for our entire sample:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">adata_to_map_augmented</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">batch</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&#39;s4d8&#39;]
Categories (1, object): [&#39;s4d8&#39;]
</pre></div>
</div>
</div>
</div>
<p>Now let’s talk about our reference model.
The better our reference model, the better our label transfer will perform.
Using well-annotated reference that integrates many different datasets and that matches your data well (same organ, same single-cell technology etc.) is ideal: such models are trained on a variety of datasets and batches and are therefore expected to be more robust to batch effects.
However, such references do not exist yet for all tissues.
For this tutorial we will use a reference model trained on the bone marrow samples that we have been using throughout the book, excluding the sample that we will be mapping.
The reference model is an scvi-model (used for data integration) that generates a low-dimensional, integrated embedding of the input data, see also the scvi-publication <span id="id21">[<a class="reference internal" href="#id202" title="Romain Lopez, Jeffrey Regier, Michael B Cole, Michael I Jordan, and Nir Yosef. Deep generative modeling for single-cell transcriptomics. Nat. Methods, 15(12):1053–1058, December 2018.">Lopez <em>et al.</em>, 2018</a>]</span>.
Note that this is a toy model generated for this tutorial and it should  not be used in other contexts.</p>
<p>We will start by patching things up for compatibility, because this model was built on previous version of pandas.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s2">&quot;pandas.core.indexes.numeric&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pandas_indexes_base</span>
<span class="n">pandas_indexes_base</span><span class="o">.</span><span class="n">Int64Index</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Index</span>
<span class="n">pandas_indexes_base</span><span class="o">.</span><span class="n">Float64Index</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Index</span>
</pre></div>
</div>
</div>
</div>
<p>Now, let’s load the model and pass it the adata which we want to map.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">af</span> <span class="o">=</span> <span class="n">ln</span><span class="o">.</span><span class="n">Artifact</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s2">&quot;theislab/sc-best-practices&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
    <span class="n">key</span><span class="o">=</span><span class="s2">&quot;cellular_structure/annotation_reference_model.pt&quot;</span><span class="p">,</span> <span class="n">is_latest</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="n">local_file_path</span> <span class="o">=</span> <span class="n">af</span><span class="o">.</span><span class="n">cache</span><span class="p">()</span>

<span class="n">model_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;./reference_model&quot;</span><span class="p">)</span>
<span class="n">model_dir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">local_file_path</span><span class="p">,</span> <span class="n">model_dir</span> <span class="o">/</span> <span class="s2">&quot;model.pt&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>PosixPath(&#39;reference_model/model.pt&#39;)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">scarches_model</span> <span class="o">=</span> <span class="n">sca</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">SCVI</span><span class="o">.</span><span class="n">load_query_data</span><span class="p">(</span>
    <span class="n">adata</span><span class="o">=</span><span class="n">adata_to_map_augmented</span><span class="p">,</span>
    <span class="n">reference_model</span><span class="o">=</span><span class="n">model_dir</span><span class="p">,</span>
    <span class="n">freeze_dropout</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span><span class=" -Color -Color-Blue">INFO    </span> File .<span class=" -Color -Color-Magenta">/reference_model/</span>model.pt already downloaded                                                        
</pre></div>
</div>
</div>
</div>
<p>We will now update this reference model so that we can embed our own data (the “query”) in the same latent space as the reference. This requires training on our query data using scArches:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">scarches_model</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">max_epochs</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">plan_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;weight_decay&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">})</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>INFO: GPU available: False, used: False
GPU available: False, used: False
INFO: TPU available: False, using: 0 TPU cores
TPU available: False, using: 0 TPU cores
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch 500/500: 100%|██████████| 500/500 [30:52&lt;00:00,  3.66s/it, v_num=1, train_loss_step=965, train_loss_epoch=1e+3]    
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>INFO: `Trainer.fit` stopped: `max_epochs=500` reached.
`Trainer.fit` stopped: `max_epochs=500` reached.
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch 500/500: 100%|██████████| 500/500 [30:52&lt;00:00,  3.71s/it, v_num=1, train_loss_step=965, train_loss_epoch=1e+3]
</pre></div>
</div>
</div>
</div>
<p>Now that we have updated the model, we can calculate the (ideally batch-corrected) latent representation of our query:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">adata</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="s2">&quot;X_scVI&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">scarches_model</span><span class="o">.</span><span class="n">get_latent_representation</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>We can now use this newly calculated low-dimensional embedding as a basis for visualization and clustering.
Let’s calculate the new UMAP using the scVI-based representation of the data.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sc</span><span class="o">.</span><span class="n">pp</span><span class="o">.</span><span class="n">neighbors</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="n">use_rep</span><span class="o">=</span><span class="s2">&quot;X_scVI&quot;</span><span class="p">)</span>
<span class="n">sc</span><span class="o">.</span><span class="n">tl</span><span class="o">.</span><span class="n">umap</span><span class="p">(</span><span class="n">adata</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>To see if the mapping-based UMAP makes general sense, let’s look at a few markers and if their expression is localized to specific parts of the UMAP:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sc</span><span class="o">.</span><span class="n">pl</span><span class="o">.</span><span class="n">umap</span><span class="p">(</span>
    <span class="n">adata</span><span class="p">,</span>
    <span class="n">color</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;IGHD&quot;</span><span class="p">,</span> <span class="s2">&quot;IGHM&quot;</span><span class="p">,</span> <span class="s2">&quot;PRDM1&quot;</span><span class="p">],</span>
    <span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
    <span class="n">vmax</span><span class="o">=</span><span class="s2">&quot;p99&quot;</span><span class="p">,</span>  <span class="c1"># set vmax to the 99th percentile of the gene count instead of the maximum, to prevent outliers from making expression in other cells invisible. Note that this can cause problems for extremely lowly expressed genes.</span>
    <span class="n">sort_order</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>  <span class="c1"># do not plot highest expression on top, to not get a biased view of the mean expression among cells</span>
    <span class="n">frameon</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;Reds&quot;</span><span class="p">,</span>  <span class="c1"># or choose another color map e.g. from here: https://matplotlib.org/stable/tutorials/colors/colormaps.html</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<a class="reference internal image-reference" href="../_images/62b84c03179f2353cd238286d2949c83c66d699e417321697fac6b8cde935e26.png"><img alt="../_images/62b84c03179f2353cd238286d2949c83c66d699e417321697fac6b8cde935e26.png" src="../_images/62b84c03179f2353cd238286d2949c83c66d699e417321697fac6b8cde935e26.png" style="width: 1147px; height: 350px;" />
</a>
</div>
</div>
<p>Now the essential step is that we can combine the inferred latent space embedding of our query data with the existing reference embedding.
Using this joint embedding, we will not only be able to e.g., visualize and cluster the two together, but we can also do label transfer from the query to the reference.</p>
<p>Let’s load the reference embedding: this is often made publicly available with existing atlases.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">af</span> <span class="o">=</span> <span class="n">ln</span><span class="o">.</span><span class="n">Artifact</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
    <span class="n">key</span><span class="o">=</span><span class="s2">&quot;cellular_structure/annotation_reference_embedding.h5ad&quot;</span><span class="p">,</span> <span class="n">is_latest</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="n">ref_emb</span> <span class="o">=</span> <span class="n">af</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">is_run_input</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>We’ll store a variable specifying that these cells are from the reference.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ref_emb</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;reference_or_query&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;reference&quot;</span>
</pre></div>
</div>
</div>
</div>
<p>Let’s see what’s in this reference object:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ref_emb</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>AnnData object with n_obs × n_vars = 86332 × 10
    obs: &#39;donor&#39;, &#39;batch&#39;, &#39;site&#39;, &#39;cell_type&#39;, &#39;reference_or_query&#39;
    uns: &#39;neighbors&#39;, &#39;umap&#39;
    obsm: &#39;X_umap&#39;
    obsp: &#39;connectivities&#39;, &#39;distances&#39;
</pre></div>
</div>
</div>
</div>
<p>As you can see it has only 10 dimensions (in <code class="docutils literal notranslate"><span class="pre">.X</span></code>) which together represent the latent space embedding of the reference cells.
Our query embedding that we calculated for our own data also has 10 dimensions.
The 10 dimensions of the reference and query are the same and can be combined!</p>
<p>Moreover, it has cell type labels in <code class="docutils literal notranslate"><span class="pre">.obs['cell_type']</span></code>.
We will use these labels to annotate our own data.</p>
<p>To perform the label transfer, we will first concatenate the reference and query data using the 10-dimensional embedding.
To get there, we will create the same type of AnnData object from our query data as we have from the reference (with the embedding under <code class="docutils literal notranslate"><span class="pre">.X</span></code>) and concatenate the two.
With that, we can jointly analyze reference and query including doing transfer from one to the other.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">adata_emb</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">AnnData</span><span class="p">(</span><span class="n">X</span><span class="o">=</span><span class="n">adata</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="s2">&quot;X_scVI&quot;</span><span class="p">],</span> <span class="n">obs</span><span class="o">=</span><span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">adata_emb</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;reference_or_query&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;query&quot;</span>
</pre></div>
</div>
</div>
</div>
<p>We will set the cell type labels in <code class="docutils literal notranslate"><span class="pre">.obs[&quot;cell_type&quot;]</span></code> as <code class="docutils literal notranslate"><span class="pre">None</span></code>, so that we can see how we can annotate cell types based on the surroundings.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">adata_emb</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;cell_type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">emb_ref_query</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
    <span class="p">[</span><span class="n">ref_emb</span><span class="p">,</span> <span class="n">adata_emb</span><span class="p">],</span>
    <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
    <span class="n">join</span><span class="o">=</span><span class="s2">&quot;outer&quot;</span><span class="p">,</span>
    <span class="n">index_unique</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">merge</span><span class="o">=</span><span class="s2">&quot;unique&quot;</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Let’s visualize the joint embedding with a UMAP.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sc</span><span class="o">.</span><span class="n">pp</span><span class="o">.</span><span class="n">neighbors</span><span class="p">(</span><span class="n">emb_ref_query</span><span class="p">)</span>
<span class="n">sc</span><span class="o">.</span><span class="n">tl</span><span class="o">.</span><span class="n">umap</span><span class="p">(</span><span class="n">emb_ref_query</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>We can visually get a first impression of whether the reference and query integrated well based on the UMAP:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sc</span><span class="o">.</span><span class="n">pl</span><span class="o">.</span><span class="n">umap</span><span class="p">(</span>
    <span class="n">emb_ref_query</span><span class="p">,</span>
    <span class="n">color</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;reference_or_query&quot;</span><span class="p">],</span>
    <span class="n">sort_order</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">frameon</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<a class="reference internal image-reference" href="../_images/bf77e42ea45fbe73e40c0b7e9bfd52848c62b6fc017396b5bcd53caa616089f0.png"><img alt="../_images/bf77e42ea45fbe73e40c0b7e9bfd52848c62b6fc017396b5bcd53caa616089f0.png" src="../_images/bf77e42ea45fbe73e40c0b7e9bfd52848c62b6fc017396b5bcd53caa616089f0.png" style="width: 419px; height: 338px;" />
</a>
</div>
</div>
<p>The (partial) mixing of query and reference in this UMAP is a good sign!
When mapping completely fails, you will often see a full separation of query and reference in the UMAP.</p>
<p>Now let’s look at the cell type annotations from the reference.
All cells from the query are set to NA here as they don’t have annotations yet and shown in black.</p>
<p>We’ll make this figure a bit bigger so that we can read the legend well:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sc</span><span class="o">.</span><span class="n">set_figure_params</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sc</span><span class="o">.</span><span class="n">pl</span><span class="o">.</span><span class="n">umap</span><span class="p">(</span>
    <span class="n">emb_ref_query</span><span class="p">,</span>
    <span class="n">color</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;cell_type&quot;</span><span class="p">],</span>
    <span class="n">sort_order</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">frameon</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">legend_loc</span><span class="o">=</span><span class="s2">&quot;on data&quot;</span><span class="p">,</span>
    <span class="n">legend_fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
    <span class="n">na_color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<a class="reference internal image-reference" href="../_images/84894764f04338bfddf656199228fbfad26826c310e4e1bcf676dce1c7c92754.png"><img alt="../_images/84894764f04338bfddf656199228fbfad26826c310e4e1bcf676dce1c7c92754.png" src="../_images/84894764f04338bfddf656199228fbfad26826c310e4e1bcf676dce1c7c92754.png" style="width: 515px; height: 520px;" />
</a>
</div>
</div>
<p>As you can already tell from the UMAP, we can guess the cell type of each of our own cells (in black) by looking at which cell types from the reference surrounding it.
This is exactly what a nearest-neighbor-graph-based label transfer approach does: for each query cell it checks what is the most common cell type among its neighboring reference cells.
The higher the fraction of reference cells coming from a single cell type, the more confident the label transfer is.</p>
<p>Let’s perform the KNN-based label transfer.</p>
<p>First we set up the label transfer model:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">knn_transformer</span> <span class="o">=</span> <span class="n">sca</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">knn</span><span class="o">.</span><span class="n">weighted_knn_trainer</span><span class="p">(</span>
    <span class="n">train_adata</span><span class="o">=</span><span class="n">ref_emb</span><span class="p">,</span>
    <span class="n">train_adata_emb</span><span class="o">=</span><span class="s2">&quot;X&quot;</span><span class="p">,</span>  <span class="c1"># location of our joint embedding</span>
    <span class="n">n_neighbors</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Weighted KNN with n_neighbors = 15 ... 
</pre></div>
</div>
</div>
</div>
<p>Now we perform the label transfer:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">labels</span><span class="p">,</span> <span class="n">uncert</span> <span class="o">=</span> <span class="n">sca</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">knn</span><span class="o">.</span><span class="n">weighted_knn_transfer</span><span class="p">(</span>
    <span class="n">query_adata</span><span class="o">=</span><span class="n">adata_emb</span><span class="p">,</span>
    <span class="n">query_adata_emb</span><span class="o">=</span><span class="s2">&quot;X&quot;</span><span class="p">,</span>  <span class="c1"># location of our embedding, query_adata.X in this case</span>
    <span class="n">label_keys</span><span class="o">=</span><span class="s2">&quot;cell_type&quot;</span><span class="p">,</span>  <span class="c1"># (start of) obs column name(s) for which to transfer labels</span>
    <span class="n">knn_model</span><span class="o">=</span><span class="n">knn_transformer</span><span class="p">,</span>
    <span class="n">ref_adata_obs</span><span class="o">=</span><span class="n">ref_emb</span><span class="o">.</span><span class="n">obs</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>finished!
</pre></div>
</div>
</div>
</div>
<p>And store the results in our adata:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">adata_emb</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;transf_cell_type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">labels</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">adata_emb</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="s2">&quot;cell_type&quot;</span><span class="p">]</span>
<span class="n">adata_emb</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;transf_cell_type_unc&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">uncert</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">adata_emb</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="s2">&quot;cell_type&quot;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<p>Let’s transfer the results to our query adata object which also has our UMAP and gene counts, so that we can visualize all of those together.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">adata_emb</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="s2">&quot;transf_cell_type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">adata_emb</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span>
    <span class="s2">&quot;transf_cell_type&quot;</span>
<span class="p">]</span>
<span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">adata_emb</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="s2">&quot;transf_cell_type_unc&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">adata_emb</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span>
    <span class="s2">&quot;transf_cell_type_unc&quot;</span>
<span class="p">]</span>
<span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;transf_cell_type_unc&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;transf_cell_type_unc&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span>
    <span class="nb">float</span>
<span class="p">)</span>  <span class="c1"># ensure uncertainty is float, for compatibility with downstream plotting functions</span>
</pre></div>
</div>
</div>
</div>
<p>We can now visualize the transferred labels in our previously calculated UMAP of our own data:</p>
<p>Let’s set the figure size smaller again:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sc</span><span class="o">.</span><span class="n">set_figure_params</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sc</span><span class="o">.</span><span class="n">pl</span><span class="o">.</span><span class="n">umap</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;transf_cell_type&quot;</span><span class="p">,</span> <span class="n">frameon</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<a class="reference internal image-reference" href="../_images/a9c3143da50481b2749939aa3af0cd08ee336764bd56b9342b5e957e54c9455c.png"><img alt="../_images/a9c3143da50481b2749939aa3af0cd08ee336764bd56b9342b5e957e54c9455c.png" src="../_images/a9c3143da50481b2749939aa3af0cd08ee336764bd56b9342b5e957e54c9455c.png" style="width: 610px; height: 338px;" />
</a>
</div>
</div>
<p>Based on the neighbors of each of our query cells we can not only guess the cell type these cells belong to, but also generate a measure for certainty of that label: if a cell has neighbors from several different cell types, our guess will be highly uncertain.
This is relevant to assess to what extent we can “trust” the transferred labels!
Let’s visualize the uncertainty scores:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sc</span><span class="o">.</span><span class="n">pl</span><span class="o">.</span><span class="n">umap</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;transf_cell_type_unc&quot;</span><span class="p">,</span> <span class="n">frameon</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<a class="reference internal image-reference" href="../_images/e0280cd2f02cb621ff20a21b76b1c2f9b68babd6e165b8b7cf5d09eff83a6497.png"><img alt="../_images/e0280cd2f02cb621ff20a21b76b1c2f9b68babd6e165b8b7cf5d09eff83a6497.png" src="../_images/e0280cd2f02cb621ff20a21b76b1c2f9b68babd6e165b8b7cf5d09eff83a6497.png" style="width: 342px; height: 346px;" />
</a>
</div>
</div>
<p>Let’s check for each cell type label how high the label transfer uncertainty levels were.
This gives us a first impression of which annotations are more contentious/need more manual checks.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
<span class="n">ct_order</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;transf_cell_type&quot;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">agg</span><span class="p">({</span><span class="s2">&quot;transf_cell_type_unc&quot;</span><span class="p">:</span> <span class="s2">&quot;median&quot;</span><span class="p">})</span>
    <span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s2">&quot;transf_cell_type_unc&quot;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="p">)</span>
<span class="n">sns</span><span class="o">.</span><span class="n">boxplot</span><span class="p">(</span>
    <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">,</span>
    <span class="n">x</span><span class="o">=</span><span class="s2">&quot;transf_cell_type&quot;</span><span class="p">,</span>
    <span class="n">y</span><span class="o">=</span><span class="s2">&quot;transf_cell_type_unc&quot;</span><span class="p">,</span>
    <span class="n">color</span><span class="o">=</span><span class="s2">&quot;grey&quot;</span><span class="p">,</span>
    <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span>
    <span class="n">order</span><span class="o">=</span><span class="n">ct_order</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">rotation</span><span class="o">=</span><span class="mi">90</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="s2">&quot;x&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<a class="reference internal image-reference" href="../_images/8d1266d115da956c977079ee8b9db4f6bac46c46a12ae0a5049f825984ccfe27.png"><img alt="../_images/8d1266d115da956c977079ee8b9db4f6bac46c46a12ae0a5049f825984ccfe27.png" src="../_images/8d1266d115da956c977079ee8b9db4f6bac46c46a12ae0a5049f825984ccfe27.png" style="width: 563px; height: 345px;" />
</a>
</div>
</div>
<p>You’ll notice that e.g. progenitor cells are often more difficult to distinguish than other cell types.
Same for the rather unspecific category “Other T” cells in our annotations.
We can see that pDC, a cell type that is known to be quite transcriptionally distinct and therefore easier to recognize and label, spreads from 0.0 to 0.5.</p>
<p>To incorporate this uncertainty information in our transferred labels, we can set cells with an uncertainty score above e.g. 0.2 to “unknown”:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;transf_cell_type_certain&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">transf_cell_type</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
<span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">transf_cell_type_unc</span> <span class="o">&gt;</span> <span class="mf">0.2</span><span class="p">,</span> <span class="s2">&quot;transf_cell_type_certain&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
    <span class="s2">&quot;Unknown&quot;</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Let’s see what our annotations look like after this filtering.
Note the Unknown color in the legend and the UMAP.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sc</span><span class="o">.</span><span class="n">pl</span><span class="o">.</span><span class="n">umap</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;transf_cell_type_certain&quot;</span><span class="p">,</span> <span class="n">frameon</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>... storing &#39;transf_cell_type_certain&#39; as categorical
</pre></div>
</div>
<a class="reference internal image-reference" href="../_images/211c84c83c5deefddaad3053202085e6fda7bb927898fae4814fcfe13c379a4b.png"><img alt="../_images/211c84c83c5deefddaad3053202085e6fda7bb927898fae4814fcfe13c379a4b.png" src="../_images/211c84c83c5deefddaad3053202085e6fda7bb927898fae4814fcfe13c379a4b.png" style="width: 610px; height: 338px;" />
</a>
</div>
</div>
<p>To ease legibility, we can color <em>only</em> the “unknown” cells.
This will make it easier for us to see how many of those there are.
You can do the same with any of the other cell type labels.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sc</span><span class="o">.</span><span class="n">pl</span><span class="o">.</span><span class="n">umap</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;transf_cell_type_certain&quot;</span><span class="p">,</span> <span class="n">groups</span><span class="o">=</span><span class="s2">&quot;Unknown&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<a class="reference internal image-reference" href="../_images/25b9b9c186f3ae5695c2a6418c49fce1249c62f924cfa1e0fa8aa68fd3cecac0.png"><img alt="../_images/25b9b9c186f3ae5695c2a6418c49fce1249c62f924cfa1e0fa8aa68fd3cecac0.png" src="../_images/25b9b9c186f3ae5695c2a6418c49fce1249c62f924cfa1e0fa8aa68fd3cecac0.png" style="width: 438px; height: 357px;" />
</a>
</div>
</div>
<p>There are quite many of them!
These cells will need particularly careful manual reviewing.
However, the low-uncertainty annotations surrounding the “unknown cells” will already give us a first idea of what cell type we can expect each cell to belong to.</p>
<p>Now let’s take a look at our more certain annotations.
We will check for a few cell types (chosen at random here) to what extent the reference-transferred annotation matches our known marker genes from above.
In reality, this should be done systematically for all annotations!</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cell_types_to_check</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;CD14+ Mono&quot;</span><span class="p">,</span>
    <span class="s2">&quot;cDC2&quot;</span><span class="p">,</span>
    <span class="s2">&quot;NK&quot;</span><span class="p">,</span>
    <span class="s2">&quot;B1 B&quot;</span><span class="p">,</span>
    <span class="s2">&quot;CD4+ T activated&quot;</span><span class="p">,</span>
    <span class="s2">&quot;T naive&quot;</span><span class="p">,</span>
    <span class="s2">&quot;MK/E prog&quot;</span><span class="p">,</span>
<span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<p>Conveniently, for each of these cell types we have markers in our dictionary.
Let’s plot marker expression for all our newly annotated cell types.
You will notice that marker expression generally corresponds to the automated annotations, a good sign!</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sc</span><span class="o">.</span><span class="n">pl</span><span class="o">.</span><span class="n">dotplot</span><span class="p">(</span>
    <span class="n">adata</span><span class="p">,</span>
    <span class="n">var_names</span><span class="o">=</span><span class="p">{</span>
        <span class="n">ct</span><span class="p">:</span> <span class="n">marker_genes_in_data</span><span class="p">[</span><span class="n">ct</span><span class="p">]</span> <span class="k">for</span> <span class="n">ct</span> <span class="ow">in</span> <span class="n">cell_types_to_check</span>
    <span class="p">},</span>  <span class="c1"># gene names grouped by cell type in a dictionary</span>
    <span class="n">groupby</span><span class="o">=</span><span class="s2">&quot;transf_cell_type_certain&quot;</span><span class="p">,</span>
    <span class="n">standard_scale</span><span class="o">=</span><span class="s2">&quot;var&quot;</span><span class="p">,</span>  <span class="c1"># normalize gene scores from 0 to 1</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<a class="reference internal image-reference" href="../_images/b1c9ddba3c61e9970731a95b9d3da2cb07cc0fc0ef5d5c142145f1c4f56c37c7.png"><img alt="../_images/b1c9ddba3c61e9970731a95b9d3da2cb07cc0fc0ef5d5c142145f1c4f56c37c7.png" src="../_images/b1c9ddba3c61e9970731a95b9d3da2cb07cc0fc0ef5d5c142145f1c4f56c37c7.png" style="width: 1127px; height: 637px;" />
</a>
</div>
</div>
<p>As you can see, the marker groups are generally most highly expressed in the cells annotated with the matching label.
This means these labels are likely (at least partially) correct!</p>
<p>Let’s go back one more time to our UMAP colored by uncertainty:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sc</span><span class="o">.</span><span class="n">pl</span><span class="o">.</span><span class="n">umap</span><span class="p">(</span>
    <span class="n">adata</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;transf_cell_type_unc&quot;</span><span class="p">,</span> <span class="s2">&quot;transf_cell_type_certain&quot;</span><span class="p">],</span> <span class="n">frameon</span><span class="o">=</span><span class="kc">False</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<a class="reference internal image-reference" href="../_images/8e6cdb4eba678be90aae96d5ad704a6a55240acf9ff14e13eebefde865c82c97.png"><img alt="../_images/8e6cdb4eba678be90aae96d5ad704a6a55240acf9ff14e13eebefde865c82c97.png" src="../_images/8e6cdb4eba678be90aae96d5ad704a6a55240acf9ff14e13eebefde865c82c97.png" style="width: 1011px; height: 350px;" />
</a>
</div>
</div>
<p>The uncertainty not only helps us identify regions where the algorithm is unsure which cell type a cell belongs to (e.g., because it falls between two annotated phenotypes), but can also highlight unseen cell types or new cell states.
For example, your reference might consist of healthy cells while your query could be from a diseased sample.
The uncertainty score can then highlight disease-specific cell states, as they might not have neighbors from the reference that consistently come from a single cell type.
Especially when your reference is based on a large dataset, the uncertainty score is useful for flagging parts of the query data that could be worth investigating.
Reference-based label transfer not only helps you annotate your data but can also speed up its exploration and interpretation.
However, as with any metric, these uncertainty scores are often imperfect and, in some cases, fail to highlight new cell types or states.
For a more extensive discussion of uncertainty metrics, see e.g. <span id="id22">[<a class="reference internal" href="#id203" title="Jan Engelmann, Leon Hetzel, Giovanni Palla, Lisa Sikkema, Malte Luecken, and Fabian Theis. Uncertainty quantification for atlas-level cell type transfer. 2022. URL: https://arxiv.org/abs/2211.03793, doi:10.48550/ARXIV.2211.03793.">Engelmann <em>et al.</em>, 2022</a>]</span>.</p>
<p>Like with any of the methods discussed in this notebook, the quality of the transferred annotations depends on the quality of the “training data” (in this case the reference) and its annotations, the quality of the model, and the match of your own data with the training data!</p>
<p>The quality of the transferred annotations should therefore always be validated with manual inspection using marker gene expression and refinement of the initial annotations might be needed.</p>
<p>Finally, store your adata object if wanted:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># adata.write(&quot;./annotation_adata_out.h5ad&quot;)</span>

<span class="c1"># formatting the &#39;names&#39; column as string, to prevent problems with saving to h5ad format</span>
<span class="n">fields</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="s2">&quot;dea_leiden_1_filtered&quot;</span><span class="p">][</span><span class="s2">&quot;names&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">names</span>
<span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">:</span>
    <span class="n">adata</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="s2">&quot;dea_leiden_1_filtered&quot;</span><span class="p">][</span><span class="s2">&quot;names&quot;</span><span class="p">][</span><span class="n">field</span><span class="p">]</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span>
        <span class="s2">&quot;dea_leiden_1_filtered&quot;</span>
    <span class="p">][</span><span class="s2">&quot;names&quot;</span><span class="p">][</span><span class="n">field</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>

<span class="n">af</span> <span class="o">=</span> <span class="n">ln</span><span class="o">.</span><span class="n">Artifact</span><span class="o">.</span><span class="n">from_anndata</span><span class="p">(</span>
    <span class="n">adata</span><span class="p">,</span>
    <span class="n">key</span><span class="o">=</span><span class="s2">&quot;cellular_structure/s4d8_annotated.h5ad&quot;</span><span class="p">,</span>
    <span class="n">description</span><span class="o">=</span><span class="s2">&quot;anndata after annotation&quot;</span><span class="p">,</span>
<span class="p">)</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
<span class="n">af</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>→ writing the in-memory object into cache
... uploading 7d6LdOoS4ZSxqQPw0000.h5ad: 100.0%
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Artifact(uid=&#39;7d6LdOoS4ZSxqQPw0000&#39;, version_tag=None, is_latest=True, key=&#39;cellular_structure/s4d8_annotated.h5ad&#39;, description=&#39;anndata after annotation&#39;, suffix=&#39;.h5ad&#39;, kind=&#39;dataset&#39;, otype=&#39;AnnData&#39;, size=396009040, hash=&#39;c5YorNjJyslHycf0H2BxcT&#39;, n_files=None, n_observations=8874, branch_id=1, space_id=1, storage_id=1, run_id=12, schema_id=None, created_by_id=5, created_at=2026-02-16 18:44:30 UTC, is_locked=False)
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="references">
<h2><span class="section-number">11.6. </span>References<a class="headerlink" href="#references" title="Link to this heading">#</a></h2>
<div class="docutils container" id="id23">
<div role="list" class="citation-list">
<div class="citation" id="id188" role="doc-biblioentry">
<span class="label"><span class="fn-bracket">[</span>annoAMC+19<span class="fn-bracket">]</span></span>
<span class="backrefs">(<a role="doc-backlink" href="#id9">1</a>,<a role="doc-backlink" href="#id10">2</a>)</span>
<p>Tamim Abdelaal, Lieke Michielsen, Davy Cats, Dylan Hoogduin, Hailiang Mei, Marcel J. T. Reinders, and Ahmed Mahfouz. A comparison of automatic cell identification methods for single-cell rna sequencing data. <em>Genome Biology</em>, 20(1):194, Sep 2019. URL: <a class="reference external" href="https://doi.org/10.1186/s13059-019-1795-z">https://doi.org/10.1186/s13059-019-1795-z</a>, <a class="reference external" href="https://doi.org/10.1186/s13059-019-1795-z">doi:10.1186/s13059-019-1795-z</a>.</p>
</div>
<div class="citation" id="id185" role="doc-biblioentry">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id16">annoCXJ+22</a><span class="fn-bracket">]</span></span>
<p>C. Domínguez Conde, C. Xu, L. B. Jarvis, D. B. Rainbow, S. B. Wells, T. Gomes, S. K. Howlett, O. Suchanek, K. Polanski, H. W. King, L. Mamanova, N. Huang, P. A. Szabo, L. Richardson, L. Bolt, E. S. Fasouli, K. T. Mahbubani, M. Prete, L. Tuck, N. Richoz, Z. K. Tuong, L. Campos, H. S. Mousa, E. J. Needham, S. Pritchard, T. Li, R. Elmentaite, J. Park, E. Rahmani, D. Chen, D. K. Menon, O. A. Bayraktar, L. K. James, K. B. Meyer, N. Yosef, M. R. Clatworthy, P. A. Sims, D. L. Farber, K. Saeb-Parsy, J. L. Jones, and S. A. Teichmann. Cross-tissue immune cell analysis reveals tissue-specific features in humans. <em>Science</em>, 376(6594):eabl5197, 2022. URL: <a class="reference external" href="https://www.science.org/doi/abs/10.1126/science.abl5197">https://www.science.org/doi/abs/10.1126/science.abl5197</a>, <a class="reference external" href="https://arxiv.org/abs/https://www.science.org/doi/pdf/10.1126/science.abl5197">arXiv:https://www.science.org/doi/pdf/10.1126/science.abl5197</a>, <a class="reference external" href="https://doi.org/10.1126/science.abl5197">doi:10.1126/science.abl5197</a>.</p>
</div>
<div class="citation" id="id203" role="doc-biblioentry">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id22">annoEHP+22</a><span class="fn-bracket">]</span></span>
<p>Jan Engelmann, Leon Hetzel, Giovanni Palla, Lisa Sikkema, Malte Luecken, and Fabian Theis. Uncertainty quantification for atlas-level cell type transfer. 2022. URL: <a class="reference external" href="https://arxiv.org/abs/2211.03793">https://arxiv.org/abs/2211.03793</a>, <a class="reference external" href="https://doi.org/10.48550/ARXIV.2211.03793">doi:10.48550/ARXIV.2211.03793</a>.</p>
</div>
<div class="citation" id="id189" role="doc-biblioentry">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id17">annoFGS+20</a><span class="fn-bracket">]</span></span>
<p>Rui Fu, Austin E. Gillen, Ryan M. Sheridan, Chengzhe Tian, Michelle Daya, Yue Hao, Jay R. Hesselberth, and Kent A. Riemondy. Clustifyr: an r package for automated single-cell RNA sequencing cluster classification. <em>F1000Research</em>, 9:223, July 2020. URL: <a class="reference external" href="https://doi.org/10.12688/f1000research.22969.2">https://doi.org/10.12688/f1000research.22969.2</a>, <a class="reference external" href="https://doi.org/10.12688/f1000research.22969.2">doi:10.12688/f1000research.22969.2</a>.</p>
</div>
<div class="citation" id="id199" role="doc-biblioentry">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id20">annoHHAN+21</a><span class="fn-bracket">]</span></span>
<p>Yuhan Hao, Stephanie Hao, Erica Andersen-Nissen, William M. Mauck, Shiwei Zheng, Andrew Butler, Maddie J. Lee, Aaron J. Wilk, Charlotte Darby, Michael Zager, Paul Hoffman, Marlon Stoeckius, Efthymia Papalexi, Eleni P. Mimitou, Jaison Jain, Avi Srivastava, Tim Stuart, Lamar M. Fleming, Bertrand Yeung, Angela J. Rogers, Juliana M. McElrath, Catherine A. Blish, Raphael Gottardo, Peter Smibert, and Rahul Satija. Integrated analysis of multimodal single-cell data. <em>Cell</em>, 184(13):3573–3587.e29, 2021. URL: <a class="reference external" href="https://www.sciencedirect.com/science/article/pii/S0092867421005833">https://www.sciencedirect.com/science/article/pii/S0092867421005833</a>, <a class="reference external" href="https://doi.org/https://doi.org/10.1016/j.cell.2021.04.048">doi:https://doi.org/10.1016/j.cell.2021.04.048</a>.</p>
</div>
<div class="citation" id="id190" role="doc-biblioentry">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id12">annoHZ21</a><span class="fn-bracket">]</span></span>
<p>Yixuan Huang and Peng Zhang. Evaluation of machine learning approaches for cell-type identification from single-cell transcriptomics data. <em>Briefings in Bioinformatics</em>, February 2021. URL: <a class="reference external" href="https://doi.org/10.1093/bib/bbab035">https://doi.org/10.1093/bib/bbab035</a>, <a class="reference external" href="https://doi.org/10.1093/bib/bbab035">doi:10.1093/bib/bbab035</a>.</p>
</div>
<div class="citation" id="id204" role="doc-biblioentry">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id7">annoIBrasoMaristanyM+21</a><span class="fn-bracket">]</span></span>
<p>Ignacio Isola, Fara Brasó-Maristany, David F. Moreno, Mari-Pau Mena, Aina Oliver-Calders, Laia Paré, Luis Gerardo Rodríguez-Lobato, Beatriz Martin-Antonio, María Teresa Cibeira, Joan Bladé, Laura Rosiñol, Aleix Prat, Ester Lozano, and Carlos Fernández De Larrea. Gene Expression Analysis of the Bone Marrow Microenvironment Reveals Distinct Immunotypes in Smoldering Multiple Myeloma Associated to Progression to Symptomatic Disease. <em>Frontiers in Immunology</em>, 12:792609, November 2021. <a class="reference external" href="https://doi.org/10.3389/fimmu.2021.792609">doi:10.3389/fimmu.2021.792609</a>.</p>
</div>
<div class="citation" id="id183" role="doc-biblioentry">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id1">annoKLMST+22</a><span class="fn-bracket">]</span></span>
<p>Preetish Kadur Lakshminarasimha Murthy, Vishwaraj Sontake, Aleksandra Tata, Yoshihiko Kobayashi, Lauren Macadlo, Kenichi Okuda, Ansley S. Conchola, Satoko Nakano, Simon Gregory, Lisa A. Miller, Jason R. Spence, John F. Engelhardt, Richard C. Boucher, Jason R. Rock, Scott H. Randell, and Purushothama Rao Tata. Human distal lung maps and lineage hierarchies reveal a bipotent progenitor. <em>Nature</em>, 604(7904):111–119, Apr 2022. URL: <a class="reference external" href="https://doi.org/10.1038/s41586-022-04541-3">https://doi.org/10.1038/s41586-022-04541-3</a>, <a class="reference external" href="https://doi.org/10.1038/s41586-022-04541-3">doi:10.1038/s41586-022-04541-3</a>.</p>
</div>
<div class="citation" id="id198" role="doc-biblioentry">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id19">annoKNW+21</a><span class="fn-bracket">]</span></span>
<p>Joyce B. Kang, Aparna Nathan, Kathryn Weinand, Fan Zhang, Nghia Millard, Laurie Rumker, D. Branch Moody, Ilya Korsunsky, and Soumya Raychaudhuri. Efficient and precise single-cell reference atlas mapping with symphony. <em>Nature Communications</em>, 12(1):5890, Oct 2021. URL: <a class="reference external" href="https://doi.org/10.1038/s41467-021-25957-x">https://doi.org/10.1038/s41467-021-25957-x</a>, <a class="reference external" href="https://doi.org/10.1038/s41467-021-25957-x">doi:10.1038/s41467-021-25957-x</a>.</p>
</div>
<div class="citation" id="id202" role="doc-biblioentry">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id21">annoLRC+18</a><span class="fn-bracket">]</span></span>
<p>Romain Lopez, Jeffrey Regier, Michael B Cole, Michael I Jordan, and Nir Yosef. Deep generative modeling for single-cell transcriptomics. <em>Nat. Methods</em>, 15(12):1053–1058, December 2018.</p>
</div>
<div class="citation" id="id197" role="doc-biblioentry">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id18">annoLNL+22</a><span class="fn-bracket">]</span></span>
<p>Mohammad Lotfollahi, Mohsen Naghipourfar, Malte D. Luecken, Matin Khajavi, Maren Büttner, Marco Wagenstetter, Žiga Avsec, Adam Gayoso, Nir Yosef, Marta Interlandi, Sergei Rybakov, Alexander V. Misharin, and Fabian J. Theis. Mapping single-cell data to reference atlases by transfer learning. <em>Nature Biotechnology</em>, 40(1):121–130, Jan 2022. URL: <a class="reference external" href="https://doi.org/10.1038/s41587-021-01001-7">https://doi.org/10.1038/s41587-021-01001-7</a>, <a class="reference external" href="https://doi.org/10.1038/s41587-021-01001-7">doi:10.1038/s41587-021-01001-7</a>.</p>
</div>
<div class="citation" id="id187" role="doc-biblioentry">
<span class="label"><span class="fn-bracket">[</span>annoPRojoAriasSB21<span class="fn-bracket">]</span></span>
<span class="backrefs">(<a role="doc-backlink" href="#id8">1</a>,<a role="doc-backlink" href="#id11">2</a>)</span>
<p>Giovanni Pasquini, Jesus Eduardo Rojo Arias, Patrick Schäfer, and Volker Busskamp. Automated methods for cell type annotation on scrna-seq data. <em>Computational and Structural Biotechnology Journal</em>, 19:961–969, 2021. URL: <a class="reference external" href="https://www.sciencedirect.com/science/article/pii/S2001037021000192">https://www.sciencedirect.com/science/article/pii/S2001037021000192</a>, <a class="reference external" href="https://doi.org/https://doi.org/10.1016/j.csbj.2021.01.015">doi:https://doi.org/10.1016/j.csbj.2021.01.015</a>.</p>
</div>
<div class="citation" id="id200" role="doc-biblioentry">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id14">annoPST19</a><span class="fn-bracket">]</span></span>
<p>Hannah A. Pliner, Jay Shendure, and Cole Trapnell. Supervised classification enables rapid annotation of cell atlases. <em>Nature Methods</em>, 16(10):983–986, Oct 2019. URL: <a class="reference external" href="https://doi.org/10.1038/s41592-019-0535-3">https://doi.org/10.1038/s41592-019-0535-3</a>, <a class="reference external" href="https://doi.org/10.1038/s41592-019-0535-3">doi:10.1038/s41592-019-0535-3</a>.</p>
</div>
<div class="citation" id="id186" role="doc-biblioentry">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id5">annoPM22</a><span class="fn-bracket">]</span></span>
<p>Jeffrey M. Pullin and Davis J. McCarthy. A comparison of marker gene selection methods for single-cell rna sequencing data. <em>bioRxiv</em>, 2022. URL: <a class="reference external" href="https://www.biorxiv.org/content/early/2022/05/10/2022.05.09.490241">https://www.biorxiv.org/content/early/2022/05/10/2022.05.09.490241</a>, <a class="reference external" href="https://arxiv.org/abs/https://www.biorxiv.org/content/early/2022/05/10/2022.05.09.490241.full.pdf">arXiv:https://www.biorxiv.org/content/early/2022/05/10/2022.05.09.490241.full.pdf</a>, <a class="reference external" href="https://doi.org/10.1101/2022.05.09.490241">doi:10.1101/2022.05.09.490241</a>.</p>
</div>
<div class="citation" id="id192" role="doc-biblioentry">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id13">annoSRamirezSuasteguiS+23</a><span class="fn-bracket">]</span></span>
<p>Lisa Sikkema, Ciro Ram\'ırez-Suástegui, Daniel C. Strobl, Tessa E. Gillett, Luke Zappia, Elo Madissoon, Nikolay S. Markov, Laure-Emmanuelle Zaragosi, Yuge Ji, Meshal Ansari, Marie-Jeanne Arguel, Leonie Apperloo, Martin Banchero, Christophe Bécavin, Marijn Berg, Evgeny Chichelnitskiy, Mei-i Chung, Antoine Collin, Aurore C. A. Gay, Janine Gote-Schniering, Baharak Hooshiar Kashani, Kemal Inecik, Manu Jain, Theodore S. Kapellos, Tessa M. Kole, Sylvie Leroy, Christoph H. Mayr, Amanda J. Oliver, Michael von Papen, Lance Peter, Chase J. Taylor, Thomas Walzthoeni, Chuan Xu, Linh T. Bui, Carlo De Donno, Leander Dony, Alen Faiz, Minzhe Guo, Austin J. Gutierrez, Lukas Heumos, Ni Huang, Ignacio L. Ibarra, Nathan D. Jackson, Preetish Kadur Lakshminarasimha Murthy, Mohammad Lotfollahi, Tracy Tabib, Carlos Talavera-López, Kyle J. Travaglini, Anna Wilbrey-Clark, Kaylee B. Worlock, Masahiro Yoshida, Yuexin Chen, James S. Hagood, Ahmed Agami, Peter Horvath, Joakim Lundeberg, Charles-Hugo Marquette, Gloria Pryhuber, Chistos Samakovlis, Xin Sun, Lorraine B. Ware, Kun Zhang, Maarten van den Berge, Yohan Bossé, Tushar J. Desai, Oliver Eickelberg, Naftali Kaminski, Mark A. Krasnow, Robert Lafyatis, Marko Z. Nikolic, Joseph E. Powell, Jayaraj Rajagopal, Mauricio Rojas, Orit Rozenblatt-Rosen, Max A. Seibold, Dean Sheppard, Douglas P. Shepherd, Don D. Sin, Wim Timens, Alexander M. Tsankov, Jeffrey Whitsett, Yan Xu, Nicholas E. Banovich, Pascal Barbry, Thu Elizabeth Duong, Christine S. Falk, Kerstin B. Meyer, Jonathan A. Kropski, Dana Pe'er, Herbert B. Schiller, Purushothama Rao Tata, Joachim L. Schultze, Sara A. Teichmann, Alexander V. Misharin, Martijn C. Nawijn, Malte D. Luecken, and Fabian J. Theis and. An integrated cell atlas of the lung in health and disease. <em>Nature Medicine</em>, June 2023. URL: <a class="reference external" href="https://doi.org/10.1038/s41591-023-02327-2">https://doi.org/10.1038/s41591-023-02327-2</a>, <a class="reference external" href="https://doi.org/10.1038/s41591-023-02327-2">doi:10.1038/s41591-023-02327-2</a>.</p>
</div>
<div class="citation" id="id194" role="doc-biblioentry">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id4">annoTWvE19</a><span class="fn-bracket">]</span></span>
<p>V. A. Traag, L. Waltman, and N. J. van Eck. From louvain to leiden: guaranteeing well-connected communities. <em>Scientific Reports</em>, 9(1):5233, Mar 2019. URL: <a class="reference external" href="https://doi.org/10.1038/s41598-019-41695-z">https://doi.org/10.1038/s41598-019-41695-z</a>, <a class="reference external" href="https://doi.org/10.1038/s41598-019-41695-z">doi:10.1038/s41598-019-41695-z</a>.</p>
</div>
<div class="citation" id="id184" role="doc-biblioentry">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id2">annoWRY16</a><span class="fn-bracket">]</span></span>
<p>Allon Wagner, Aviv Regev, and Nir Yosef. Revealing the vectors of cellular identity with single-cell genomics. <em>Nature Biotechnology</em>, 34(11):1145–1160, Nov 2016. URL: <a class="reference external" href="https://doi.org/10.1038/nbt.3711">https://doi.org/10.1038/nbt.3711</a>, <a class="reference external" href="https://doi.org/10.1038/nbt.3711">doi:10.1038/nbt.3711</a>.</p>
</div>
<div class="citation" id="id193" role="doc-biblioentry">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id3">annoZen22</a><span class="fn-bracket">]</span></span>
<p>Hongkui Zeng. What is a cell type and how to define it? <em>Cell</em>, 185(15):2739–2755, 2022. URL: <a class="reference external" href="https://www.sciencedirect.com/science/article/pii/S0092867422007838">https://www.sciencedirect.com/science/article/pii/S0092867422007838</a>, <a class="reference external" href="https://doi.org/https://doi.org/10.1016/j.cell.2022.06.031">doi:https://doi.org/10.1016/j.cell.2022.06.031</a>.</p>
</div>
<div class="citation" id="id201" role="doc-biblioentry">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id15">annoZOFlanaganC+19</a><span class="fn-bracket">]</span></span>
<p>Allen W. Zhang, Ciara O'Flanagan, Elizabeth A. Chavez, Jamie L. P. Lim, Nicholas Ceglia, Andrew McPherson, Matt Wiens, Pascale Walters, Tim Chan, Brittany Hewitson, Daniel Lai, Anja Mottok, Clementine Sarkozy, Lauren Chong, Tomohiro Aoki, Xuehai Wang, Andrew P. Weng, Jessica N. McAlpine, Samuel Aparicio, Christian Steidl, Kieran R. Campbell, and Sohrab P. Shah. Probabilistic cell-type assignment of single-cell rna-seq for tumor microenvironment profiling. <em>Nature Methods</em>, 16(10):1007–1015, Oct 2019. URL: <a class="reference external" href="https://doi.org/10.1038/s41592-019-0529-1">https://doi.org/10.1038/s41592-019-0529-1</a>, <a class="reference external" href="https://doi.org/10.1038/s41592-019-0529-1">doi:10.1038/s41592-019-0529-1</a>.</p>
</div>
<div class="citation" id="id191" role="doc-biblioentry">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id6">annoZKT19</a><span class="fn-bracket">]</span></span>
<p>Jesse M. Zhang, Govinda M. Kamath, and David N. Tse. Valid post-clustering differential analysis for single-cell rna-seq. <em>Cell Systems</em>, 9(4):383–392.e6, 2019. URL: <a class="reference external" href="https://www.sciencedirect.com/science/article/pii/S2405471219302698">https://www.sciencedirect.com/science/article/pii/S2405471219302698</a>, <a class="reference external" href="https://doi.org/https://doi.org/10.1016/j.cels.2019.07.012">doi:https://doi.org/10.1016/j.cels.2019.07.012</a>.</p>
</div>
</div>
</div>
</section>
<section id="contributors">
<h2><span class="section-number">11.7. </span>Contributors<a class="headerlink" href="#contributors" title="Link to this heading">#</a></h2>
<p>We gratefully acknowledge the contributions of:</p>
<section id="authors">
<h3><span class="section-number">11.7.1. </span>Authors<a class="headerlink" href="#authors" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p>Lisa Sikkema</p></li>
<li><p>Maren Büttner</p></li>
<li><p>Seo H. Kim</p></li>
</ul>
</section>
<section id="reviewers">
<h3><span class="section-number">11.7.2. </span>Reviewers<a class="headerlink" href="#reviewers" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p>Lukas Heumos</p></li>
</ul>
</section>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./cellular_structure"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="clustering.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title"><span class="section-number">10. </span>Clustering</p>
      </div>
    </a>
    <a class="right-next"
       href="integration.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title"><span class="section-number">12. </span>Data integration</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#motivation">11.1. Motivation</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#environment-setup">11.2. Environment setup</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#load-data">11.3. Load data</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#manual-annotation">11.4. Manual annotation</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#from-markers-to-cluster-annotation">11.4.1. From markers to cluster annotation</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#from-cluster-differentially-expressed-genes-to-cluster-annotation">11.4.2. From cluster differentially expressed genes to cluster annotation</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#automated-annotation">11.5. Automated annotation</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#general-remarks">11.5.1. General remarks</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#marker-gene-based-classifiers">11.5.2. Marker gene-based classifiers</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#classifiers-based-on-a-wider-set-of-genes">11.5.3. Classifiers based on a wider set of genes</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#annotation-by-mapping-to-a-reference">11.5.4. Annotation by mapping to a reference</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#references">11.6. References</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#contributors">11.7. Contributors</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#authors">11.7.1. Authors</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#reviewers">11.7.2. Reviewers</a></li>
</ul>
</li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Lukas Heumos, Anna Schaar, single-cell best practices consortium
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2023.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
<div class="extra_footer">
  <div>
  Brought to you by
  <a href="https://www.github.com/theislab">Theislab</a>, with many thanks to the single-cell community as a whole!
</div>

</div>
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>